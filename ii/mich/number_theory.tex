\documentclass{article}

\def\npart {II}
\def\nyear {2017}
\def\nterm {Michaelmas}
\def\nlecturer{Prof. A. Scholl}
\def\ncourse{Number Theory}
\input{header}
% preamble
\usepackage{xfrac}
\usepackage{multirow}
\usepackage{pifont}
\newcommand{\cmark}{\ding{51}}
\newcommand{\xmark}{\ding{55}}
\setcounter{section}{-1}
\newcommand{\legendre}[2]{\genfrac{(}{)}{}{}{#1}{#2}}
\newcommand{\SL}{\mathrm{SL}}
\DeclareMathOperator{\disc}{disc}
\DeclarePairedDelimiter\ceil{\lceil}{\rceil}
\DeclarePairedDelimiter\floor{\lfloor}{\rfloor}
\newtheorem*{note}{Note}
\newtheorem{manualinner}{}
\newenvironment{manual}[1]{%
    \renewcommand\themanualinner{#1}%
    \manualinner
}{\endmanualinner}

\usetikzlibrary{cd}
% and here we go!

\begin{document}
\maketitle
\tableofcontents

\clearpage

\section{Introduction}
Number theory is concerned with the (non-obvious, sometimes mysterious) properties of the integers, $\Z = \{0, \pm 1, \pm 2, \dots\}$ and the rationals, $\Q = \{\frac{m}{n} \mid m, n \in \Z, n \ne 0\}$.
It has been around for thousands of years, and has always been an experimental science where one can conduct experiments with numbers to spot their properties. Experimental data leads to conjectures which can turn out to be very hard to prove, for instance:
\begin{enumerate}
    \item Congruent number problem: Let $N \geq 1$ be an integer of the form $8n + 5$, $8n+6$ or $8n + 7$.
        Does there exist a right-angled triangle with sides of rational length, and area equal to $N$?
    \item Twin prime conjecture: Does there exist infinitely many primes $p$ such that $p+2$ is also prime?
        Very recently, we know there are infinitely many primes $p$ such that $\{p+2, p+4, \dots, p+246\}$ contains a prime.
    \item $\pi(x)$ refers to the prime counting function, the number of prime numbers $p \leq x$.
        The prime number theorem says that $\pi(x) \sim \mathrm{li}(x) \coloneqq \int_2^x \frac{dt}{\log t}$.
        It is not known whether or not $\abs{\pi(x) - \mathrm{li}(x)} \leq \sqrt{x} \log(x)$, which is equivalent to the Riemann hypothesis - a statement about a certain complex analytic function.
\end{enumerate}
Problem 1 follows from the Birch-Swinnerton-Dyer conjecture, related to algebraic geometry.
Often these proofs can require sophisticated theorems, well beyond the statement of the problem.
\clearpage

\section{Euclid's algorithm and factoring}
\begin{defi}[Division algorithm]\hypertarget{def:divisionAlg}
    Given $a, b \in \Z$, with $b > 0$, there are $q, r \in \Z$ with $0 \leq r < b$ and $a = b q + r$, that is, we can divide $a$ by $b$ to give a quotient $q$ and remainder $r$.
\end{defi}

\begin{proof}
    Let $S = \set{a - n b \mid n \in \Z}$, which certainly contains some non-negative integers.
    Let $r$ be the least of them, which exists by the well ordering property of the non-negative integers.

    Claim $r < b$, since if not then $r - b \in S$ and $r - b \geq 0$, contradicting the choice of $r$.
\end{proof}

\begin{notation}
    \hypertarget{def:div}If $r = 0$ (that is, $a = bq$ for some $q \in \Z$), write $b \mid a$ (read as `$b$ divides $a$'), otherwise write $b \nmid a$.
\end{notation}

Given $a_1, \dots, a_n \in \Z$ not all zero, let
\begin{equation*}
    I = \{\lambda_1 a_1 + \dots + \lambda_n a_n \mid \lambda_i \in \Z\}
\end{equation*}
We recognise this from GRM as the ideal generated by $\{a_1, \dots, a_n\}$.
Note if $a, b \in I$, for any choice of $l, m \in \Z$ then $l a + m b \in I$.

\begin{nlemma}\label{lem:1.1}
    $I = d \Z = \{\lambda d \mid \lambda \in \Z\}$ for some $d \leq 1$, clearly unique.
\end{nlemma}

\begin{proof}
    As not all of $a_i$ are $0$, $I$ contains some positive integer, let $d$ be the least of them.  So, $d \in I$, and hence $d \Z \subset I$.

    On the other hand, for $a \in I$ the \hyperlink{def:divisionAlg}{division algorithm} gives us $a = qd + r$ with $0 \leq r < d$.
    But then $r = a - dq \in I$ so by minimality of $d$ we have $r = 0$, and so $a \in d \Z$, giving $I \subset d \Z$ as required.
\end{proof}

\begin{defi}[Greatest common divisor]\hypertarget{def:gcd}
    $a_i \in I = d \Z$ so $d \hyperlink{def:div}{\mid} a_i$.
    If in addition, we have that $\forall i, \, e \mid a_i$, then $e$ divides every element of $I$, so $e \mid d$.
    Write $d = \gcd(a_1, \dots, a_n) = (a_1, \dots, a_n)$, the \textbf{greatest common divisor} (alternatively the highest common factor).
\end{defi}

The study of \textbf{Diophantine equations} involves solving equations with integer solutions, and may have more variables than equations.
The simplest case is linear in two variables, and can be solved easily.
\begin{cor}
    Let $a, b, c \in \Z$ with not both $a, b$ equal to $0$.
    Then we can find $x, y \in \Z$ such that $a x + by = c \Leftrightarrow \hyperlink{def:gcd}{(a, b)} \hyperlink{def:div}{\mid} c$.
\end{cor}
The definition of the \hyperlink{def:gcd}{greatest common divisor} given here is non-constructive, but Euclid's algorithm is an efficient way to compute it.

\hypertarget{def:euclids}{\textbf{Euclid's algorithm}}:
Assume $a > b > 0$. Apply successively the \hyperlink{def:divisionAlg}{division algorithm}:
\begin{align*}
    a &= q_1 b + r_1 & 0 \leq r_1 < b\\
    b &= q_2 r_1 + r_2 & 0 \leq r_2 < b\\
    r_1 &= q_3 r_2 + r_3 & 0 \leq r_3 < b\\
    \vdots \\
    r_{k-2} &= q_k r_{k-1} + r_k & 0 \leq r_k < b\\
    r_{k-1} &= q_{k+1} r_k + 0
\end{align*}
for some $k$, so $r_k \hyperlink{def:div}{\mid} r_{k-1}$

Claim $r_k = \hyperlink{def:gcd}{(a, b)}$.
Indeed,
\begin{align*}
    (a, b) &= (a - q_1 b, b) = (b, r_1) \\
           &= (r_1, r_2) = \dotsb = (r_{k-1}, r_k) = r_k.
\end{align*}
\begin{remark}
     By \cref{lem:1.1}, $\hyperlink{def:gcd}{(a, b)} = r a + s b$ for some integers $r, s$.
     \hyperlink{def:euclids}{Euclid's algorithm} gives such $r, s$.
\end{remark}
\begin{eg}
    \begin{equation*}
        \begin{array}{r|cc}
            & x & y \\
            a=34 & 1 & 0 \\
            b=25 & 0 & 1 \\
            34 = 1 \cdot 25 + \color{red}{9}& 1 & -1 \\
            25 = 2 \cdot 9 + \color{red}{7}& -2 & 3 \\
            9 = 1 \cdot 7 + \color{red}{2}& 3 & -4 \\
            7 = 3 \cdot 2 + \color{red}{1}& -11 & 15 \\
        \end{array}
    \end{equation*}
    so $\hyperlink{def:gcd}{\gcd(a,b)} = -11a + 15b$, and the $r_i$ are highlighted in \color{red}{red}.
\end{eg}

\hypertarget{def:prime}Recall that if $n > 1$ then $n$ is \textbf{prime} if its only positive divisors are $\{1, n\}$, otherwise $n$ is \textbf{composite}.
\begin{nlemma}\label{lem:1.2}
    Let $p$ be \hyperlink{def:prime}{prime}, $a, b \in \Z$.
    Then $p \hyperlink{def:div}{\mid} ab \implies p \mid a$ or $p \mid b$.
\end{nlemma}

\begin{proof}
    Suppose $p \hyperlink{def:div}{\mid} ab$, $p \nmid a$.
    Then $\hyperlink{def:gcd}{\gcd(a, b)} \ne p$, so it must be $1$.
    So $\exists r, s \in \Z$ such that $ar + ps = 1$.
    Therefore, $b = (ab) r + p(bs)$, and hence $p \mid b$.
\end{proof}

This lets us prove the fundamental theorem of arithmetic.
\begin{thm}[Fundamental theorem of arithmetic]\hypertarget{thm:fta}
    Every integer $n > 1$ can be written as a product of \hyperlink{def:prime}{primes}, and this representation is unique up to ordering.
\end{thm}
\begin{proof}
    Existence is trivial.
    Uniqueness: suppose $n = p_1 \dots p_r = q_1 \dots q_s$.
    $p_1 \hyperlink{def:div}{\mid} n$, so $p_1$ divides some $q_j$.
    Hence $p_1 = q_j$ and so we can cancel $p_1$ and $q_j$ from the relation, and repeat the process for $\frac{n}{p_1}$, eventually giving that the $\{p_1, \dots, p_r\}$ are the same as the $\{q_1, \dots, q_s\}$, up to ordering.
\end{proof}

% Lecture 2

If we know $a = \prod_{i=1}^k p_i^{\alpha_i}$, $b = \prod_{i=1}^k p_i^{\beta_i}$ for $\alpha_i, \beta_i \geq 0$ and $p_i$ are distinct \hyperlink{def:prime}{primes}, then by \hyperlink{thm:fta}{uniqueness of prime factorisation},
\begin{equation*}
    (a, b) = \prod_{i=1}^k p_i^{\gamma_i} \, , \quad \gamma_i = \min(\alpha_i, \beta_i)
\end{equation*}
However if $a, b$ are large, this is an inefficient way to compute GCDs.
\begin{defi}[Polynomial time]\hypertarget{def:poly}
    An algorithm with input an integer $N> 0$ is \textbf{polynomial time} if $\exists b, c > 0$ for which the algorithm completes after less than $c (\log N)^b$ `elementary operations'.
    Examples of elementary operations include adding or multiplying digits in some fixed base.

    If there are $k$ integer inputs, we require less than $c (\max_k(\log N_i))^b$ operations.
\end{defi}

\begin{eg}\leavevmode
    \begin{itemize}
        \item Adding, multiplying integers (usual method)
        \item Computing GCDs by Euclid's algorithm
        \item Testing if $N$ is prime (recent discovery, 2002)
    \end{itemize}
\end{eg}

\subsubsection*{Factoring}
What about factoring $N$? The obvious method is trial division by integers $\leq \sqrt{N}$.
If $N = pq$, then $p, q \sim \sqrt{N}$ this will take $\sqrt{N}$ divisions - asymptotically larger than any power of $\log N$.
For instance, if $N$ has $100$ digits, and we can do $2^9$ divisions every second, this will take around $10^{50} / 2^9$ seconds, which is about $6 \times 10^{39}$ years.
However, Euclid's algorithm will compute the GCD of two such numbers in a few milliseconds.

However, there are better algorithms for factoring which we will see later, but so far no \hyperlink{def:poly}{polynomial-time} algorithm is known (important for security of encryption algorithms like RSA).
These are practical for numbers with fewer than 200 digits (for a large computer - the record is 232 digits using thousands of computers and several months)

We will study the distribution of \hyperlink{def:prime}{primes} and the counting function later.  For now,
\begin{thm}[Euclid]\hypertarget{thm:infPrimes}
    There are infinitely many \hyperlink{def:prime}{primes}.
\end{thm}
\begin{proof}
    It is enough to show that given $N$, there is a \hyperlink{def:prime}{prime} $p > N$. Let $q$ be the largest prime $\leq N$, and set $M = (2 \times 3 \times 5 \times \dots \times q) + 1$.
    If $p$ is any prime factor of $M$, then $p \notin \{2, 3, \dotsc, q\}$ so $p > N$.
\end{proof}

\begin{remark}
    This is constructive, in that it gives a way to find a \hyperlink{def:prime}{prime} greater than any $N$, but is is not efficient. For instance, if $N=1000$, $M$ has over $400$ digits.
\end{remark}

\textbf{Finding large primes}: For reasonable size numbers (fewer than 1000 digits), it is reasonable to pick numbers at random and test for \hyperlink{def:prime}{primality}.
For very large primes, there are special (faster) tests for primality of numbers of the form $N = 2^q - 1$, called Mersenne numbers.
Using these, it has been shown that that $2^q - 1$ is prime when $q = 74207281$.

\clearpage

\section{Congruences}
Fix $n \geq 1$ (the modulus).  Typically we will use $n > 1$.
\begin{defi}[Congruent]\hypertarget{def:mod}
    $ a \equiv b \pmod{n}$ iff $n \hyperlink{def:div}{\mid} a-b$, and we say `$a$ is \textbf{congruent to $b$ mod} $n$'
\end{defi}

This defines an equivalence relation on $\mathbb{Z}$.
\hypertarget{def:znz}Write $\mathbb{Z} / n\mathbb{Z}$ for the set of equivalence classes $\{a + n \mathbb{Z}\}$, where $a + n \mathbb{Z} = b + n \mathbb{Z} \iff a \equiv b \pmod{n}$.
It is easy to see that the operations of addition and multiplication in $\{a + n \mathbb{Z}\}$ are well defined.
(In other words, $n \mathbb{Z}$ is an ideal in the ring $\mathbb{Z}$, and $\mathbb{Z} / n\mathbb{Z}$ is the quotient ring.)

\begin{nlemma}\label{lem:2.1}
    Let $a \in \Z$. The following are equivalent:
    \begin{enumerate}[label=\roman*.]
        \item $\hyperlink{def:gcd}{(a, n)} = 1$
        \item $\exists b \in \Z$ with $ab \equiv 1 \hyperlink{def:mod}{\pmod{n}}$
        \item (The equivalence class of) $a$ is a generator of the group $(\hyperlink{def:znz}{\Z/n\Z}, +)$.
    \end{enumerate}
\end{nlemma}

\begin{proof}
    \leavevmode
    \begin{itemize}[label={}]
        \item i. $\Rightarrow$ ii. If $\hyperlink{def:gcd}{(a, n)} = 1$, $\exists b, c \in \mathbb{Z}$ with $ab+nc=1$ so $ab \equiv 1 \hyperlink{def:mod}{\pmod{n}}$
        \item ii. $\Rightarrow$ i. $ab \equiv 1 \pmod{n} \iff ab+kn=1$, for some $k \in \Z \implies (a, n)= 1$
        \item ii.\ $\Leftrightarrow$ iii. $ab \equiv 1 \pmod{n}$ for some $b \iff 1$ belongs to the subgroup of $\hyperlink{def:znz}{\Z / n \Z}$ generated by $a \iff$ the subgroup generated by $a$ is $\Z / n \Z$
    \end{itemize}
\end{proof}

\begin{notation}\hypertarget{def:znz*}
    For $n > 1$, we write $(\Z / n \Z)^\times$ to denote the set of units (invertible elements) of $\hyperlink{def:znz}{\Z / n \Z}$.
\end{notation}
By \cref{lem:2.1}, this is the set of classes $a + n \Z$ where $\hyperlink{def:gcd}{(a, n)} = 1$.
\begin{defi}[Euler $\varphi$-function]\hypertarget{def:phi}
    We can then define the \textbf{Euler $\varphi$-function}:
    \begin{equation*}\varphi(n) \coloneqq \# \hyperlink{def:znz*}{(\Z / n \Z)^\times} = \# \set{a \in \Z | 1 \leq a \leq n, \, \hyperlink{def:gcd}{(a, n)} = 1}.\end{equation*}
\end{defi}

\begin{remark}
    For $n>1$,
    \begin{align*}
        \hyperlink{def:znz}{\mathbb{Z}/n\mathbb{Z}}\text{ is a field} & \iff \text{every non-zero element has an inverse under } \times \\
                                                                      &\iff n\text{ is \hyperlink{def:prime}{prime}} \\
                                                                      &\iff \hyperlink{def:phi}{\varphi(n)} = n-1
    \end{align*}
\end{remark}

\begin{thm}[Euler-Fermat Theorem]\hypertarget{thm:eulerFermat}
    If $\hyperlink{def:gcd}{(a, n)} = 1$, then $a^{\hyperlink{def:phi}{\varphi(n)}} \equiv 1 \hyperlink{def:mod}{\pmod{n}}$
\end{thm}

\begin{proof}
    $(n>1)$ Apply Lagrange's theorem to the group $G = \hyperlink{def:znz*}{(\Z/n\Z)^\times}$ which has order $\hyperlink{def:phi}{\varphi(n)}$.
    Then $a \in \Z$ with $\hyperlink{def:gcd}{(a, n)} = 1$ defines an element of $G$ whose order divides $\varphi(n)$. So $a^{\varphi(n)} \equiv 1 \pmod{n}$.
\end{proof}

This has an important special case, called Fermat's Little Theorem.
\begin{thm}[Fermat's Little Theorem]\hypertarget{thm:fermatLittle}
    If $p$ is \hyperlink{def:prime}{prime} and $a \in \Z$, then $a^p \equiv a \hyperlink{def:mod}{\pmod{p}}$.
\end{thm}

\begin{proof}
    Trivial if $p \hyperlink{def:div}{\mid} a$.  If not, $\hyperlink{def:gcd}{(a, p)} = 1$ so $a^{\hyperlink{def:phi}{\varphi(p)}} \equiv 1 \hyperlink{def:mod}{\pmod{p}} \implies a^p \equiv a \pmod{p}$
\end{proof}

% Lecture 3

\begin{nlemma}\label{lem:2.2}
    Let $G$ be a cyclic group of order $n \geq 1$. Then
    \begin{align*}
        \hyperlink{def:phi}{\varphi (n)} &=  \# \set{g \in G | \text{order of } g \text{ is } n} \\
                    &=  \# \text{ of generators of } G
    \end{align*}
\end{nlemma}

\begin{proof}
    We may assume $G = \hyperlink{def:znz}{\Z/ n \Z}$, in which case this is just \cref{lem:2.1}
\end{proof}

\subsection{Simultaneous Congruences}

\begin{eg}
    We would like to find all $x \in \Z$ such that $x \equiv 7 \hyperlink{def:mod}{\pmod{10}}$ and $x \equiv 3 \pmod{13}$.
    One way might be to try $7, 17, 27, \dotsc$ in turn.

    A better way: suppose we have $u, v \in \Z$ such that
    \begin{align*}
        u &\equiv 1 \pmod{10} & v &\equiv 0 \pmod{10} \\
        u &\equiv 0 \pmod{13} & v &\equiv 1 \pmod{13}
    \end{align*}

    Then $x = 7u + 3v$ is a solution.

    To find $u, v$: $\hyperlink{def:gcd}{(10, 13)} = 1$ so $\exists r, s$ with $10r + 13s = 1$, then setting $u=13s$ and $v=10r$ ensures the above congruences are satisfied.
    From the Euclidean algorithm, we see $r=4$ and $s=-3$ work, so $u=-39$ and $v=40$.

    We can confirm $x = 7(-39) + 3(40) \equiv 107 \hyperlink{def:mod}{\pmod{130}}$ is a solution.
    In fact, the set of all solutions is $ \set{ x | x \equiv 107 \pmod {130}} $.
\end{eg}

This is a special case of

\begin{thm}[Chinese Remainder Theorem]\hypertarget{thm:crt}
    Let $m_1, \dotsc, m_k$ be integers $\geq 1$ for which $\hyperlink{def:gcd}{(m_i, m_j)} = 1$ if $i \neq j$ (they are pairwise coprime).
    Write $M = m_1 \dotsm m_k$ for $k \geq 2$. Let $a_1, \dotsc, a_k \in \Z$. Then there exists a solution $x \in \Z$ of
    \begin{equation*}\label{eq:crt}
        \begin{rcases}
            x \equiv a_1 \hyperlink{def:mod}{\pmod{m_1}} \\
            \vdotswithin{\equiv} \\
            x \equiv a_k \pmod{m_k} \tag{$*$}
        \end{rcases}
    \end{equation*}
    and $x$ is unique mod $M$.
\end{thm}

\begin{remark}
    If $x$ satisfies \eqref{eq:crt}, then so does $x+Mn$ for $n \in \Z$, so the solution set is just $x + M\Z$.
\end{remark}

\begin{proof}
    \leavevmode
    \begin{itemize}
        \item Uniqueness: If $x, y$ satisfies  \eqref{eq:crt}, then $m_i \hyperlink{def:div}{\mid} (x-y)$ for every $i$. As no \hyperlink{def:prime}{prime} divides two of the $m_i$, it follows that $M= \prod m_i \mid (x-y)$, so $x \equiv y \pmod{M}$.
        \item Existence: Write $M_i = M/m_i = \prod_{j\neq i} m_j$.
            By the hypothesis, $\hyperlink{def:gcd}{(M_i, m_i)} = 1$. So $ \exists c_i \in \Z$ with $c_i M _i \equiv 1 \pmod{m_i}$.
            Obviously $c_i M_i \equiv 0 \pmod{m_j}\; \forall j \neq i$. Let $x = \sum_{i=1}^k a_i c_i M_i$, then $x$ satisfies \eqref{eq:crt}, as required. \qedhere
    \end{itemize}
\end{proof}

Note we find the $c_i$ by \hyperlink{def:euclids}{Euclid's algorithm}, so this is constructive.

\begin{cor}
    If $M = \prod_{i=1}^k m_i$, with $m_i$ pairwise coprime, then
    \begin{equation*}
        \hyperlink{def:phi}{\varphi(M)} = \varphi(m_1) \dotsm \varphi (m_k)
    \end{equation*}
\end{cor}

\begin{proof}
    $\hyperlink{def:gcd}{(a, M)} = 1 \iff \forall i, (a, m_i)=1$. So by the \hyperlink{thm:crt}{Chinese Remainder Theorem}, we have a bijection
    \begin{equation*}
        \set{ 1 \leq x \leq M | (x, M) = 1} \stackrel{\sim}{\longleftrightarrow} \set{ (a_1, \dotsc, a_k) | 1 \leq a_i \leq m_i, (a_i, m_i) = 1 }
    \end{equation*} So
    \begin{equation*}
        \#\text{LHS} = \varphi (M) \text{ , } \#\text{RHS} = \prod_i \varphi (m_i)
    \end{equation*}
    and thus they are equal.
\end{proof}

Algebraic aside: We can write this in terms of the rings $R_i = \hyperlink{def:znz}{\Z / m_i \Z}$.

\begin{defi}[Product ring]\hypertarget{def:prodRing}
    The \textbf{product ring} is
    \begin{equation*}
        R_1 \times \dotsb \times R_k = \set{(r_1, \dotsc, r_k) | r_i \in R_i }
    \end{equation*} with $+, \times$ defined component-wise.
    This is a ring with $0$ as the zero vector, and $1$ as the vector of ones.
\end{defi}

\begin{nthm}
    Take $M = \prod m_i$, with $ m_i$ pairwise coprime.
    The map
    \begin{align*}
        \Theta : \Z/M\Z &\longrightarrow \Z/m_1\Z \times \cdots \times \Z / m_k \Z \\
                       a + M \Z &\longmapsto (a + m_1 \Z, \dotsc , a + m_k \Z )
    \end{align*}
    is an isomorphism of rings.
\end{nthm}

\begin{proof}
    $m_i \hyperlink{def:div}{\mid} M \Rightarrow a+m_i \Z$ only depends on $a + M\Z$, so $\Theta$ is well-defined.
    It is a homomorphism (by definition of $+, \times$ in the \hyperlink{def:prodRing}{product ring}), and the \hyperlink{thm:crt}{Chinese Remainder Theorem} implies that it is bijective.
\end{proof}

\begin{defi}[Multiplicative function]\hypertarget{def:multiplicativeFunction}
    A \textbf{multiplicative function} is a function $f: \N = \{1, 2, 3, \dotsc\} \to \C$ for which
    \begin{equation*}
        \hyperlink{def:gcd}{(m, n)} = 1 \implies f(mn) = f(m)f(n)
    \end{equation*}
    (This is the traditional terminology, although it is confusing we don't require $\forall m, n$
    \begin{equation*}f(mn)=f(m)f(n),\end{equation*}
    which is sometimes called \textbf{totally multiplicative}.)
\end{defi}

\begin{eg}
    Examples of \hyperlink{def:multiplicativeFunction}{multiplicative functions}.
    \begin{itemize}
        \item $\varphi(n)$
        \item \hypertarget{def:tau}{$\tau (n) = \#$ of positive divisors of $n$}
        \item \hypertarget{def:sigma}{$\sigma (n) = \sum_{1 \leq d \mid n} d$}
        \item\hypertarget{def:sigmak}{More generally $\sigma_k (n) = \sum_{1 \leq d \hyperlink{def:div}{\mid} n} d^k$}, note $\hyperlink{def:sigma}{\sigma} = \sigma_1, \hyperlink{def:tau}{\tau} = \sigma_0$
    \end{itemize}
\end{eg}

\begin{nlemma}\label{lem:2.4}
    Let $f$ be a \hyperlink{def:multiplicativeFunction}{multiplicative function}.
    Then so is $g$, defined by \begin{equation*} g(n) = \sum_{d \hyperlink{def:div}{\mid} n} f(d) \end{equation*}
\end{nlemma}

\begin{proof}
    Let $\hyperlink{def:gcd}{(m, n)} = 1$.
    Then $\{\text{divisors }d\text{ of }mn\} = \{ d = d_1 d_2 : d_1 \hyperlink{def:div}{\mid} m, d_2 \mid n \}$.
    \begin{equation*}
        g(mn) = \sum_{d \hyperlink{def:div}{\mid} mn} f(d) = \sum_{d_1 \mid m} \sum_{d_2 \mid n} f(d_1 d_2) = \sum_{d_1 \mid m} f(d_1) \sum_{d_2 \mid n} f(d_2) = g(m)g(n) \qedhere
    \end{equation*}
\end{proof}

\begin{eg}
    $f(n) = n^k$ (obviously multiplicative). Then $g(n) = \hyperlink{def:sigmak}{\sigma_k(n)}$.
    Later we will see how to recover $f$ from $g$.
\end{eg}

% Lecture 4 (probably)

\begin{nthm}\label{thm:2.5}
    \leavevmode
    \begin{enumerate}[label=(\roman*)]
        \item $p$ \hyperlink{def:prime}{prime}, $k \leq 1 \implies \hyperlink{def:phi}{\varphi}(p^k) = p^{k-1} (p-1) = p^k \left(1-\frac{1}{p}\right)$
        \item For $n \geq 1$, $\varphi (n) = n \prod_{p \mid n}\left( 1-\frac{1}{p} \right)$ where the product is over primes.
        \item $\sum_{d \mid n} \varphi(d) = n$
    \end{enumerate}
\end{nthm}

\begin{proof}
    \leavevmode
    \begin{enumerate}[label=(\roman*)]
        \item $\hyperlink{def:phi}{\varphi} (p^k) = \# \Set{ 1 \leq a \leq p^k : p \nmid a } = p^k - p^{k-1}$
        \item Write
            \begin{equation*}
                n = \prod_i p_i^{k_i}
            \end{equation*}
            with $p_i$ distinct \hyperlink{def:prime}{primes}. Then,
            \begin{align*}
                \varphi (n) &= \prod_i \varphi (p_i^{k_i}) \\% \text{ by Corollary to CRT } \\
                            &= \prod_i p_i^{k_i} \left(1 - \frac{1}{p_i}\right) \\
                            &= n \prod_i \left(1 - \frac{1}{p_i} \right)
            \end{align*}
        \item By \cref{lem:2.4}, the left hand side is \hyperlink{def:multiplicativeFunction}{multiplicative}.
            The right hand side is obviously multiplicative, so it is enough to prove for $n = p^k$.
            \begin{align*}
                \sum_{d \mid n} \varphi(d) &= \varphi(1) + \varphi(p) + \dotsb + \varphi(p^k) \\
                                       &= 1 + (p - 1) + (p^2 - p) + \dotsb + (p^k - p^{k-1}) \\
                                       &= p^k. \qedhere
            \end{align*}
    \end{enumerate}
\end{proof}

\subsection{Polynomial Congruences}

We will take $R = \Z, \Q$ or $\hyperlink{def:znz}{\Z/n\Z}$ (or any commutative ring with $1$)
\hypertarget{def:rx}Recall $R[X]$ refers to polynomials in $X$ taking coefficients from $R$, formally:
\begin{equation*}
R[X] \coloneqq \set{a_n X^n + a_{n-1} X^{n-1} + \dots + a_0 \mid n \geq 0, \ a_i \in R}
\end{equation*}

Two polynomials are equal if their coefficients are the same.
Importantly, a polynomial $f \in R[X]$ determines a function $R \to R$, given by $\alpha \mapsto f(\alpha) = \sum a_i \alpha^i$.
It can happen that different polynomials give the same function.

\begin{eg}
    For $p$ a \hyperlink{def:prime}{prime} and $R = \hyperlink{def:znz}{\Z/p\Z}$, consider $f(X) = X^p - X$.
    Then $\forall a \in R$, $f(a) = 0$ in $\Z/p\Z$ by \hyperlink{thm:fermatLittle}{Fermat's Little Theorem}.
    So $f$ and the zero polynomial determine the same function.
\end{eg}

Multiplication and addition of polynomials is defined in the obvious way: for $f = \sum_{i=0}^n a_i X^i$, $g = \sum_{i=0}^n b_i X_i$, we have
\begin{align*}
    f + g &= \sum_{i=0}^n (a_i + b_i) X^i \\
    fg &= \sum_{i=0}^{2n} \left(\sum_{j+k=i} a_j b_k\right) X^i
\end{align*}
so $\hyperlink{def:rx}{R[X]}$ is a ring.

We also have a division algorithm for polynomials, where the measure of size is the degree.

\begin{defi}[Degree]\hypertarget{def:degree}
    $\deg(f)$ is the largest $i$ for which the coefficient of $X^i$ is non-zero, and $\deg(f) = -\infty$ if $f$ is the zero polynomial.
\end{defi}

We also have $\hyperlink{def:degree}{\deg}(fg) \leq \deg(f) + \deg(g)$.

\begin{defi}[Divison algorithm for polynomials]\hypertarget{def:polyDivisionAlg}
    Let $f, g \in \hyperlink{def:rx}{R[X]}$.
    Assume that the leading coefficient of $g$ is a unit in $R$ (that is, has an inverse under multiplication)
Then $\exists q, r \in R[X]$ with $\hyperlink{def:degree}{\deg}(r) < \deg(g)$ and $f = gq + r$.
\end{defi}

\begin{proof}
    Induction on $\hyperlink{def:degree}{\deg} f$.
    If $\deg f < \deg g$, then $q = 0$ and $r = f$ will do.

    Otherwise $f = a X^m + \dots$, $a \neq 0$, $g = b X^n + \dots$, with $b = \frac{1}{c}$ invertible by assumption and $m \geq n$.

    Then $f_1 = f - ac X^{m-n} g \in R[X]$ has degree strictly less than $m$.
    So $f_1 = g q_1 + r$ say, $\deg(r) < \deg(g)$ and so $f = (q_1 + ac X^{m-n}) g + r$, as required.
\end{proof}

\begin{ncor}[Remainder theorem]\label{cor:remainderThm}
    Take $f \in R[X]$ and $\alpha \in R$. Then \begin{equation*}f(X) = (X-\alpha) f_1(X) + f(\alpha)\end{equation*}
\end{ncor}

\begin{proof}
    Apply the \hyperlink{def:polyDivisionAlg}{division algorithm} with $g=X-a$, so $f = (X-\alpha) f_1 + c$.
    $c$ has \hyperlink{def:degree}{degree} less than 1, so must be in $R$.
    Now, evaluate both sides at $X = \alpha$, so $c = f(\alpha)$.
\end{proof}

In particular, if $f(\alpha) = 0$ then $f(X) = (X - \alpha) f_1(X)$.
However in general a polynomial can have more roots than its \hyperlink{def:degree}{degree} - consider $f(X) = X^2 - 1$ with $R = \hyperlink{def:znz}{\Z / 8\Z}$

\begin{defi}[Integral domain]\hypertarget{def:intDom}
    A nonzero ring $R$ is an \textbf{integral domain} if $ab=0$ implies $a=0$ or $b=0$.
\end{defi}

\begin{eg}
    $\Q$ and $\Z$ are \hyperlink{def:intDom}{integral domains}, and $\hyperlink{def:znz}{\Z/n\Z}$ is an integral domain if and only if $n$ is \hyperlink{def:prime}{prime}.
\end{eg}

\begin{nthm}\label{thm:2.7}
    If $R$ is an \hyperlink{def:intDom}{integral domain}, and $f \in \hyperlink{def:rx}{R[X]}$ is a non-zero polynomial of degree $n \geq 0$, then $f$ has $\leq n$ roots in $R$.
\end{nthm}

\begin{cor}[Lagrange's Theorem]
    Take $p$ \hyperlink{def:prime}{prime}, $f \in \Z[X]$ of degree $n$, and $f$ not divisible by $p$.
    Then the congruence $f(x) \equiv 0 \pmod{p}$ has $\leq n$ solutions \hyperlink{def:mod}{mod} $p$.
\end{cor}

\begin{proof}
    The $n=0$ case is trivial.
    Suppose $n > 0$. If $f$ has no roots in $R$, we have nothing to prove.

    Otherwise $\exists \alpha \in R$, $f(\alpha) = 0$ \hyperlink{def:polyDivisionAlg}{so} $f(X) = (X - \alpha) f_1(X)$, $f_1 \in \hyperlink{def:rx}{R[X]}$ with $\hyperlink{def:degree}{\deg}(f_1) = n-1$.
    By induction, $f_1$ has $\leq n-1$ roots in $R$.
    If $\beta$ is a root of $f$, then $(\beta-\alpha) f_1(\beta) = 0$ so either $\beta = \alpha$ or $f_1(\beta) = 0$, as $R$ is an \hyperlink{def:intDom}{integral domain}.
    So, the roots of $f$ are exactly $\alpha$ and the roots of $f_1$, so $f$ has $\leq n$ roots.
\end{proof}

\begin{eg}
    Take $p$ \hyperlink{def:prime}{prime}, and set
    \begin{equation*}f(X) = X^{p-1} - 1 - \prod_{a=1}^{p-1} (X - a) \in \hyperlink{def:znz}{\Z / p \Z} [X]\end{equation*}
    Then, $\deg f \leq p-2$. If $a=1, \dotsc, p-1$ then $a^{p-1} \equiv 1 \hyperlink{def:mod}{\pmod{p}}$ so $f(a) = 0 \in \Z/p\Z$.
    So as $f$ has $\geq p-1$ roots mod $p$, it must be identically zero mod $p$. So $f(0)$ is zero mod $p$, and
    \begin{equation*}
        -1 - \prod_{a=1}^{p-1} (-a) \equiv 0 \pmod{p}
    \end{equation*}
    giving us Wilson's Theorem: $(p-1)! \equiv -1 \pmod{p}$.
\end{eg}

The additive group $(\hyperlink{def:znz}{\Z / n\Z}, +)$ is cyclic.
What about $(\hyperlink{def:znz*}{(\Z/n\Z)^\times}, \times)$?

\begin{eg}
    Consider $n=7$, then we can check $3$ is a generator of $\hyperlink{def:znz*}{(\Z / n \Z)^\times}$ and hence the group is cyclic.
\end{eg}

\begin{nthm}\label{thm:2.8}
    If $p$ is \hyperlink{def:prime}{prime}, then $G = \hyperlink{def:znz*}{(\Z / p \Z)^\times}$ is cyclic of order $p-1$.
\end{nthm}

\begin{proof}
    $\# G = p-1 = \sum_{d \hyperlink{def:div}{\mid} p-1} \varphi(d)$ by \cref{thm:2.5} part (iii).

    Also, by Lagrange's Theorem in elementary group theory, \begin{equation*}\# G = \sum_{d \mid p-1} \# \set{g \in G \ \text{of order d}} = \sum_{d \mid p-1} N_d\end{equation*}
    Suppose $G$ is not cyclic, so $G$ has no element of order $p-1$, then ${N_{p-1} = 0 < \varphi(p-1)}$.
    As $\sum \varphi(d) = \sum N_d$, there exists some $d$ for which $N_d > \varphi(d) > 0$. Let $\alpha \in G$ be an element of order $d$.
    Then $\langle\alpha\rangle \coloneqq \{1, \alpha, \alpha^2, \dotsc, \alpha^{d-1}\} \subset G$ is a cyclic subgroup of order $d$ so has exactly $\varphi(d)$ elements of order $d$ by \cref{lem:2.2}.

    So $\exists \beta \notin \langle\alpha\rangle$ where $\beta$ has order $d$.
    Then $1, \alpha, \alpha^{d-1}, \beta$ are $(d+1)$ roots of the polynomial $X^d - 1$, contradicting \cref{thm:2.7}.
    So, $G$ must be cyclic.
\end{proof}

% Lecture 5

\begin{defi}[Primitive root]\hypertarget{def:primRoot}
    If $g$ is a generator of $\hyperlink{def:znz*}{(\Z / p \Z)^\times}$ then $g$ is said to be a \textbf{primitive root mod $p$}.
\end{defi}

By \cref{thm:2.8}, \hyperlink{def:primRoot}{primitive roots} exist.

\begin{eg}
    Take $p = 19$, and let $d$ be the order of $2$ inside $\hyperlink{def:znz*}{(\Z/19\Z)^\times}$, then $d \mid p-1$ = 18.
    We have $2^6 \equiv 7 \not\equiv 1 \hyperlink{def:mod}{\pmod{19}}$, so $d \hyperlink{def:div}{\nmid} 6$.
    Similarly, $2^9 \equiv -1 \pmod{19}$ so $d \nmid 9$.  Hence, $d=18$ and $2$ is a \hyperlink{def:primRoot}{primitive root} mod $19$.
\end{eg}

There are many unsolved problems about \hyperlink{def:primRoot}{primitive roots}:
\begin{enumerate}
    \item Artin's Primitive Root conjecture:

        Fix a \hyperlink{def:prime}{prime} $g \geq 2$. Then there exist infinitely many $p$ for which $g$ is a primitive root mod $p$ (say $g$ is \hyperlink{def:prime}{prime}).
        Even the case $g=2$ is unknown.
        From analytic number theory, it is known there are infinitely many $p$ for which one of $2, 3, 5$ is a primitive root.
    \item How large is the smallest primitive root mod $p$?

        We can show that this goes to $\infty$ as $p$ grows.
        It is known that is is bounded above by $c p^{1/4 + \epsilon}$ for any $\epsilon > 0$, but expected to be smaller (bounded by $c (\log p)^2$).
\end{enumerate}

Now let's consider the more general case of $\hyperlink{def:znz*}{(\Z / p^n \Z)^\times}$ for $n > 1$, and ask if it is cyclic.
$(\Z / 8 \Z)^\times = \{\pm 1, \pm 3\}$, which all have order $1$ or $2$, so the group is not cyclic.
If $n \geq 3$, the map $(\Z/2^n \Z)^\times \to (\Z/8 \Z)^\times$ is surjective:
\begin{equation*}\forall n \geq 1, \quad \hyperlink{def:gcd}{(x, 8)} = 1 \iff x \text{ odd } \iff (x, 2^n) = 1 \end{equation*}
So, $(\Z/2^n \Z)^\times$ is not cyclic for $n \geq 3$ since a generator would map to a generator of $(\Z / 8 \Z)^\times$.

\begin{nthm}\label{thm:2.9}
    If $p > 2$ and $n \geq 1$ then $\hyperlink{def:znz*}{(\Z/p^n \Z)^\times}$ is cyclic.
\end{nthm}

\begin{proof}
    The proof is deferred until \cpageref{pf:2.9}.
\end{proof}

\begin{nlemma}\label{lem:2.10}
    Take $p$ an odd \hyperlink{def:prime}{prime}, and let $y \in \Z$ and $k \geq 1$. Then,
    \begin{enumerate}[label=(\roman*)]
        \item If $x \equiv 1 + p^k y \hyperlink{def:mod}{\pmod{p^{k+1}}}$ then $x^p \equiv 1 + p^{k+1} y \pmod{p^{k+2}}$
        \item $(1 + p y)^{p^k} \equiv 1 + p^{k+1} y \pmod{p^{k+2}}$
    \end{enumerate}
\end{nlemma}

\begin{proof}
    \leavevmode
    \begin{enumerate}[label=(\roman*)]
        \item We may as well assume (by replacing $y$ with $y + pz$) that $x = 1 + p^k y$. Then,
            \begin{align*}
                x^p &= \sum_{j=0}^p \binom{p}{j} (p^k y)^j \\
                    &= 1 + p^{k+1} y + \sum_{j=2}^{p-1} \binom{p}{j} p^{kj} y^j + p^{p^k} y^p.
            \end{align*}
            For $2 \leq j \leq p-1$, we have $\binom{p}{j} \equiv 0 \hyperlink{def:mod}{\pmod{p}}$ and hence $\binom{p}{j} p^{kj} \equiv 0 \pmod{p^{2k+1}}$ and $2k+1 \geq k+2$.
            Since $p > 2$, we have $p^k \geq k+2$ so the last term is also $\equiv 0 \pmod{p^{k+2}}$, hence we are done.

        \item Apply part (i) $k$ times to $1 + py$. \qedhere
    \end{enumerate}
\end{proof}

\begin{nlemma}\label{lem:2.11}
    If $g \in \Z$, $\hyperlink{def:gcd}{(g, p)} = 1$, $g$ is a \hyperlink{def:primRoot}{primitive root} mod $p$, and $g^{p-1} \not\equiv 1 \hyperlink{def:mod}{\pmod{p^2}}$, then $g$ is a generator of $(\Z/p^n \Z)^\times = G$.
\end{nlemma}

\begin{proof}
    Let $d$ be the order of $g$ in $G$.
    We know $d \hyperlink{def:div}{\mid} \#G = p^{n-1}(p-1)$, so if $g$ is not a generator, one of the following two cases must hold:

    \begin{enumerate}[label=(\roman*)]
        \item $d \mid p^{n-2} (p-1)$, so $g^{p^{n-2}(p-1)} \equiv 1 \hyperlink{def:mod}{\pmod{p^n}}$.
        \item $d = p^{n-1} e$, with $1 \leq e < p-1$ and $e \mid p-1$, and so $g^{p^{n-1} e} \equiv 1 \pmod{p^n}$.
    \end{enumerate}
    Deal with these cases in turn:

    \begin{enumerate}[label=(\roman*)]
        \item Let $x = g^{p-1} = 1+py$ with $y \not\equiv 0 \pmod{p}$, because $g^{p-1} \not\equiv 1 \pmod{p^2}$.
            Then by \cref{lem:2.10} (ii), we have $x^{p^{n-2}} \equiv 1 + p^{n-1} y \pmod{p^n}$, so $g^{p^{n-2}(p-1)} \not\equiv 1 \pmod{p^n}$.

        \item $g^{p^{n-1}e} \equiv g^e \pmod{p}$ by \hyperlink{thm:eulerFermat}{Euler-Fermat}, and this is not congruent to $1 \pmod{p}$ as $g$ is a \hyperlink{def:primRoot}{primitive root} mod $p$.
    \end{enumerate}

    So neither (i) nor (ii) can hold, and hence $g$ has order $p^{n-1}(p-1)$.
\end{proof}

We can return and prove \cref{thm:2.9}.

\begin{proof}[Proof of \cref{thm:2.9}]\label{pf:2.9}
    Let $g \in \Z$ be a \hyperlink{def:primRoot}{primitive root} mod $p$.
    If $g^{p-1} \not\equiv 1 \hyperlink{def:mod}{\pmod{p^2}}$, then by \cref{lem:2.11}, $g$ generates $\hyperlink{def:znz*}{(\Z/p^n \Z)^\times}$.
    If not, $g^p \equiv g \pmod{p^2}$. Let $g_1 = g(1 + p)$.
    Then, $g_1^p = g^p (1+p)^p$ and $(1+p)^p \equiv 1 \pmod{p^2}$ by \cref{lem:2.10}.

    So, $g_1^p \equiv g^p \pmod{p^2} \equiv g \pmod{p^2} \not\equiv g_1 \pmod{p^2}$, so by \cref{lem:2.11}, $g_1$ generates $(\Z/p^n \Z)^\times$.
\end{proof}

\begin{remark}
    \leavevmode
    \begin{enumerate}
        \item Our proof gives an easy way to find a generator for $\hyperlink{def:znz*}{(\Z / p^n \Z)^\times}$, independent of $n \geq 2$.
        \item What happens when $p=2$?
            \Cref{lem:2.10}(i) fails to hold for $p=2$, $k=1$: $(1+2)^2 \equiv 1 \hyperlink{def:mod}{\pmod{8}}$.
            It does hold for $p=2$ and $k \geq 2$ however. Part (ii) becomes $(1+4)^{k-1} \equiv 1 + 2^{k+1} \pmod{2^{k+2}}$.
            We can then show (following the argument for $p$ odd), that $(\Z/2^n \Z)^\times$ for $n \geq 3$ is generated by $-1$ and $5$ which have orders $2$ and $2^{n-2}$ respectively.
            So, we have that
            \begin{equation*}
                (\Z/2^n \Z)^\times \cong \Z/2\Z \times \Z/2^{n-2} \Z
            \end{equation*}
        \item If $N = \prod_{1 \leq i \leq r} p_i^{k_i}$, then
            \begin{equation*}
                (\Z/N \Z)^\times \cong (\Z/{p_1}^{k_1} \Z)^\times \times \dotsm \times (\Z/{p_r}^{k_r} \Z)^\times
            \end{equation*}
            by the \hyperlink{thm:crt}{Chinese Remainder Theorem}.
    \end{enumerate}
\end{remark}

\clearpage

\section{Quadratic residues}
Take $p > 2$ an odd \hyperlink{def:prime}{prime}. If $a \in \Z$, we know $x^2 \equiv a \hyperlink{def:mod}{\pmod{p}}$ has $\leq 2$ solutions mod $p$.

For $a \equiv 0 \pmod{p}$, then there is one solution, $x \equiv 0 \pmod{p}$.
For $a \not \equiv 0 \pmod{p}$, if $x$ is a solution then so is $-x$, and $-x \equiv x \pmod{p} \Leftrightarrow 2x \equiv 0 \pmod{p}$ but $a \not\equiv 0 \Rightarrow x \not\equiv 0 \pmod{p}$ so we have either $0$ or $2$ solutions.

\begin{defi}[Quadratic residue]\hypertarget{def:qr}
    $a \not\equiv 0 \hyperlink{def:mod}{\pmod{p}}$ is a \textbf{quadratic residue} mod $p$ if $x^2 \equiv a \pmod{p}$ is soluble, and a \textbf{quadratic non-residue} if not.
\end{defi}

% Lecture 6

So $a$ is a \hyperlink{def:qr}{quadratic residue} mod $p$ iff its class in $(\Z / p \Z)^\times$ is a square.
\begin{eg}
    Computing squares \hyperlink{def:mod}{mod} $7$,
    \begin{equation*}
        \begin{array}{c|cccccc}
            x & 1 & 2 & 3 & 4 & 5 & 6 \\ \hline
            x^2 & 1 & 4 & 2 & 2 & 4 & 1
        \end{array}
    \end{equation*}
    the \hyperlink{def:qr}{quadratic residues} mod $7$ are $\{1, 2, 4\}$.
\end{eg}

\begin{nlemma}\label{lem:3.1}
    Let $p$ be an odd \hyperlink{def:prime}{prime}. There are exactly $\frac{p-1}{2}$ \hyperlink{def:qr}{quadratic residues} mod $p$.
\end{nlemma}

\begin{proof}[Proof 1]
    Consider
    \begin{align*}
        \sigma: \hyperlink{def:znz*}{(\Z / p \Z)^\times} &\longrightarrow (\Z/p\Z)^\times \\
        x &\longmapsto x^2 \hyperlink{def:mod}{\pmod{p}}
    \end{align*}
    Then
    \begin{align*}
        &\sigma(x) = \sigma(y) \\
        \iff &x^2 \equiv y^2 \pmod{p} \\
        \iff &(x-y)(x+y) \equiv 0 \pmod{p} \\
        \iff &x \equiv \pm y \pmod{p}
    \end{align*}
    Since $p$ is odd, if $\hyperlink{def:gcd}{(x, p)} = 1$ then $x \not\equiv -x \pmod{p}$.
    So, $\sigma$ is 2-to-1, hence the image of $\sigma$ has $\frac{p-1}{2}$ elements.
\end{proof}

\begin{proof}[Proof 2]
    Let $g$ be a \hyperlink{def:primRoot}{primitive root} mod $p$.
    Then $\hyperlink{def:znz*}{(\Z / p \Z)^\times} = \{1, g, g^2, \dotsc, g^{p-2}\}$ as $g^{p-1} = 1$.
    So,
    \begin{align*}
        \set{x^2 | x \in (\Z / p\Z)^\times} &= \{1, g^2, g^4, \dotsc, g^{p-3}, g^{p-1}, g^{p+1}, \dotsc, g^{2p-4}\} \\
                                      &= \{1, g^2, g^4, \dotsc, g^{p-3}\}
    \end{align*}
    since $g^{p-1} = 1$ and $g^{p+1} = g^2$, and so on, hence there are $\frac{p-1}{2}$ elements.
\end{proof}

\begin{defi}[Legendre symbol]\hypertarget{def:legendre}
    The \textbf{Legendre symbol} of $a \bmod{p}$ (for $p$ an odd \hyperlink{def:prime}{prime}, $a \in \Z$) is
    \begin{equation*}
        \legendre{a}{p} =
        \begin{cases*}
            0 & if $p \hyperlink{def:div}{\mid} a$ \\
            +1 & if $a$ is a \hyperlink{def:qr}{quadratic residue} mod $p$ \\
            -1 & if $a$ is a quadratic non-residue mod $p$
        \end{cases*}
    \end{equation*}
\end{defi}

\begin{lemma}[Euler's Criterion\hypertarget{lem:eulerCriterion}]
    \begin{equation*}
        \hyperlink{def:legendre}{\legendre{a}{p}} \equiv a^{\frac{p-1}{2}} \hyperlink{def:mod}{\pmod{p}}
    \end{equation*}
\end{lemma}

\begin{remark}
    $\hyperlink{def:legendre}{\legendre{a}{p}} \in \{0, \pm 1\}$ which is a set of $3$ distinct integers mod $p$ as $p > 2$. So the congruence in the lemma determines $\legendre{a}{p}$ completely.
\end{remark}

\begin{proof}
    If $p \hyperlink{def:div}{\mid} a$, obvious.
    Suppose $\hyperlink{def:gcd}{(a, p)} = 1$.
    Then $a^{p-1} = \left(a^{\frac{p-1}{2}}\right)^2 \equiv 1 \hyperlink{def:mod}{\pmod{p}}$.
    Hence $a^{\frac{p-1}{2}} \equiv \pm 1 \pmod{p}$.
    If $a \equiv x^2 \pmod{p}$, then $a^{\frac{p-1}{2}} \equiv x^{p-1} \equiv +1 \pmod{p}$.
    By \cref{lem:3.1}, this gives $\frac{p-1}{2}$ solutions of $a^{\frac{p-1}{2}} \equiv 1 \pmod{p}$.
    So there are no more solutions, i.e.\ if $\hyperlink{def:legendre}{\legendre{a}{p}} = -1$, then $a^{\frac{p-1}{2}} \equiv -1 \pmod{p}$.
\end{proof}

\begin{ncor}\label{cor:3.2}
    Take $a, b \in \mathbb{Z}$ where $p$ is an odd \hyperlink{def:prime}{prime}. Then
    \begin{equation*}
        \hyperlink{def:legendre}{\legendre{ab}{p}} = \legendre{a}{p} \legendre{b}{p}
    \end{equation*}
\end{ncor}

\begin{proof}
    \begin{equation*}
        \hyperlink{def:legendre}{\legendre{ab}{p}} \equiv (ab)^{\frac{p-1}{2}} \equiv a^{\frac{p-1}{2}} b^{\frac{p-1}{2}} \equiv \legendre{a}{p} \legendre{b}{p} \pmod{p}
    \end{equation*}
    By the previous remark, we have $\legendre{ab}{p} = \legendre{a}{p} \legendre{b}{p}$.
\end{proof}

\begin{remark}
    We have the following equivalent statements
    \begin{itemize}
        \item The map
            \begin{equation*}
                \begin{tikzcd}[row sep=tiny,column sep=small]
                    \hyperlink{def:znz*}{(\mathbb{Z}/p\mathbb{Z})^\times} \rar & \{\pm1\} \\
                    a \rar[maps to] & \hyperlink{def:legendre}{\legendre{a}{p}}
                \end{tikzcd}
            \end{equation*}
            is a homomorphism of groups.
        \item The product of \hyperlink{def:qr}{residues} is a residue; the product of a residue and non-residue is a non-residue, and the product of non-residues is a residue.
    \end{itemize}
\end{remark}

\hypertarget{def:repSquare}Another consequence of \hyperlink{lem:eulerCriterion}{Euler's Criterion} allows efficient computation of $\hyperlink{def:legendre}{\legendre{a}{p}}$ because there is a \hyperlink{def:poly}{polynomial time} algorithm to compute $a^n \hyperlink{def:mod}{\pmod{N}}$.
\begin{itemize}
    \item write $n = n_0 + 2 n_1 + 4 n_2 + \dotsb + 2^k n_k$ in binary, $n_i \in \{0, 1\}$
    \item compute $a^2, \, a^4 = (a^2)^2, \, a^8 = (a^4)^2, \dotsc, a^{2^k} \pmod{N}$.
    \item $a^n \equiv \prod_{i: n_i = 1} a^{2^i} \pmod{N}$
\end{itemize}

\begin{ncor}\label{cor:3.3}
    For $p$ an odd prime,
    \begin{equation*}
        \legendre{-1}{p} =
        \begin{cases}
            +1 & p \equiv 1 \pmod{4} \\
            -1 & p \equiv 3 \pmod{4}
        \end{cases}
    \end{equation*}
\end{ncor}

\begin{proof}
    By \hyperlink{lem:eulerCriterion}{Euler's criterion}, if $p = 4k + l$, with $l = 1 $ or $3$,
    \begin{equation*}
        \hyperlink{def:legendre}{\legendre{-1}{p}} = (-1)^{\frac{p-1}{2}} = (-1)^{2k + \frac{l-1}{2}} =
        \begin{cases}
            +1 & l = 1 \\
            -1 & l = 3.
        \end{cases} \qedhere
    \end{equation*}
\end{proof}

What about $\hyperlink{def:legendre}{\legendre{2}{p}}$? So what is $2^{\frac{p-1}{2}} \hyperlink{def:mod}{\pmod{p}}$?
Recall the proof of \hyperlink{thm:fermatLittle}{Fermat's Little Theorem}, and imitate this using $\left(\frac{p-1}{2}\right)!$ instead.
This will prove

\begin{lemma}[Gauss's Lemma]\hypertarget{lem:gausssLemma}
    Take $p$ an odd \hyperlink{def:prime}{prime} and $\hyperlink{def:gcd}{(a, p)} = 1$.
    Then $\legendre{a}{p} = (-1)^\mu$ where $\mu$ is the number of $j \in \{1, \dotsc, \frac{p-1}{2}\}$ such that $aj \equiv k \pmod{p}$ where $\frac{p+1}{2} \leq k \leq p-1$.
\end{lemma}

\begin{proof}
    $1 \leq j \leq \frac{p-1}{2}$.
    Write $aj \equiv \epsilon_j c_j \hyperlink{def:mod}{\pmod{p}}$ with $1 \leq c_j \leq \frac{p-1}{2}$ and $\epsilon_j \in \{\pm 1\}$ (by reducing $aj$ mod $p$ into the interval $(-\frac{p}{2}, \frac{p}{2})$).

    Now claim that if $j \neq k$ with $1 \leq j, k \leq \frac{p-1}{2}$ then $c_j \neq c_k$.
    Indeed if $c_j = c_k$ then $\epsilon_j aj \equiv \epsilon_k ak \pmod{p}$, that is, $j \equiv \pm k \pmod{p}$.
    As $1 \leq j, k \leq \frac{p-1}{2}$, $j + k \not\equiv 0 \pmod{p}$ so $j = k$.
    So, $\left\{c_1, \dotsc, c_{\frac{p-1}{2}}\right\} = \left\{1, 2, \dotsc, \frac{p-1}{2}\right\}$ in some order.

    Now,
    \begin{equation*}\mu = \#\Set{j \in \left\{1, \dotsc, \tfrac{p-1}{2}\right\} | aj \equiv k \bmod{p}, \frac{p+1}{2} \leq k \leq p-1} = \#\set{j | \epsilon_j = -1}\end{equation*}
    So,
    \begin{equation*}
        a^{\frac{p-1}{2}} \cdot \left(\frac{p-1}{2}\right)!
        = \prod_{j=1}^{\frac{p-1}{2}} (aj)
        \equiv \prod_{j=1}^{\frac{p-1}{2}} \epsilon_j c_j
        \equiv \left(\prod_{j=1}^{\frac{p-1}{2}} \epsilon_j \right) \left(\prod_{j=1}^{\frac{p-1}{2}} c_j \right)
        \equiv (-1)^\mu \cdot (\tfrac{p-1}{2})!
    \end{equation*}
    This gives
    \begin{equation*}
        \legendre{a}{p} \equiv a^{\frac{p-1}{2}} \equiv (-1)^\mu. \qedhere
    \end{equation*}
\end{proof}

% Lecture 7

\begin{eg}
    Take the (trivial) special case of $a = -1$, then $-j \in (-\frac{p}{2}, 0)$ so $\epsilon_j = -1$ and $c_j = j$ for any $j$.
    So, $\mu = \frac{p-1}{2}$ and $\legendre{-1}{p} = (-1)^\frac{p-1}{2}$.

    Now consider the case of $n=2$.  Then
    \begin{equation*}
        \set{2j | 1 \leq j \leq \tfrac{p-1}{2}} = \{2, 4, \dotsc, p-3, p-1\}
    \end{equation*}
    If $0 < j < \frac{p}{4}$ then $2j \in \{1, \dotsc, \frac{p-1}{2}\}$ while if $\frac{p}{4} < j < \frac{p}{2}$ then $\frac{p}{2} < 2j < p$.
    So,
    \begin{align*}
        \mu &= \# \Set{j \in \Z | \frac{p}{4} < j < \frac{q}{2}} \\
            &= \floor*{\frac{p}{2}} - \floor*{\frac{p}{4}}
    \end{align*}

    Split into cases:
    \begin{align*}
        p &= 8k+1 &&\implies &&\mu = 4k - 2k = 2k &\implies (-1)^\mu &= 1 \\
        p &= 8k+3 &&\implies &&\mu = (4k+1) - 2k = 2k+1 &\implies (-1)^\mu &= -1 \\
        p &= 8k+5 &&\implies &&\mu = (4k+2) - (2k+1) = 2k+1 &\implies (-1)^\mu &= -1 \\
        p &= 8k+7 &&\implies &&\mu = (4k+3) - (2k+1) = 2k+2 &\implies (-1)^\mu &= 1 \\
    \end{align*}

    Note that $8 \mid p^2 - 1$ and that $16 \mid p^2 - 1 \iff p = 8k \pm 1$, both easy to check.
\end{eg}

\begin{ncor}\label{cor:3.4}
    \begin{equation*}
        \hyperlink{def:legendre}{\legendre{2}{p}} =
        \begin{cases}
            +1 & p \equiv \pm 1 \hyperlink{def:mod}{\pmod{8}} \\
            -1 & p \equiv \pm 3 \pmod{8}
        \end{cases}
        = (-1)^\frac{p^2 - 1}{8}
    \end{equation*}
\end{ncor}

What about $a = 3, 5, \dotsc$?  For $p > 3$, consider $\set{3j | 1 \leq j \leq \frac{p-1}{2}}$.
\begin{itemize}[label={}]
    \item $0 < j < \frac{p}{6} \implies 0 < 3j < \frac{p}{2}$
    \item $\frac{p}{6} < j < \frac{p}{3} \implies \frac{p}{2} < 3j < p$
    \item $\frac{p}{3} < j < \frac{p}{2} \implies 0 < 3j - p < \frac{p}{2}$
\end{itemize}
So, $\mu = \#\set{j | \frac{p}{6} < j < \frac{p}{3}}$ which we can work out from looking at $p$ mod 12.

For general $1 \leq a \leq p-1$, look at $\set{aj | 1 \leq j \leq \frac{p-1}{2}}$.
Then for $k \in \Z$,
\begin{align*}
    kp < aj < \left(k+ \frac{1}{2}\right) p &\implies 0 < aj - kp < \frac{p}{2} & &\text{does not contribute to $\mu$} \\
    \left(k-\frac{1}{2}\right)p < aj < kp &\implies -\frac{p}{2} < aj - kp < 0 & &\text{contributes to $\mu$}
\end{align*}

So
\begin{equation*}
\mu = \sum_{k \in \Z} \#\Set{j | 1 \leq j \leq \frac{p-1}{2}, \left(k-\frac{1}{2}\right) \frac{p}{a} < j < \frac{kp}{a}},
\end{equation*}
i.e.\ $-\frac{p}{2} < aj - kp < 0$.
Note also that $0 < k < \frac{1}{2} + \frac{a j}{p} < \frac{a+1}{2}$.

\begin{thm}[Quadratic Reciprocity]\hypertarget{thm:qr}
    For $(p, q)$ distinct odd \hyperlink{def:prime}{primes},
    \begin{align*}
        \hyperlink{def:legendre}{\legendre{p}{q}} \legendre{q}{p} &= (-1)^{\frac{p-1}{2} \frac{q-1}{2}}, \\
                        \legendre{q}{p} &=
                        \begin{cases}
                            -\legendre{p}{q} & \text{if } p \equiv q \equiv 3 \hyperlink{def:mod}{\pmod{4}} \\
                            +\legendre{p}{q} & \text{otherwise}
                        \end{cases}
    \end{align*}
\end{thm}

\begin{eg}
    \leavevmode
    \begin{enumerate}[label=(\roman*)]
        \item $\hyperlink{def:legendre}{\legendre{3}{p}} = (-1)^\frac{p-1}{2} \legendre{p}{3}$, but
            \begin{align*}
                (-1)^\frac{p-1}{2} &=
                \begin{cases}
                    +1 & p \equiv 1 \hyperlink{def:mod}{\pmod{4}} \\
                    -1 & p \equiv 3 \pmod{4}
                \end{cases}
                \\
                \legendre{p}{3} &=
                \begin{cases}
                    +1 & p \equiv 1 \pmod{3} \\
                    -1 & p \equiv 2 \pmod{3}
                \end{cases}
                \\
                \therefore \legendre{3}{p} &=
                \begin{cases}
                    +1 & p \equiv \pm 1 \pmod{12} \\
                    -1 & p \equiv \pm 5 \pmod{12}
                \end{cases}
            \end{align*}
        \item
            \begin{equation*}
                \legendre{19}{73} = \legendre{73}{19} = \legendre{16}{19} = \legendre{4^2}{19} = 1
            \end{equation*}
        \item
            \begin{equation*}
                \legendre{34}{97} = \legendre{2}{97} \legendre{17}{97}
                = (+1) \times \legendre{97}{17}
                = \legendre{12}{17}
                = \legendre{3}{17} \legendre{2^2}{17}
                \equiv -1
            \end{equation*}
            since $17 \equiv 5 \pmod{12}$.
    \end{enumerate}
\end{eg}

\begin{proof}[Proof of \hyperlink{thm:qr}{Quadratic Reciprocity}]
    By the previous calculation from Gauss' Lemma, $\hyperlink{def:legendre}{\legendre{q}{p}} = (-1)^\mu$
    where
    \begin{equation*}
        \mu =\#\Set{(j, k) \in S | 0 < kp - jq < \frac{p}{2}}
    \end{equation*}
    and
    \begin{equation*}
        S = \Set{(j, k) | 1 \leq j \leq \frac{p-1}{2}, 1 \leq k \leq \frac{q-1}{2}}.
    \end{equation*}
    Similarly, $\legendre{p}{q} = (-1)^\nu$ where
    \begin{equation*}
        \nu =\#\Set{(j, k) \in S | 0 < jq - kp < \frac{q}{2}}.
    \end{equation*}
    Now, $\#S = \frac{p-1}{2} \frac{q-1}{2} = \mu + \nu + \#A + \#B$ where
    \begin{align*}
        A &= \Set{(j, k) \in S | kp - jq > \frac{p}{2}} \\
        B &= \Set{(j, k) \in S | jq - kp > \frac{q}{2}}.
    \end{align*}
    If $(j, k) \in S$, write $j' = \frac{p+1}{2} - j$, $k' = \frac{q+1}{2} - k$.
    Then $(j', k') \in S$, and
    \begin{equation*}
        j'q - k'p = \left(\frac{p+1}{2} - j\right) q - \left(\frac{q+1}{2} - k\right) p = \left(kp - jq - \frac{p}{2}\right) + \frac{q}{2}.
    \end{equation*}
    So $(j, k) \in A \iff (j', k') \in B$, so $\#A = \#B$.
    Hence $\frac{p-1}{2} \frac{q-1}{2} = \mu + \nu + 2 \#A$ and
    \begin{equation*}
        (-1)^{\frac{p-1}{2} \frac{q-1}{2}} = (-1)^{u+v} = \legendre{q}{p} \legendre{p}{q}.\qedhere
    \end{equation*}
\end{proof}

\begin{eg}
    \begin{align*}
        \legendre{7411}{9283} &= -\legendre{9283}{7411} \\
                              &= -\legendre{1872}{7411} \\
                              &= -\legendre{2^4 \cdot 3^2 \cdot 13}{7411} \\
                              &= -\legendre{13}{7411} \\
                              &= -\legendre{7411}{13} \\
                              &= -\legendre{1}{13} = -1
    \end{align*}

    The problem here is that we needed to know that 7411 was prime and factor 1872.
    To avoid this, we will generalise the Legendre symbol to the Jacobi symbol.
\end{eg}

\begin{defi}[Jacobi symbol]\hypertarget{def:jacobi}
    Let $n \geq 1$ be odd, and $n = p_1 \dotsm p_k$ with $p_i$ \hyperlink{def:prime}{primes}, not necessarily distinct.
    The \textbf{Jacobi symbol} is
    \begin{equation*}
        \legendre{a}{n} = \prod_{j=1}^k \hyperlink{def:legendre}{\legendre{a}{p_j}} \quad \text{for } a \in \Z
    \end{equation*}

    Note if $(a, n) > 1$ then $\legendre{a}{n} = 0$, and if $n=1$ then $\legendre{a}{1} = 1$.
\end{defi}

\begin{nprop}\label{prop:3.5}\leavevmode
    \begin{enumerate}[label=(\roman*)]
        \item
            \begin{equation*}
                \hyperlink{def:jacobi}{\legendre{a}{n}} = \legendre{b}{n} \ \text{if} \ a \equiv b \hyperlink{def:mod}{\pmod{n}}
            \end{equation*}
        \item
            \begin{equation*}
                \legendre{ab}{n} = \legendre{a}{n} \legendre{b}{n}, \; \legendre{a}{mn} = \legendre{a}{m} \legendre{a}{n}
            \end{equation*}
        \item
            \begin{equation*}
                \legendre{-1}{n} = (-1)^\frac{n-1}{2}
            \end{equation*}
        \item
            \begin{equation*}
                \legendre{2}{n} = (-1)^\frac{n^2-1}{8}
            \end{equation*}
    \end{enumerate}
\end{nprop}

% Lecture 8

\begin{proof}\leavevmode
    \begin{enumerate}[label=(\roman*)]
        \item
            \begin{equation*}
                a \equiv b \pmod{n} \implies \forall j, a \equiv b \pmod{p_j} \; \implies \forall j, \hyperlink{def:legendre}{\legendre{a}{p_j}} = \legendre{b}{p_j}
            \end{equation*}
        \item
            \begin{equation*}
                \forall j, \legendre{ab}{p_j} = \legendre{a}{p_j} \legendre{b}{p_j}
            \end{equation*}
            This proves the first equation, while the second follows by definition.
        \item This is true if $n$ is \hyperlink{def:prime}{prime}, so by part (ii) it is enough to show that if $m, n \geq 1$ are odd then
            \begin{equation*}
                (-1)^\frac{m-1}{2} \cdot (-1)^\frac{n-1}{2} = (-1)^\frac{mn-1}{2}.
            \end{equation*}
            Indeed, $(m-1)(n-1) \equiv 0 \pmod{4}$, so $mn-1 \equiv m+n-2 \pmod{4}$ and hence
            \begin{equation*}
                \frac{mn-1}{2} \equiv \frac{m-1}{2} + \frac{n-1}{2} \pmod{2}
            \end{equation*}
        \item Similarly to (iii), only need to show that for $m, n \geq 1$ odd
            \begin{equation*}
                (-1)^\frac{m-1}{2} \cdot (-1)^\frac{n-1}{2} = (-1)^\frac{mn-1}{2}.
            \end{equation*}
            Indeed, $(m^2 - 1)(n^2 - 1) \equiv 0 \pmod{16}$ so $m^2 n^2 - 1 \equiv m^2 + n^2 - 2 \pmod{16}$, hence
            \begin{equation*}
                \frac{m^2n^2-1}{8} \equiv \frac{m^2-1}{8} + \frac{n^2-1}{8} \pmod{2}. \qedhere
            \end{equation*}
    \end{enumerate}
\end{proof}

\begin{nthm}[Quadratic Reciprocity for Jacobi symbol]\label{thm:3.6}\hypertarget{thm:qrj}
    Let $m, n \geq 1$ odd. Then
    \begin{equation*}
        \hyperlink{def:jacobi}{\legendre{m}{n}} = (-1)^{\frac{m-1}{2} \frac{n-1}{2}} \legendre{n}{m}
    \end{equation*}
    and if $\hyperlink{def:gcd}{(m, n)} = 1$,
    \begin{equation*}
        \legendre{m}{n} \legendre{n}{m} = (-1)^{\frac{m-1}{2} \frac{n-1}{2}}
    \end{equation*}
\end{nthm}

\begin{proof}
    If $\hyperlink{def:gcd}{(m, n)} > 1$, trivial since both sides are 0.

    Assume that $(m, n) = 1$, with
    \begin{equation*}
        m = \prod_{i=1}^k p_i , \; n = \prod_{j=1}^l q_j \quad \text{no} \ p_i = q_j
    \end{equation*}

    Let
    \begin{align*}
        r &= \# \set{i | p_i \equiv 3 \hyperlink{def:mod}{\bmod{4}}} \\
        s &= \# \set{j | q_j \equiv 3 \bmod{4}}
    \end{align*}

    So
    \begin{align*}
        \legendre{m}{n} &= \prod_{i=1}^k \prod_{j=1}^l \legendre{p_i}{q_j} \\
                        &= \prod_{i=1}^k \prod_{j=1}^l \underbrace{(-1)^{\frac{p_i-1}{2}\frac{q_j-1}{2}}}_{\substack{+1 \text{ unless } \\p_i \equiv q_j \equiv 3 \bmod{4}}} \legendre{q_j}{p_i} \\
                        &= (-1)^{rs} \legendre{n}{m}.
    \end{align*}
    Now $\frac{m-1}{2}\frac{n-1}{2}$ is odd if and only if $m \equiv n \equiv 3 \bmod{4}$ if and only if both $r, s$ are odd.
    So $(-1)^{rs} = (-1)^{\frac{m-1}{2}\frac{n-1}{2}}$.
\end{proof}

For $p$ prime and $\hyperlink{def:gcd}{(a, p)} = 1$, $\hyperlink{def:legendre}{\legendre{a}{p}} = 1 \iff a$ is a square \hyperlink{def:mod}{mod $p$}.
Generalising to the Jacobi symbol, for $n \geq 1$ odd and $\hyperlink{def:gcd}{(a, n)} = 1$, if $a \equiv x^2 \pmod{n}$, then
\begin{equation*}
    \legendre{a}{n} = \legendre{x^2}{n} = \legendre{x}{n}^2 = +1
\end{equation*}
but the converse does not hold! For instance
\begin{equation*}
    \legendre{2}{15} = \legendre{2}{3} \legendre{2}{5} = (-1) (-1) = +1.
\end{equation*}
But $2$ is not a square mod $15$ as it is not a square mod $3$ or mod $5$.

Let $n = pq$, $p \neq q$ odd primes. Then by the \hyperlink{thm:crt}{CRT} for $(a, pq) = 1$,
\begin{equation*}
    a \ \text{is square mod} \ pq \iff a \ \text{is a square mod $p$ and mod $q$} \iff \legendre{a}{p} = \legendre{a}{q} = 1
\end{equation*}
but of course
\begin{align*}
    \legendre{a}{pq} = 1 \iff \ \text{either} \legendre{a}{p} &= \legendre{a}{q} = +1 \\
        \text{or} \legendre{a}{p} &= \legendre{a}{q} = +1
\end{align*}

If we know $\legendre{a}{pq} = 1$, to determine whether or not $a$ is a square mod $pq$, it is at least plausible that we need to know $p$ and $q$, i.e. we need to factor $n$.
(This is generally believed to be true - there are cryptographic protocols which rely on the difficulty of finding out whether $a$ is a square mod $pq=n$, without knowing the factorisation of $n$.)

In computing Legendre symbols, need to factor the numerator to apply \hyperlink{thm:qr}{Quadratic Reciprocity}.
Using \Cref{thm:3.6}, this can be avoided. For instance,
\begin{equation*}
    \legendre{33}{73} = \legendre{73}{33} = \legendre{7}{33} = \legendre{33}{7} = \legendre{5}{7} = -1
\end{equation*}
where the fact that $33 \equiv 1 \pmod{4}$ was used.

At worst, we have to take out factors of 2 (since Quadratic Reciprocity requires $m, n$ odd):
\begin{equation*}
    \legendre{66}{73} = \legendre{2}{73} \legendre{33}{73} = -1.
\end{equation*}
So, it is very similar to Euclid's algorithm.

Are there higher reciprocity laws?
\begin{itemize}
    \item Higher powers, for instance cubes mod $p$:

        If $p \equiv 2 \hyperlink{def:mod}{\pmod{3}}$ then $3 \hyperlink{def:div}{\nmid} p-1$, and we can easily see that everything is a cube mod $p$, since $x \mapsto x^3$ is a bijection $(\Z/p\Z)^\times \to (\Z/p\Z)^\times$.

        For $p \equiv 1 \pmod{3}$, we can define a `cubic Legendre symbol' taking values in $\{0\} \cup \{1, \omega, \omega^2\}$ where $\omega$ is a cube root of unity.
        There is a cubic reciprocity law.
        A big success of 19\textsuperscript{th} century number theory was a proof of a reciprocity law for $n$\textsuperscript{th} powers, for any $n \geq 2$.
    \item A highlight of the (early) 20\textsuperscript{th} century:
        Recall that for $p$ odd,
        \begin{align*}
            \hyperlink{def:legendre}{\legendre{-1}{p}} = 1 \iff p \equiv 1 \pmod{4} &\iff p = x^2 + y^2 \; \text{for some } x, y \in \Z \\
            &\iff p = (x+iy)(x-iy) \in \Z[i]
        \end{align*}
        This was hugely generalised to Artin's Reciprocity Law (in Algebraic Number Theory), and tells us how primes factor in more general number fields.
\end{itemize}

\begin{proof}[Another proof of infinitude of $p \equiv 3 \hyperlink{def:mod}{\pmod{4}}$]
    \begin{equation*}
        \hyperlink{def:jacobi}{\legendre{-1}{n}} =
        \begin{cases}
            0 & n \ \text{even} \\
            1 & n \equiv 1 \pmod{4} \\
            -1 & n \equiv 3 \pmod{4}
        \end{cases}
    \end{equation*}
    and we know
    \begin{equation*}
        \legendre{-1}{n} = \prod_i \legendre{-1}{p_i} \; \text{if} \; n = \prod_i p_i
    \end{equation*}
    The series
    \begin{equation*}
        \sum_{n \geq 1} \legendre{-1}{n} \frac{1}{n} = \frac{1}{1} - \frac{1}{3} + \frac{1}{5} - \frac{1}{7} \dots
    \end{equation*}
    is convergent as it is an alternating series.

    Suppose $p \equiv 3 \pmod{4}$. Then
    \begin{align*}
        \left(1 + \frac{1}{p}\right) \sum_{n \geq 1} \legendre{-1}{n} \frac{1}{n}
        &= \sum_{n \geq 1} \legendre{-1}{n} \frac{1}{n} + \sum_{m \geq 1} \legendre{-1}{m} \frac{1}{mp} \\
        &= \sum_{n \geq 1} \legendre{-1}{n} \frac{1}{n} - \sum_{m \geq 1} \legendre{-1}{mp} \frac{1}{mp} \\
        &= \sum_{\substack{(n, p) = 1 \\ n \geq 1}} \legendre{-1}{n} \frac{1}{n}
    \end{align*}
    must also be convergent.

    If there are only a finite set $\{p_1, \dotsc, p_k\}$ of primes $\equiv 3 \pmod{4}$, then
    \begin{equation}\label{eq:series}
        \left(1 + \frac{1}{p_1}\right)
        \left(1 + \frac{1}{p_2}\right) \dotsm
        \left(1 + \frac{1}{p_k}\right)
        \sum_{n \geq 1} \legendre{-1}{n} \frac{1}{n}
        = \sum_{(n, p_1 \dotsm p_k)=1} \legendre{-1}{n} \frac{1}{n} \tag{$*$}
    \end{equation}
    is also convergent.
    But $(n, p_1 \dots p_k) = 1$ means that every odd prime dividing $n$ is $\equiv 1 \pmod{4}$ so
    \begin{align*}
        \legendre{-1}{n} =
        \begin{cases}
            0 & n \; \text{even} \\
            1 & n \; \text{odd}
        \end{cases} \\
        \implies \text{\eqref{eq:series}} = \sum_{(n, 2p_1 \dotsm p_k) = 1} \frac{1}{n}
    \end{align*}
    but this is divergent.
\end{proof}

% Lecture 9

\clearpage

\section{Binary quadratic forms}
Motivating problem: Which $n \geq 1$ can be written as a sum of 2 integer squares?

\begin{nthm}\label{thm:4.1}
    Take $N \geq 1$ an integer.
    Then $N$ is a sum of two integer squares $\iff$ every \hyperlink{def:prime}{prime} factor $p \equiv 3 \hyperlink{def:mod}{\pmod{4}}$ if $N$ divides it to an even power.
\end{nthm}

\begin{proof}
    \begin{itemize}
        \item [($\Rightarrow$)] Suppose $N = x^2 + y^2$. Let $p \mid N$, $p \equiv 3 \pmod{4}$.
            Then $x^2 \equiv -y^2 \pmod{p}$, so $x \equiv 0 \equiv y \pmod{p}$, since otherwise $\exists z \in \Z$ with $y z \equiv 1 \pmod{p}$ and $(xz)^2 \equiv -1 \pmod{p}$, but $\legendre{-1}{p} = -1$.
            So $p^2 \mid N$ and $N/p^2 = (x / p)^2 + (y / p)^2$, then repeat until no prime factor $p \equiv 3 \pmod{4}$ remains.

        \item [($\Leftarrow$)] Write $N = M^2 N_1$, where $N_1$ is a product of distinct primes, each either 2 or $\equiv1 \pmod{4}$.
            It suffices to show $N_1 = x^2 + y^2$, since then $N = (Mx)^2 + (My)^2$.

            As $(x^2 + y^2)(z^2 + t^2) = (xz - yt)^2 + (xt + yz)^2$ and $2 = 1^2 + 1^2$, it's enough to show if $p \equiv 1 \pmod{4}$ then $p = x^2 + y^2$, which is done later (in \hyperlink{prf:twoSquare}{lecture 11}). \qedhere % add actual link
    \end{itemize}
\end{proof}

There are similar results (Euler) for $x^2 + 2y^2$ and $x^2 + 3y^2$.  However, $x^2 + 6y^2$ is complicated, we'll see why.

The general problem is to consider \textbf{binary quadratic forms} with integer coefficients
\begin{equation*}
    f(x, y) = a x^2 + b x y + c y^2 \quad a,b,c \in \Z
\end{equation*}
and ask what are possible sets $\set{f(x, y) | x, y \in \Z}$?

\begin{defi}[Represent]\hypertarget{def:rep}
    Say $f$ \textbf{represents} $n \in \Z$ if $\exists x, y \in \Z$ with $f(x, y) = n$.
\end{defi}

\begin{defi}[BQF]\hypertarget{def:bqf}
    A \textbf{BQF} is a binary quadratic form with coefficients in $\Z$.
\end{defi}

We use the convenient shorthand $(a,b,c)$ for the form $f=a x^2 + b x y + c y^2$.
$f$ can be written in matrix form:
\begin{equation*}
    a x^2 + b x y + c y^2 =
    \begin{pmatrix}
        x & y
    \end{pmatrix}
    \begin{pmatrix}
        a & \frac{b}{2} \\
        \frac{b}{2} & c
    \end{pmatrix}
    \begin{pmatrix}
        x \\ y
    \end{pmatrix}
\end{equation*}

\begin{eg}
    \leavevmode
    \begin{itemize}
        \item $f(x, y) = x^2 + y^2$ or $(1, 0, 1)$ has matrix
            $\begin{pmatrix}1 & 0 \\ 0 & 1\end{pmatrix}$.
        \item $g(x, y) = 4 x^2 + 12 xy + 10y^2$ or $(4, 12, 10)$ has matrix
            $\begin{pmatrix}4 & 6 \\ 6 & 10\end{pmatrix}$.
    \end{itemize}
    Note $g(x, y) = (2 x + 3 y)^2 + y^2 = X^2 + Y^2 = f(X, Y)$, so $f, g$ are related by an integer change of variables.
    But they don't \hyperlink{def:rep}{represent} the same set of integers - $g$ only represents even integers.
    \begin{equation*}
        \begin{pmatrix} X \\ Y \end{pmatrix}
        =
        \begin{pmatrix} 2 & 3 \\ 0 & 1 \end{pmatrix}
        \begin{pmatrix} x \\ y \end{pmatrix}
        \iff
        \begin{pmatrix} x \\ y \end{pmatrix}
        = \frac{1}{2}
        \begin{pmatrix} 1 & -3 \\ 0 & 2 \end{pmatrix}
        \begin{pmatrix} X \\ Y \end{pmatrix}.
    \end{equation*}
\end{eg}

\begin{defi}[Unimodular substitution]\hypertarget{def:uniSub}
    \leavevmode
    \begin{enumerate}[label=(\arabic*)]
        \item A \textbf{unimodular substitution} is one of the form
            \begin{gather*}
                X = \alpha x + \gamma y, \quad Y = \beta x + \delta y, \quad \alpha, \beta, \gamma, \delta \in \Z, \quad \alpha \delta - \beta \gamma = 1 \\
                \text{so} \;
                \begin{pmatrix} X \\ Y \end{pmatrix} =
                \begin{pmatrix} \alpha & \gamma \\ \beta & \delta \end{pmatrix}
                \begin{pmatrix} x \\ y \end{pmatrix} = A^T
                \begin{pmatrix} x \\ y \end{pmatrix} , \quad A =
                \begin{pmatrix} \alpha & \beta \\ \gamma & \delta \end{pmatrix}
            \end{gather*}
        \item \hyperlink{def:bqf}{BQFs} $f, g$ are \textbf{equivalent} if $f(X, Y) = g(x, y)$ for a unimodular substitution.
    \end{enumerate}
\end{defi}

\begin{remark}
    \leavevmode
    \begin{enumerate}[label=(\arabic*)]
        \item As $A^{-1}$ has integer entries, if $f, g$ are \hyperlink{def:uniSub}{equivalent} then they \hyperlink{def:rep}{represent} the same integers.
        \item (Exercise) Equivalence of \hyperlink{def:bqf}{BQFs} is an equivalence relation
    \end{enumerate}

    More formally,
    \begin{equation*}
        \Set{A = \begin{pmatrix} \alpha & \beta \\ \gamma & \delta \end{pmatrix} | \alpha, \beta, \gamma, \delta \in \Z, \ \alpha \delta - \gamma \beta = 1} \eqqcolon \SL _2(\Z)
    \end{equation*}
    is a group under matrix multiplication ($\det A = 1 \implies A^{-1} \in \SL_2(\Z)$) which acts on the set of \hyperlink{def:bqf}{BQFs} by
    \begin{equation*}
        A : f(x,y) \longmapsto f(\alpha x + \gamma y, \beta x + \delta y)
    \end{equation*}
    and the equivalence classes of BQFs are the orbits of this action.

    We can check this is a group action:
    \begin{equation*}
        A = \begin{pmatrix} 1 & 0 \\ 0 & 1 \end{pmatrix} \implies A f = f
    \end{equation*}
    We must also check $(AB) f = (A (B f))$.
    If $f = (a,b,c)$, $g = Af = (a',b',c')$ for $A = \begin{pmatrix} \alpha & \beta \\ \gamma & \delta \end{pmatrix}$ then
    \begin{align*}
    g(x,y) = f(X,Y) &= \begin{pmatrix}X & Y\end{pmatrix}\begin{pmatrix}a & \frac{b}{2} \\ \frac{b}{2} c \end{pmatrix}\begin{pmatrix}X \\ Y\end{pmatrix} \\
                    &= \begin{pmatrix}x & y\end{pmatrix}A\begin{pmatrix}a & \frac{b}{2} \\ \frac{b}{2} & c \end{pmatrix}A^T \begin{pmatrix}x \\ y\end{pmatrix} \\
        \shortintertext{and}
                    A\begin{pmatrix}a & \frac{b}{2} \\ \frac{b}{2} & c \end{pmatrix}A^T&= \begin{pmatrix} a' & \frac{b'}{2} \\ \frac{b'}{2} & c' \end{pmatrix} \label{eq:9star}\tag{$*$}
    \end{align*}
    So to see that $A(Bf) = (AB)f$, write in matrix form
    \begin{equation*}
    A\left[B \begin{pmatrix}a & \frac{b}{2}\\\frac{b}{2} & c\end{pmatrix} B^T\right]A^T = (AB) \begin{pmatrix}a & \frac{b}{2}\\\frac{b}{2} & c\end{pmatrix} B^T A^T
    \end{equation*}
    and $B^TA^T = (AB)^T$.

\end{remark}

\begin{defi}[Discriminant]\hypertarget{def:disc}
    The \textbf{discriminant} of $f = ax^2 + b x y + c y^2$ is $\disc(f) = b^2 - 4ac$.
    Observe $\disc(f) = -4 \times \det\begin{pmatrix}a & \frac{b}{2} \\ \frac{b}{2} & c\end{pmatrix}$.
\end{defi}

\begin{eg}
    \begin{align*}
        \hyperlink{def:disc}{\disc}(1, 0, 1) &= -4 \\
        \disc(4, 12, 10) &= -16
    \end{align*}
\end{eg}

\begin{nlemma}\label{lem:4.2}
    \hyperlink{def:uniSub}{Equivalent} forms have the same \hyperlink{def:disc}{discriminant} (so the discriminant is an invariant of \hyperlink{def:bqf}{BQFs} under equivalence).
\end{nlemma}

\begin{proof}
    Take identity \eqref{eq:9star}:
    \begin{align*}
        \begin{pmatrix} a' & \frac{b'}{2} \\ \frac{b'}{2} & c \end{pmatrix}
        &= A \begin{pmatrix} a & \frac{b}{2} \\ \frac{b}{2} & c \end{pmatrix}
        A^T \\
        \implies \hyperlink{def:disc}{\disc}(a', b', c') &= \mathrm{disc}(a, b, c) \det A \det A^T \\
                                           &= \mathrm{disc}(a, b, c) \qedhere
    \end{align*}
\end{proof}

\begin{remark}
    The converse is false: \hyperlink{def:bqf}{forms} of the same \hyperlink{def:disc}{discriminant} need not be \hyperlink{def:uniSub}{equivalent:}
    \begin{equation*}
        f = (1, 0, 6) = x^2 + 6y^2, \; g = (2, 0, 3) = 2x^2 + 3y^2
    \end{equation*}
    and $\mathrm{disc}(f) = -24 = \mathrm{disc}(g)$, but $f$ \hyperlink{def:rep}{represents} 1 and $g$ doesn't.
\end{remark}

\begin{nlemma}\label{lem:4.3}
    $\exists$ \hyperlink{def:bqf}{BQF} $f$ with $\mathrm{disc}(f) = d \iff d \equiv 0 \ \text{or}\ 1 \pmod{4}$.
\end{nlemma}
\begin{proof}\leavevmode
    \begin{itemize}
        \item[($\Rightarrow$)] $d = \disc(a, b, c) = b^2 - 4ac \equiv b^2 \pmod{4} \implies d \equiv 0 \text{ or } 1 \pmod{4}$
        \item [($\Leftarrow$)] If $d \equiv 0 \pmod{4}$ then $\disc(1,0,-\frac{d}{4}) = d$. If $d \equiv 1 \pmod{4}$ then $\disc(1,1,\frac{1-d}{4})=d$.
    \end{itemize}
\end{proof}

% Lecture 10

\begin{defi}\hypertarget{def:definite}
    A real quadratic form
    \begin{equation*}
        f(\vec{x}) = \sum_{1 \leq i \leq j \leq n} a_{ij} x_i x_j \quad (a_{ij} \in \R)
    \end{equation*}
    is
    \begin{itemize}
        \item \textbf{positive definite} if $\forall x \in \R^n$, $x \neq 0 \Rightarrow f(\vec{x}) > 0$
        \item \textbf{negative definite} if $\forall x \in \R^n$, $x \neq 0 \Rightarrow f(\vec{x}) < 0$
        \item \textbf{indefinite} if $\exists \vec{x}, \vec{x'} \in \R^n$ with $f(\vec{x} )> 0 > f(\vec{x'})$
    \end{itemize}
\end{defi}

Consider the case $n = 2$:

\begin{nlemma}\label{lem:4.4}
    Take $f=(a,b,c)$ a \hyperlink{def:bqf}{BQF} with $d = b^2 - 4ac$.
    \begin{enumerate}[label=(\roman*)]
        \item $d<0,\ a>0 \implies f$ is \hyperlink{def:definite}{positive definite}
        \item $d<0,\ a<0 \implies f$ is \hyperlink{def:definite}{negative definite}
        \item $d>0 \implies f$ is \hyperlink{def:definite}{indefinite}
        \item $d=0 \implies f = l(m x + ny)^2 \quad l,m,n \in \Z$
    \end{enumerate}
\end{nlemma}

\begin{proof}\leavevmode
    \begin{enumerate}
        \item[(i),(ii)] $d < 0$, so $ac > 0$ and $a,c$ have the same sign.
            \begin{equation*}
                4a f(x, y) = 4 a^2 x^2 + 4 a b x y + 4 a c y^2 = (2ax+by)^2 - dy^2
            \end{equation*}
            so $\forall x, y \in \R$, $4a f(x, y) \geq 0$ (as $d < 0$) with equality if and only if $x = y = 0$.
            $f$ is \hyperlink{def:definite}{positive definite} if $a > 0$ and \hyperlink{def:definite}{negative definite} if $a < 0$.
        \item[(iii)] Assume $d > 0$ and $a > 0$.
        Consider $f(x, 1) = a x^2 + b x + c = a(x - \alpha)(x - \beta)$ with real $\alpha < \beta$ and
        \begin{equation*}
            \alpha, \beta = \frac{-b \pm \sqrt{d}}{2a}
        \end{equation*}
        If $\frac{r}{s} \in \Q$,
        \begin{equation*}
            f(r, s) = s^2 f\left(\frac{r}{s}, 1\right) = a s^2 \left(\frac{r}{s} - \alpha\right)\left(\frac{r}{s} - \beta\right)
        \end{equation*}
        \begin{align*}
            \text{so for} \frac{r}{s} &> \beta & f(r, s) &> 0 \\
            \alpha < \frac{r'}{s'} &< \beta & f(r', s') &< 0
        \end{align*}
        so $f$ is indefinite.
        Indeed $\exists$ integer pairs $(r, s), (r', s')$ with $f(r, s) > 0 > f(r', s')$.

        If $a > 0$ consider $-f$. If $a = 0$, $c \neq 0$ consider $f(1, y)$ instead.
        If $a=c=0$ then $f = b xy$ and $b = \pm \sqrt{d} \neq 0$, so obviously indefinite.
    \item[(iv)] $\alpha = \beta$, left as an exercise. \qedhere
    \end{enumerate}
\end{proof}

\begin{note}
    We can have $a, b, c > 0$ but $f$ \hyperlink{def:definite}{indefinite}, for instance $\hyperlink{def:bqf}{(1, 3, 1)}$ which has $d > 0$.
    We can also have $b < 0$ but $f$ \hyperlink{def:definite}{positive definite}, for example $(1, -1, 2)$ which has $d < 0$.
\end{note}

From now on, we restrict to \hyperlink{def:definite}{positive definite} \hyperlink{def:bqf}{BQFs} $(a, b, c)$ with $a,c>0$ and $d = b^2 - 4 ac < 0$.
The first aim is to identify the `simplest' or `smallest' form in each \hyperlink{def:uniSub}{equivalence} class.
\begin{eg}
    Take $(10, 34, 29)$ and we look for equivalent forms with smaller coefficients (this has $d=-4$).
    First try to reduce $b=34$ by replacing $x$ with $x + \lambda y$ for suitable $\lambda$.
    \begin{equation*}
        f(x, y) = a x^2 + b x y + c y^2 \implies f(x + \lambda y, y) = x^2 + (b + 2 \lambda a) x y + (\lambda^2 a + \lambda b + c) y^2
    \end{equation*}

    Take $\lambda = \pm 1$, so
    \begin{equation*}
        (a, b, c) \sim (a, b \pm 2a, a \pm b + c) \tag{$*$} \label{eq:proc1}
    \end{equation*}
    and in our example $(10, 34, 29) \sim (10, 14, 5) \sim (10, -6, 1)$.

    To reduce the size of $a$, apply $\begin{pmatrix}0 & -1 \\ 1 & 0\end{pmatrix}$ so $X = y$, $Y = -x$ and
    \begin{equation*}
        (a, b, c) \sim (c, -b, a) \tag{$**$} \label{eq:proc2}
    \end{equation*}

    In the example,
    \begin{align*}
        (10, -6, 1) &\overset{\eqref{eq:proc2}}{\sim} (1, 6, 10) \\
                    &\overset{\eqref{eq:proc1}}{\sim} (1, 4, 5) \\
                    &\overset{\eqref{eq:proc1}}{\sim} (1, 2, 2) \\
                    &\overset{\eqref{eq:proc1}}{\sim} (1, 0, 1)
    \end{align*}
\end{eg}

\begin{remark}\leavevmode
    \begin{itemize}
        \item Applying \eqref{eq:proc1} repeatedly, we can replace $f$ by an \hyperlink{def:uniSub}{equivalent} form with the same $a$ and $\abs{b} \leq a$.
        \item Applying \eqref{eq:proc2} repeatedly, we can replace $f$ by an equivalent form with $a \leq c$ and $\abs{b}$ unchanged.
    \end{itemize}
\end{remark}

\begin{defi}[Reduced]\hypertarget{def:reduced}
    A \hyperlink{def:definite}{positive definite} \hyperlink{def:bqf}{BQF} is \textbf{reduced} if either
    \begin{equation*}
        -a < b \leq a < c \quad \text{or} \quad 0 \leq b \leq a = c.
    \end{equation*}
    Note that in both cases $\abs{b} \leq a \leq c$.
\end{defi}
In the example, $(10, 34, 29)$ is not \hyperlink{def:reduced}{reduced} as $\abs{b} \nleq a$, but $(1, 0, 1)$ is.

\begin{nlemma}\label{lem:4.5}
    Every \hyperlink{def:definite}{positive definite} \hyperlink{def:bqf}{BQF} is \hyperlink{def:uniSub}{equivalent} to a \hyperlink{def:reduced}{reduced} form.
\end{nlemma}

\begin{proof}
    Consider the \hyperlink{def:uniSub}{unimodular substitutions}
    \begin{align*}
        T_\pm = \begin{pmatrix} 1 & 0 \\ \pm 1 & 1 \end{pmatrix} : (a, b, c) &\longmapsto (a, b \pm 2a, a \pm b + c) \\
        S = \begin{pmatrix} 0 & -1 \\ 1 & 0 \end{pmatrix} : (a, b, c) &\longmapsto (c, -b, a)
    \end{align*}
    If $a > c$, apply $S$ to replace $f$ with an \hyperlink{def:uniSub}{equivalent} form with smaller $a$ but $\abs{b}$ unchanged.
    If $a \leq c$ and $\abs{b} > a$, use one of $T_\pm$ to decrease $\abs{b}$ (as $\abs{b \pm 2a} < \abs{b}$ for some $\pm$ since $a < \abs{b}$) leaving $a$ unchanged.

    Repeat. At each step, $a + \abs{b}$ is decreased, and $a + \abs{b} > 0$.
    So the process must terminate; after a finite number of substitutions, we reach a form $(a, b, c)$ with $\abs{b} \leq a \leq c$.
    There are two cases:
    \begin{enumerate}[label=\alph*)]
        \item $a < c$: then $(a, b, c)$ will be \hyperlink{def:reduced}{reduced} unless $b = -a$ and then
            \begin{equation*}
                (a, b, c) = (a, -a, c) \sim (a, a, c)
            \end{equation*}
            which is reduced since $-a < b = a < c$.
        \item $a = c$, then $(a, b, c)$ will be reduced provided $0 \leq b \leq a$. Otherwise, $-a \leq b < 0$ and then $(a, b, c) = (a, b, a) \sim (a, -b, a)$ which is reduced. \qedhere
    \end{enumerate}
\end{proof}

\begin{remark}
    We showed that our form was \hyperlink{def:uniSub}{equivalent} to a \hyperlink{def:reduced}{reduced} form using only the substitutions $S$, $T_\pm$.
    With a bit more work, this shows that any unimodular substitution may be written as a product of $S$s and $T_\pm$s, so $\SL _2(Z)$ is generated by $S$ and $T_\pm$.
\end{remark}

% Lecture 11

\begin{nlemma}\label{lem:4.6}
    Let $f = (a,b,c)$ be a \hyperlink{def:reduced}{reduced} \hyperlink{def:definite}{positive definite} \hyperlink{def:bqf}{BQF}, $d = b^2 - 4ac < 0$.
    Then
    \begin{equation*}|b| \leq a \leq \sqrt{\frac{|d|}{3}}\quad \text{and} \quad b \equiv d \pmod{2}.\end{equation*}
\end{nlemma}

\begin{remark}
    For fixed $d$, there are only finitely many possible $(a, b)$, and $c = \frac{b^2 - d}{4a}$, so there is only a finite number of \hyperlink{def:reduced}{reduced} forms of \hyperlink{def:disc}{discriminant} $d$.
\end{remark}

\begin{proof}
    $b^2 \equiv d \pmod{4}$ so $b \equiv d \pmod{2}$.
    $f$ is \hyperlink{def:reduced}{reduced} $\implies \abs{b} \leq a \leq c$, and
    \begin{equation*}d = b^2 - 4ac \leq ac - 4ac = -3ac \leq -3a^2, \implies a^2 \leq \frac{1}{3} |d|.\qedhere\end{equation*}
\end{proof}

\begin{eg}
    Take $d = -4$.
    Then $\abs{b} \leq a \leq 1$, and $b \equiv 0 \pmod{2}$ so $a = 1, b=0 \implies c=1$.
    So the only \hyperlink{def:reduced}{reduced} \hyperlink{def:bqf}{BQF} of \hyperlink{def:disc}{discriminant} $-4$ (\hyperlink{def:definite}{positive definite}) is $x^2 + y^2$.

    Use this to prove the `serious' part of \cref{thm:4.1}: if $p \equiv 1 \pmod{4}$ then $p = x^2 + y^2$, $x, y \in \Z$.

    \begin{proof}\hypertarget{prf:twoSquare}
        $p \equiv 1 \pmod{4} \Rightarrow \hyperlink{def:legendre}{\legendre{-1}{p}} = 1$, so $\exists u, k \in \Z$ such that $u^2 = -1 + pk$.
        Let $f = (p, 2u, k)$. Then $f(1, 0) = p$, $\disc(f) = 4u^2 - 4pk = -4$.

        But by \cref{lem:4.5} and the last calculation, $f$ is equivalent to $x^2 + y^2$. So $\exists x, y \in \Z$ such that $x^2 + y^2 = p$.
    \end{proof}
\end{eg}

This method can be applied more generally.
Note if $f(x, y) = n$ then $f(kx, ky) = k^2n$.
Recall $f$ \hyperlink{def:rep}{represents} $n$ if $\exists x, y \in \Z$ such that $f(x,y) = 1$.

\begin{defi}[Proper representation]\hypertarget{def:propRep}
    $f$ \textbf{properly represents} $n$ if $\exists x, y \in \Z$ such that $f(x, y) = n$ and $\hyperlink{def:gcd}{(x, y)} = 1$ (in particular $(x, y) \neq (0, 0)$.)
\end{defi}

\begin{remark}
    Suppose $f(x, y) = g(X, Y)$ with $\begin{pmatrix}X \\ Y\end{pmatrix} = \begin{pmatrix}\alpha & \gamma \\ \beta & \delta\end{pmatrix} \begin{pmatrix}x \\ y\end{pmatrix}$ and $\alpha\delta - \beta \gamma = 1$, so $\begin{pmatrix}\delta & -\gamma \\ -\beta &  \alpha \end{pmatrix} \begin{pmatrix}X \\ Y\end{pmatrix}$.
    For $x, y \in \Z$, $\gcd(x, y) = \gcd(X, Y)$, so $f, g$ \hyperlink{def:propRep}{properly represent} the same integers.
\end{remark}

\begin{nlemma}\label{lem:4.7}
    The least integers \hyperlink{def:propRep}{properly represented} by a \hyperlink{def:reduced}{reduced} \hyperlink{def:definite}{positive definite} \hyperlink{def:bqf}{BQF} $f = (a, b, c)$ are $a$, $c$, and $a - \abs{b} + c$ in that order.
\end{nlemma}
A number in this list is repeated $\iff$ it is \hyperlink{def:propRep}{(properly) represented} by $f$ in more than one way -- excluding $f(x, y) = f(-x, -y)$.
For example, take $f=x^2 + y^2 = (1, 0, 1)$. $f(1, 0) = a = f(0, 1) = c < f(1, 1) = 2 = a - \abs{b} + c$.

\begin{proof}
    If $f(x, 0) = n$ \hyperlink{def:propRep}{properly}, then $(x, y) = 1 \Rightarrow x = \pm 1 \Rightarrow n = f(1, 0) = a$.
    If $f(0, y) = n$ properly, then $y = \pm 1 \Rightarrow n = f(0, 1) = c$.

    Suppose $n = f(x, y), \abs{x} \geq \abs{y} > 0$, $\gcd(x, y) = 1$.  Then
    \begin{align*}
        n = a x^2 + b xy + cy^2 &\geq a x^2 - \abs{b} \abs{x} \abs{y} + c y^2 \\
                                &\geq a x^2 -\abs{b} x^2 + c y^2 \\
                                &\geq (a - \abs{b}) + c \geq c
    \end{align*}

    For a choice of sign, $f(1, \pm1) = a \pm b + c = a - \abs{b} + c$.
    So $a \leq c \leq a - \abs{b} + c$ are the least values properly represented by $f$.
\end{proof}

\begin{nthm}\label{thm:4.8}
    Every \hyperlink{def:definite}{positive definite} \hyperlink{def:bqf}{BQF} is \hyperlink{def:uniSub}{equivalent} to a \emph{unique} \hyperlink{def:reduced}{reduced} form.
\end{nthm}

\begin{proof}
    By \cref{lem:4.5}, every \hyperlink{def:definite}{positive definite} \hyperlink{def:bqf}{BQF} is \hyperlink{def:uniSub}{equivalent} to some \hyperlink{def:reduced}{reduced} form, so have to show that if $f \sim g$ and $f, g$ are reduced, then $f = g$.
    Say $f = (a, b, c) \sim g=(a', b', c')$ are both reduced.

    By \cref{lem:4.7}, the least $n$ \hyperlink{def:propRep}{properly represented} by $f$ is $a$, and by $g$ is $a'$, so $a = a'$.
    The next least integer properly represented by $f$ is $c$, and by $g$ is $c'$, so $c = c'$.
    So, $b^2 = d + 4ac = d + 4a'c' = b'^2$, so $g = (a, b, c)$ or $g = (a, -b, c)$.
    We need to take care of $a=c$: if $a = c$ then $(a, b', a)$ is reduced $\iff 0 \leq b' \leq a$, so $(a, -b, a)$ is excluded and $f = g$.

    Otherwise $a < c$, $-a < b \leq a$.
    If $(a, -b, c)$ is reduced then $-a < b < a$.
    Then $a < c < a - \abs{b} + c$ (no repeats).
    By the proof of \cref{lem:4.7}
    \begin{equation*}
        f(x, y) =
        \begin{cases}
            a & \iff (x, y) = (\pm 1, 0) \\
            c & \iff (x, y) = (0, \pm 1)
        \end{cases}
    \end{equation*}
    and same for $g$.
    As $g(x, y) = f(X, Y)$, $\begin{pmatrix} X \\ Y \end{pmatrix}=\begin{pmatrix}\alpha & \gamma \\ \beta & \delta\end{pmatrix} \begin{pmatrix} x \\ y\end{pmatrix}$ so
    \begin{equation*}(x, y) = (\pm 1, 0) \Longleftrightarrow f=a=g \Longleftrightarrow (X, Y) = (\pm 1, 0).\end{equation*}
    Similarly, $(x,y) = (0, \pm 1) \Longleftrightarrow (X, Y) = (0, \pm 1)$ so $\begin{pmatrix}\alpha & \gamma \\ \beta & \delta\end{pmatrix} = \begin{pmatrix}\pm 1 & 0 \\ 0 & \pm 1\end{pmatrix}$.
    As $\alpha \delta - \beta \gamma = 1$, $\begin{pmatrix}\alpha & \gamma \\ \beta & \delta\end{pmatrix} = \pm \begin{pmatrix}1 & 0 \\ 0 & 1 \end{pmatrix}$, hence $g(x, y) = f(\epsilon x, \epsilon y) = f(x, y)$.
\end{proof}

\begin{remark}
    The definition of `\hyperlink{def:reduced}{reduced}' was cooked up precisely to ensure that this Theorem holds.
\end{remark}

\begin{eg}
    For $d = -24$, $x^2 + 6y^2$ and $2x^2 + 3y^2$ are \hyperlink{def:reduced}{reduced} and \hyperlink{def:uniSub}{inequivalent}, with $\disc = -24$.
    Are there others?
    $|b| \leq a \leq \sqrt{8}$ so $|b| \leq a \leq 2$, and $b = d = 0 \pmod{2}$.

    For $a = 1$, we have $b=0$ so $c = 6$, giving $(1, 0, 6)$.

    For $a=2$, $b\in \{0, \pm 2\}$ and $c = \frac{b^2 +24}{8}$. $b = \pm 2 \implies c \notin \Z$, so $b=0$ and $c=3$ giving $(2, 0, 3)$.
    So there are no others.
\end{eg}

% Lecture 12

Every \hyperlink{def:definite}{positive definite} \hyperlink{def:bqf}{BQF} is \hyperlink{def:uniSub}{equivalent} to a unique \hyperlink{def:reduced}{reduced} form, and $\exists$ only a finite number of reduced forms of \hyperlink{def:disc}{discriminant} $d$.
\begin{defi}[Class number]\hypertarget{def:classNum}
    The number of \hyperlink{def:definite}{positive definite} \hyperlink{def:reduced}{reduced} forms of \hyperlink{def:disc}{discriminant} $d$ is called the \textbf{class number} $h(d)$.
\end{defi}

\begin{eg}
    $\hyperlink{def:classNum}{h(-4)} = 1 = h(-7)$, and $h(-24) = 2$.
\end{eg}

We saw that for given $d$, we can easily work out what the reduced forms are.
How does $\hyperlink{def:classNum}{h(d)}$ behave as a function of $d$?
How many $d$ are there with $h(d) = 1$?
Some results (beyond the scope of this course), mostly using analytic number theory:
\begin{enumerate}
    \item $\hyperlink{def:classNum}{h(d)} \to \infty$ as $d \to -\infty$ (1934 Heilbronn), so $\#\set{d | h(d) \leq X}$ is finite.
        First Siegel showed $h(d) \to \infty$ assuming the generalised Riemann hypothesis in analytic number theory.
        Then Heilbronn proved $h(d) \to \infty$ assuming GRH false by a completely different method.
    \item `On average $\hyperlink{def:classNum}{h(d)} \approx \sqrt{\abs{d}}$':
        \begin{equation*}
            \frac{1}{\frac{1}{2} X} \sum_{\substack{0 \geq d \geq -x \\ d\equiv 0,1\bmod{4}}}{h(d)} \sim c \sqrt{X} \text{ for some } c > 0. \tag{1874, Mertens}
        \end{equation*}
    \item $\hyperlink{def:classNum}{h(d)} = 1 \Longleftrightarrow -d = 3,4,7,8,11,19,43,67,163 \text{ and } 12,16,27,28$.
        It was known since around 1900 that this was true, except for possibly one other $d$ with $-d$ very large.
        (1967 Baker, Stark showed the list was complete, but was actually proved 10 years earlier by Heeger).
    \item $\set{d | \hyperlink{def:classNum}{h(d)} \leq 100}$ is known.
        In fact $\exists$ explicit bound for the largest $\abs{d}$ with $h(d) = N$, but it is not very practical, for $N=1$ is is $e^{5000}$.
        This is nevertheless a very hard result using analytic number theory, algebraic geometry and elliptic curves.
\end{enumerate}

Now study the problem: if $f$ is a \hyperlink{def:bqf}{BQF} and $n \in \Z$, when does $f$ \hyperlink{def:rep}{represent} $n$?
We've seen the answer for $x^2 + y^2$.
Now partially generalise this to \hyperlink{def:definite}{positive definite} \hyperlink{def:bqf}{BQFs}.
For \hyperlink{def:definite}{indefinite} forms look at the section on continued fractions: the method is very different.

\begin{nlemma}\label{lem:4.9}
    Let $f$ be a \hyperlink{def:bqf}{BQF}, $n \in \Z$.
    Then $f$ \hyperlink{def:propRep}{properly represents} $n \iff f \sim g = (a, b, c)$ with $a =n$.
\end{nlemma}

\begin{proof}
    $(\Leftarrow)$. $g(n, b, c) \Rightarrow g(1, 0) = n$, so $g$ \hyperlink{def:propRep}{represents $n$ properly}. Hence if $f \sim g$, so does $g$.

    $(\Rightarrow)$ $f$ properly represents $n$ means $\exists \gamma, \delta \in \Z$ with $f(\gamma, \delta) = n$ and $\hyperlink{def:gcd}{(\gamma, \delta)} = 1$.
    Then $\exists \alpha, \beta \in \Z$ such that $\alpha \delta - \beta \gamma = 1$ by Euclid.
    Let $g(x,y) = f(\gamma x + \alpha y, \delta x +\beta y) \sim f$.
    Then $g(1, 0) = f(\gamma, \delta) = n$, i.e.\ $g = (n, b, c)$.
\end{proof}

Recall $p = x^2 + y^2 \iff p = 2$ or $\hyperlink{def:legendre}{\legendre{-1}{p}} = 1$. Generalise:

\begin{nthm}\label{thm:4.10}
    Let $d < 0$ be a \hyperlink{def:disc}{discriminant} (i.e. $d \equiv 0 \text{ or } 1 \bmod{4}$), and say $n \geq 1$.
    Then
    \begin{align*}
        & n\text{ is \hyperlink{def:propRep}{properly represented} by some \hyperlink{def:bqf}{BQF} of \hyperlink{def:disc}{discriminant} } d \\
        \iff &x^2 \equiv d \pmod{4n} \text{ is soluble}.
    \end{align*}
\end{nthm}

\begin{proof}
    \begin{itemize}
        \item [($\Rightarrow$)] Suppose $n = f(x, y)$ properly, and $\hyperlink{def:disc}{\disc}(f) = d$.
            Then \cref{lem:4.9} $\Rightarrow f \sim g = (n, b, c)$ with $b, c \in \Z$ and $d = \disc(g) = b^2 - 4cn \implies b^2 \equiv d \pmod{4n}$.
        \item [$(\Leftarrow)$] Suppose soluble. $\exists b, c \in \Z$ with $b^2 = d + 4 n c$.
            Then $(n, b, c)$ has \hyperlink{def:disc}{discriminant} $d$, and properly represents $n$. \qedhere
    \end{itemize}
\end{proof}

\begin{eg}
    What integers are represented (properly) by $f = x^2 + xy + 2y^2$? $\hyperlink{def:disc}{\disc}(f) = -7$.
    $f$ is \hyperlink{def:reduced}{reduced}.
    If $(a, b, c)$ is any other reduced form of the same discriminant then $\abs{b} \leq a \leq \sqrt{\frac{7}{3}}$ and $b \equiv d \pmod{2}$ is odd, so $a = 1$, $b = \pm 1$, $c = 2$ and $(a, b, c)$ reduced $\implies (a, b, c) = (1, 1, 2)$ so $\hyperlink{def:classNum}{h(-7)} = 1$.

    Let's first consider $f(x,y) = p$, $p$ prime, $p \neq 2, 7$.
    By \cref{thm:4.10}, $p$ is \hyperlink{def:propRep}{properly represented} by $f \iff x^2 \equiv -7 \pmod{4p}$ is soluble
    \begin{align*}
        &\iff \begin{cases} x^2 \equiv -7 \pmod{4} \\ x^2 \equiv -7 \pmod{p}\end{cases} \text{ are soluble} \\
        &\iff \hyperlink{def:legendre}{\legendre{-7}{p}} = 1.
    \end{align*}
    But
    \begin{equation*}
        \legendre{-7}{p} = \legendre{-1}{p} (-1)^\frac{p-1}{2} \legendre{p}{7} = \legendre{p}{7} = \begin{cases}1 & p \equiv 1,2,4 \pmod{7} \\ -1 & p \equiv 3,5,6 \pmod{7}\end{cases}.
    \end{equation*}
    Also $f(0, 1) = 2$ and $f(1, -2) = 7$.

    So, a prime $p$ is properly represented $\iff$ $p = 7 \text{ or } p \equiv 1, 2, 4 \pmod{7}$.
\end{eg}
For more general $n$, let $n = 2^{e_2} 3^{e_3}\dotsm= \prod_p p^{e_p}, e_p \geq 0$ and $e_p = 0$ for all but finitely many $p$.
Then
\begin{equation*}
    x^2 \equiv d \pmod{4n}\text{ is soluble } \iff
    \begin{rcases}
        \forall p \neq 2 & x^2 \equiv d \pmod{p^{e_p}} \\
        \text{and} & x^2 \equiv d \pmod{2^{e_p + 2}}
    \end{rcases}
    \text{ are soluble}
\end{equation*}

The next goal is to show if $x^2 \equiv d \pmod{p}$ soluble ($p \nmid d$), then the congruence is soluble mod $p^e\ \forall e \geq 1$ for $p$ odd, i.e.\ that the \hyperlink{def:legendre}{Legendre symbol} determines solubility.
% Lecture 13

\begin{nlemma}\label{lem:4.11}\leavevmode
    \begin{enumerate}[label=(\roman*)]
        \item Take $p$ an odd \hyperlink{def:prime}{prime}, $a \in \Z$ with $\legendre{a}{p} = 1$.
            Then $\forall n \geq 1$, $x^2 \equiv a \pmod{p^n}$ is soluble.
        \item $a \equiv 1 \pmod{8} \implies x^2 \equiv a \pmod{2^n}$ soluble $\forall n \geq 1$.
    \end{enumerate}
\end{nlemma}

\begin{proof}\leavevmode
    \begin{enumerate}[label=(\roman*)]
        \item $\legendre{a}{p} = 1 \implies $ there is a solution to $x^2 \equiv a \pmod{p}$.
            So, by induction assume that for some $n \geq 1$, $x^2 = a + k p^n$ for some $k \in \Z$.
            Consider $t \in \Z$, so
            \begin{align*}
                (x + t p^n)^2 &= x^2 + 2 x t p^n + t^2 p^{2n} \\
                              &\equiv a + (k+ 2xt)p^n \pmod{p^{n+1}}.
            \end{align*}
            Since $\legendre{a}{p} \neq 0$, $(a, p) = 1 = (x, p)$. So, $\exists t \in \Z$ such that $k + 2 x t \equiv 0 \pmod{p}$.
            For this $t$, $(x + p^n t)^2 \equiv a \pmod{p^{n+1}}$.
        \item $n \leq 3$ is easy, take $x=1$.
            So again by induction, assume $x^2 = a + 2^n k$ for $n \geq 3$.
            If $k$ even, then $x^2 \equiv a \pmod{2^{n+1}}$. Otherwise,
            \begin{align*}
                (x + 2^{n-1})^2 = x^2 + x 2^n + 2^{2n-2} &\equiv a + (x+k)2^n \pmod{2^{n+1}} \\
                                                         &\equiv a \pmod{2^{n+1}}.\qedhere
            \end{align*}
    \end{enumerate}
\end{proof}

\begin{eg}
    Continuing the example of $f = \hyperlink{def:disc}{(1, 1, 2)}$ with $\hyperlink{def:disc}{\disc} = -7$:
    \begin{itemize}
        \item $-7 \equiv 1 \pmod{8} \implies x^2 \equiv -7 \pmod{2^n}$ is soluble $\forall n$.
        \item For $p$ odd and $ p \equiv 1, 2, 4 \pmod{7}, \legendre{-7}{p} = 1 \implies x^2 \equiv -7 \pmod{p^n}$ is soluble $\forall n \geq 1$.
        \item For $p = 7$: $x^2 \equiv -7 \pmod{7}$ is soluble, but $x^2 \equiv -7 \pmod{49}$ is insoluble, hence insoluble mod $7^n$ $\forall n \geq 2$.
    \end{itemize}

    Conclusion: $f = (1, 1, 2)$ \hyperlink{def:propRep}{properly represents} $n \geq 1$ if and only if
    \begin{equation*}
        n = 2^{e_2} 7^{e_7} \prod_{\mathclap{p \equiv 1, 2, 4 \bmod{7}}} p^{e_p}, \qquad e_p \geq 0, \; e_7 \in \{0, 1\}
    \end{equation*}
    The numbers \hyperlink{def:rep}{represented} (not necessarily properly) by $f$ are $k^2 n$, $k \geq 1$ with $n$ as above.
    That is, $n = x^2 + x y + 2y^2$ for some $x, y \in \Z$ if and only if $n = 0$ or every prime $p \not\equiv 1, 2, 4 \pmod{7}$ dividing $n$ divides it to an even power.
\end{eg}

This method completely describes the integers represented by $f$ of \hyperlink{def:disc}{discriminant} $d < 0$ when $\hyperlink{def:classNum}{h(d)} = 1$.
For $h(d) > 1$, all this tells us is which $n$ are \hyperlink{def:rep}{represented} by \emph{some} \hyperlink{def:uniSub}{equivalence} class of \hyperlink{def:bqf}{BQFs} of \hyperlink{def:disc}{discriminant} $d$.

Sometimes (as on the example sheet), you can figure out which just by congruence conditions, but usually not.
For example, $x^2 + 23 y^2$ - the \hyperlink{def:rep}{representability} of $n$ by $x^2 + 23 y^2$ cannot be described using congruence conditions on $p \mid n$.
(Why? Deep algebraic number theory related to `non-abelian reciprocity laws'.)

\begin{defi}[Fundamental discriminant]\hypertarget{def:fundDisc}
    $d \equiv 0 \text{ or } 1 \pmod{4}$ is a \textbf{fundamental discriminant} if $d \neq k^2 d'$, where $k \geq 2$ and $d' \equiv 0 \text{ or } 1 \pmod{4}$.
\end{defi}
For \hyperlink{def:fundDisc}{fundamental discriminant} $d < 0$, Gauss defined composition of two \hyperlink{def:bqf}{BQFs} of discriminant $d$ to get a third, turning \{equivalence classes of \hyperlink{def:definite}{positive definite} BQFs of discriminant $d$\} into an abelian group, the class group.
This turns out to be the ideal class group of the quadratic field $\Q(\sqrt{d})$ (see Number Fields).

\hyperlink{def:definite}{Negative definite} forms now provide nothing new, but what about indefinite forms?

The key difference between definite and indefinite forms is that for a definite form $f$, $\#\set{(x, y) \in \Z^2 | f(x, y) = n}$ is always finite.
For instance, $x^2 + y^2 = n \implies \abs{x}, \abs{y} \leq \sqrt{n}$.
In general, $f(x, y) = n$ is the equation of an ellipse in $\R^2$, so integer points $(x, y)$ on it have bounded size.

On the other hand, if $f$ is indefinite, then there can be infinitely many solutions.
For example, $x^2 - 2y^2$ is indefinite. Consider $x^2 - 2y^2 = 1$. We have solutions $(x, y) = (1, 0)$ and also $(3, 2)$. If $(x, y)$ is a solution, then $(x^2 + 2y^2)^2 - 2 (2xy)^2 = (x^2 - 2y^2)^2 = 1$ as well.
So starting with $(3, 2)$ and repeating gets solutions of arbitrarily large size. We study $x^2 - dy^2 = 1$ later.

What about more variables? For instance, what integer values does $x_1^2 + x_2^2 + \dotsb + x_k^2$ take?

\begin{thm}[1770, Lagrange]
    Every positive integer $n$ is a sum of four squares. So for $k \geq 4$, we are done.
\end{thm}

\begin{proof}
    Not in the scope of this course, but there is a formula for the number of representations involving 'modular forms'.
\end{proof}

Harder is
\begin{thm}[1797, Legendre]
    \begin{equation*}
        n = x^2 + y^2 + z^2 \iff n \neq 4^a (8b + 7)
    \end{equation*}
\end{thm}

\begin{proof}
    The $\implies$ direction is easy, and the usual proof of $\impliedby$ is hard and uses quadratic reciprocity, and Dirichlet's theorem on existence of primes in arithmetic progressions. Again, this is out of scope.
\end{proof}

\clearpage
\section{Distribution of the primes}
\hypertarget{def:primes}We consider the sequence of primes,
\begin{equation*}
    2, 3, 5, 7, 11, 13, 17, \dotsc, 691, \dotsc, 144169, \dotsc
\end{equation*}
an infinite sequence (\hyperlink{thm:infPrimes}{Euclid}).

Two natural questions are:
\begin{enumerate}[label=(\roman*)]
    \item How rapidly does the sequence grow?
    \item How (ir)regular is the sequence e.g.\ how big are the gaps?
\end{enumerate}

(i) is partially answered by the
\begin{thm}[Prime Number Theorem]
    \begin{align*}
        \hypertarget{thm:pnt}{\hypertarget{def:pi}{\pi(X)}} \coloneqq \#\{\text{primes } p \leq X\} &\sim \frac{X}{\log X} \text{ as } X \to \infty \\
                                               &\sim \int_2^X \frac{dt}{\log t} \quad \text{logarithmic integral}
    \end{align*}
\end{thm}
The proof uses complex analysis.
We'll eventually prove
\begin{thm}[Tchebyshev's Theorem]\hypertarget{thm:cheby}
    $\exists c_2 > c_1 > 0$ such that
    \begin{equation*}
        c_1 \frac{x}{\log x} < \hyperlink{def:pi}{\pi(x)} < c_2 \frac{x}{\log x}
    \end{equation*}
\end{thm}
For the moment, we'll prove some weaker results:
\begin{nlemma}\label{lem:5.1}
    \begin{equation*}
        \hyperlink{def:pi}{\pi(x)} \geq \frac{\log x}{2 \log 2} \quad \forall \text{integers } x \geq 1
    \end{equation*}
\end{nlemma}

\begin{proof}
    Let $\{p_1, \dotsc, p_r\} = \{\text{primes} \leq x\}$ (so $\hyperlink{def:pi}{\pi(x)} = r$).
    If $n \leq x$, $n = K^2 p_1^{\alpha_1} \dotsm p_r^{\alpha_r}$, $1 \leq K \leq \sqrt{x}$, $\alpha_i \in \{0, 1\}$ (so $K$ is the largest square dividing $n$).
    \begin{gather*}
        \text{there are }
        \begin{rcases*}
            \leq \sqrt{x} & possibilities for $k$ \\
            \leq 2^r & possibilities for $\alpha_i$s
        \end{rcases*}
        \implies x = \#\{1 \leq n \leq x\} \leq \sqrt{x} 2^r \\
        2^r = 2^{\pi(x)} \geq \sqrt{x} \implies \pi(x) \geq \frac{\log{x}}{2 \log 2}. \qedhere
    \end{gather*}
\end{proof}

\hypertarget{def:pn}Say $p_n$ is the $n$\textsuperscript{th} \hyperlink{def:primes}{prime}.
On average, by the \hyperlink{thm:pnt}{prime number theorem}, $p_{n+1} - p_n$ is around $\log X$.
But the gap oscillates wildly.

\textbf{Small gaps}: An old conjecture (`twin prime problem') says $\exists \infty$ many $n$ with $\hyperlink{def:pn}{p_{n+1}} = p_n + 2$.
Quite recently: it has been proved there is a constant $C$ such that for infinitely many $n$, $p_{n+1} \leq p_n + C$.
The best known such constant is $C=246$, from the Polymath project.

\textbf{Big gaps}: By the \hyperlink{thm:pnt}{PNT}, at least $\log p_n$ infinitely often.

We will prove:
\begin{thm}[Bertrand's postulate]\hypertarget{thm:bert}
    $p_{n+1} \leq 2 p_n$, there is always a prime between $N$ and $2N$.
\end{thm}

Analytic number theory in fact shows that for $n$ sufficiently large, $p_{n+1} - p_n \leq p_n^{0.525}$.
In the other direction, there are infinitely many $n$ such that
\begin{equation*}
    p_{n+1} - p_n > c \frac{\log p_n \log \log p_n \log \log \log \log p_n}{\log \log \log p_n}
\end{equation*}
(and $(\log p_n)^2$ is conjectured).

\begin{nthm}\label{thm:5.2} \leavevmode
    \begin{enumerate}[label=(\roman*)]
        \item $\sum_{p \text{ prime}} \frac{1}{p}$ is divergent
        \item $\prod_{p \text{ prime}} \left(1 - \frac{1}{p}\right)^{-1}$ is divergent i.e. $\prod_{p \leq x} \left(1 - \frac{1}{p}\right)^{-1} \to \infty$ as $x \to \infty$.
    \end{enumerate}
\end{nthm}

\begin{proof}
    First prove (ii)
    \begin{equation*}
        \prod_{p \leq x} \left(1 - \frac{1}{p}\right)^{-1} = \prod_{p \leq x} \left(1 + \frac{1}{p} + \frac{1}{p^2} + \dotsc\right) \geq \sum_{n \leq x} \frac{1}{n}.
    \end{equation*}
    If $n = p_1^{e_1} \dotsm p_k^{e_k}$, all $p_i \leq x$ then $\frac{1}{n} = \frac{1}{p_1^{e_1}} \dotsm \frac{1}{p_k^{e_k}}$ occurs in the product and all terms $>0$.
    So as $\sum \frac{1}{n} \to \infty$, the product $\to \infty$ as $x \to \infty$.

    For (i) take logarithms of this
    \begin{align*}
        \log \prod_{p \leq x} \left(1 - \frac{1}{p}\right)^{-1} &= \sum_{p \leq x} -\log\left(1 - \frac{1}{p}\right) \\
                                                     &= \sum_{p \leq x} \left(\frac{1}{p} + \frac{1}{2p^2} + \frac{1}{3p^3} + \dotsb\right) \\
                                                     &= \sum_{p \leq x} \frac{1}{p} + R_x \\
        R_x = \sum_{p \leq x} \left(\frac{1}{2p^2} + \frac{1}{3p^3} + \dotsb\right) &\leq \sum_{p \leq x} \left(\frac{1}{p^2} + \frac{1}{p^3} + \dotsb\right) \\
                                                                         &= \sum_{p \leq x} \frac{1}{p(p-1)} \\
                                                                         &\leq \sum_{m \geq 2} \frac{1}{m(m-1)} = 1.
    \end{align*}
    As $\prod_{p \leq x} \left(1 - \frac{1}{p}\right)^{-1} \to \infty$, so does $\log \left(\prod_{p \leq x} (1 - \frac{1}{p})^{-1}\right)$ and so does $\sum_{p \leq x} \frac{1}{p}$.
\end{proof}

\hypertarget{def:zeta}To take these ideas further, Riemann introduced the Riemann $\zeta$-function for complex variables
\begin{equation*}
    \zeta(s) = \sum_{n = 1}^\infty \frac{1}{n^s}
\end{equation*}
(previously considered by Euler for real $s > 1$).

\begin{nprop}\label{prop:5.3}
    The series converges absolutely iff $\Re(s) > 1$.
\end{nprop}

\begin{proof}
    Let $s = \sigma + i t$, $\sigma,t \in \R$.  Then
    \begin{equation*}
        \abs{\frac{1}{n^s}} = \abs{\frac{1}{e^{\log n (\sigma + i t)}}} = \frac{1}{n^\sigma}.
    \end{equation*}
    So the series is absolutely convergent $\iff \sum_{n \geq 1} \frac{1}{n^\sigma}$ converges $\iff \sigma > 1$.
\end{proof}

By complex analysis and uniform convergence $\implies \hyperlink{def:zeta}{\zeta(s)}$ is an analytic function of $s$ for $\Re(s) > 1$.
What has $\zeta$ got to do with primes?

\begin{nthm}\label{thm:5.4}\leavevmode
    \begin{enumerate}[label=(\roman*)]
        \item $\hyperlink{def:zeta}{\zeta(s)} = \prod_{p \text{ prime}} (1 - \frac{1}{p^s})^{-1}$ - the `Euler product' ($\Re(s) > 1$).
        \item $\zeta(s) \neq 0$ if $\Re(s) > 1$.
    \end{enumerate}
\end{nthm}

% Lecture 15

\begin{proof}\leavevmode
    \begin{enumerate}[label=(\roman*)]
        \item The aim is to show
            \begin{equation*}
                \prod_{p \leq x} \left(1 - \frac{1}{p^s}\right)^{-1} \to \hyperlink{def:zeta}{\zeta(s)} \text{ as } x \to \infty.
            \end{equation*}
            So,
            \begin{align*}
                \zeta(s) - \prod_{p \leq x} \left(1 - \frac{1}{p^s}\right)^{-1} &= \sum_{n \geq 1} n^{-s} - \prod_{p \leq x} (1 + p^{-s} + p^{-2s} + \dotsb) \\
                                                                                &= \sum_{n \in \eta_x} n^{-s}, \\
                \text{where } \eta_x &= \set{n \geq 1 | \text{at least one prime factor of $n$ is $> x$}}
            \end{align*}
            because \begin{equation*}\prod_{p \leq x} (1 + p^{-s} + p^{-2s} + \dotsb) = \sum_{\mathclap{\substack{n \text{ product}\\\text{of primes}\\\leq x}}} n^{-s}\end{equation*} by unique factorisation.
            So
            \begin{align*}
                \abs{\zeta(s) - \prod_{p \leq x} \left(1 - \frac{1}{p^s}\right)^{-1}} &\leq \sum_{n \leq \eta_x} n^{-\sigma} \tag{$\sigma = \Re(s) > 1$} \\
                                                                                      &\leq \sum_{n > x} n^{-\sigma} \to 0 \text{ as } x \to \infty \text{ as } \sigma > 1.
            \end{align*}
        \item
            \begin{align*}
                \prod_{p \leq x} \left(1 - \frac{1}{p^s}\right) \cdot \zeta(s) &= \prod_{p > x} \left(1 - \frac{1}{p^s}\right)^{-1} \text{ by part (i)} \\
                                                                               &= 1 + \sum_{\mathclap{\substack{n \text{ s.t.} \\ \text{all } p \mid n \\\text{ satisfy } p > x}}} n^{-s} \to 1 \text{ as } x \to \infty
            \end{align*}
            so
            \begin{align*}
                \abs{\prod_{p \leq x} \left(1 - \frac{1}{p^s}\right) \zeta(s)} &\geq 1 - \sum_{n > x} n^{-\sigma} > 0 \text{ if $x$ is large enough} \\
                                                                               &\implies \zeta(s) \neq 0. \qedhere
            \end{align*}
    \end{enumerate}
\end{proof}

\begin{nthm}\label{thm:5.5}
    $\hyperlink{def:zeta}{\zeta(s)} - \frac{1}{s-1}$ extends to an analytic function on $\{\Re(s) > 0\}$ by analytic continuation.
\end{nthm}
(As $s \to 1$, the series representing $\zeta(s)$ becomes divergent, and we would like to subtract off the divergence. $\int_1^\infty \frac{dx}{x^{s-1}} = \frac{1}{s-1}$.)

\begin{proof}
    Suppose $\Re(s) > 2$ for the moment.
    \begin{align*}
        \hyperlink{def:zeta}{\zeta(s)} = \sum_{n \geq 1} \frac{1}{n^s} &= \sum_{n \geq 1} \left(\frac{n}{n^s} - \frac{n-1}{n^s}\right) = \sum_{n \geq 1} \frac{n}{n^s} - \sum_{n \geq 2} \frac{n-1}{n^s} \\
                                                 &= \sum_{n \geq 1} \frac{n}{n^s} = \sum_{n \geq 1} \frac{n}{(n+1)^s} = \sum_{n \geq 1} n \left(\frac{1}{n^s} - \frac{1}{(n+1)^s}\right) \\
                                                 &= \sum_{n \geq 1} n \int_n^{n+1} s \frac{dx}{x^{s+1}} \\
        \shortintertext{since}
        \int_a^b \frac{dx}{x^s} &= \left[- \frac{x^{1-s}}{s-1}\right]_a^b \\
                                &= \frac{1}{s-1}\left(\frac{1}{a^{s-1}} - \frac{1}{b^{s-1}}\right)
    \end{align*}
    If $n \leq x < n+1$ then $n = \floor{x}$.
    \begin{align*}
        &= s \sum_{n \geq 1} \int_n^{n+1} \frac{\floor{x}}{x^{s+1}} \, dx = s \int_1^\infty \frac{\floor{x}}{x^{s+1}} \, dx = s \int_1^\infty \frac{x}{x^{s+1}} - \frac{x - \floor{x}}{x^{s+1}} \, dx \\
        &= \underbracket{\frac{s}{s-1}}_{= \frac{1}{s-1} + 1} - s \int_1^\infty \frac{x - \floor{x}}{x^{s+1}} \, dx
    \end{align*}
    So $\sigma(s) - \frac{1}{s-1} = 1 - s \int_1^\infty \frac{x - \floor{x}}{x^{s+1}} \, dx$.
    As $0 \leq x - \floor{x} < 1$, the integral converges for $\Re(s+1) > 1$, i.e. $\Re(s) > 0$ and by complex analysis represents an analytic function there.
\end{proof}

\begin{remark}\leavevmode
    \begin{enumerate}[label=(\roman*)]
        \item In fact (using a more subtle integral) can show that $\hyperlink{def:zeta}{\zeta(s)} - \frac{1}{s-1}$ is analytic $\forall s \in \C$ and $\zeta(s)$ satisfies an interesting identity
            \begin{align*}
                \xi(s) &\coloneqq \pi^{-\frac{s}{2}} \Gamma\left(\frac{s}{2}\right) \zeta(s) \\
                       &=\xi(1-s)
            \end{align*}
            where $\Gamma$ is the function which interpolates factorial: $\Gamma(s) = \int_0^\infty e^{-y} y^{s-1} \, dy$.
        \item A key ingredient in the prime number theorem is that $\zeta(s) \neq 0$ if $s = 1 + it$, $t \neq 0$, (can't get this from the infinite product).
    \end{enumerate}
\end{remark}

We will say a little more about series of the form $\sum_{n \geq 1} a_n n^{-s}$ (Dirichlet series).
A useful tool for manipulating these (and for other purposes) is the M\"obius function.

Recall \cref{lem:2.4}:
\begin{manual}{Lemma 2.4}
    Let $f$ be a \hyperlink{def:multiplicativeFunction}{multiplicative function}. Then so is $g$, defined by \begin{equation*} g(n) = \sum_{d \mid n} f(d) \end{equation*}
\end{manual}
How can we recover $f$ from $g$?
\begin{eg}
    Try an example:
    \begin{align*}
        g(6) &= f(1) + f(2) + f(3) + f(6) \\
        g(3) &= f(1) + f(3) \\
        g(2) &= f(1) + f(2) \\
        g(1) &= f(1) \\
        \implies f(6) = g(6) &- g(2) - g(3) + g(1)
    \end{align*}
    This obviously works in general!
\end{eg}

\begin{defi}[M\"obius function]\hypertarget{def:mu}
    The \textbf{M\"obius function} $\mu: \mathbb{N} \to \{0, \pm 1\}$ is given by
    \begin{align*}
        \mu(n) =
        \begin{cases*}
            1 & $n = 1$ \\
            (-1)^k & $n = p_1 \dotsm p_k$ is a product of $k$ distinct primes \\
            0 & otherwise (divisible by a square $>$ 1)
        \end{cases*}
    \end{align*}
\end{defi}

\begin{ex}
    \hyperlink{def:mu}{$\mu$} is a \hyperlink{def:multiplicativeFunction}{multiplicative function}.
\end{ex}
Apply \cref{lem:2.4} to $\mu$, let $\nu(n) = \sum_{d \mid n} \hyperlink{def:mu}{\mu}(d)$.
Then $\nu$ is a \hyperlink{def:multiplicativeFunction}{multiplicative function}.  Now
\begin{align*}
    \nu(p^k) &= \mu(1) + \mu(p) + \dotsb + \mu(p^k) \\
             &=
    \begin{cases*}
        \mu(1) = 1 & if $k=0$ \\
        \mu(1) + \mu(p) = 0 & if $k=1$ \\
        0 & if $k>1$.
    \end{cases*}
\end{align*}
So by multiplicativity
\begin{equation*}
    \nu(n) =
    \begin{cases*}
        1 & if $n = 1$ \\
        0 & if $n = 0$.
    \end{cases*}
\end{equation*}

\begin{nprop}[M\"obius inversion formula]\label{prop:5.6}
    Let $f: \N \to \C$ be any function, and $g(n) = \sum_{d \mid n} f(d)$.
    Then
    \begin{equation*}
        f(n) = \sum_{d \mid n} \hyperlink{def:mu}{\mu(d)} g\!\left(\frac{n}{d}\right) = \sum_{d \mid n} \mu\!\left(\frac{n}{d}\right) g(d).
    \end{equation*}
\end{nprop}

\begin{proof}
    \begin{align*}
        \sum_{d \mid n} \hyperlink{def:mu}{\mu(d)} g\!\left(\frac{n}{d}\right) &= \sum_{d \mid n} \mu(d) \sum_{e \mid \frac{n}{d}} f(e) \\
                                              &= \sum_{e \mid n} f(e) \underbracket{\sum_{d \mid \frac{n}{e}} \mu(d)}_{\nu(\frac{n}{e})} = f(n). \qedhere
    \end{align*}
\end{proof}

% Lecture 16
\begin{defi}[Dirichlet series]\hypertarget{def:dirichlet}
    The series
    \begin{equation*}
        \sum_{n \geq 1} \frac{a_n}{n^s}
    \end{equation*}
    for $s$ a (complex) variable is called a \textbf{Dirichlet series}.
\end{defi}
This is absolutely convergent if $\abs{a_n} \leq A n^k$ for some $k$ and $\Re(s) > k+1$.
We can take products of \hyperlink{def:dirichlet}{Dirichlet series}
\begin{align*}
    \sum_{m \geq 1} \frac{a_m}{m^s} \sum_{n \geq 1} \frac{b_n}{n^s} &= \sum_{m,n\geq 1} \frac{a_m b_n}{(mn)^s} = \sum_{N \geq 1} \frac{c_N}{N^s}, \qquad N=mn \\
    \text{where } c_N &= \sum_{d \mid N} a_d b_{\frac{N}{d}}
\end{align*}

\begin{eg}
    \begin{equation*}
        \hyperlink{def:zeta}{\zeta(s-1)} \zeta(s) = \left(\sum_{n \geq 1} \frac{n}{n^s}\right)\left(\sum_{n \geq 1} \frac{1}{n^s}\right) = \sum_{n \geq 1} \left(\sum_{d \mid n} d\right) \frac{1}{n^s} = \sum_{n \geq 1} \frac{\hyperlink{def:sigma}{\sigma(n)}}{n^s}
    \end{equation*}
    where $\hyperlink{def:sigma}{\sigma(n) = \sum_{d \mid n} d}$.
\end{eg}

A Dirichlet series related to primes:
\begin{manual}{Theorem 5.5a}\label{thm:5.5a}
    \begin{gather*}
        -\frac{\zeta'(s)}{\hyperlink{def:zeta}{\zeta(s)}} = \sum_{n \geq 1} \Lambda(n) n^{-s} = \frac{\log 2}{2^s} + \frac{\log 3}{3^s} + \frac{\log 2}{4^s} + \frac{\log 5}{5^s} + \frac{\log 7}{7^s} + \dotsb \\
        \text{where } \Lambda(n) =
        \begin{cases*}
            \log p & $n = p^k$, $p$ prime \\
            0 & otherwise
        \end{cases*}
        \tag{von Mangoldt function}
    \end{gather*}
\end{manual}

\begin{proof}
    Assume $s > 1$ is real (for complex $s$, same follows by analytic continuation).
    \begin{align*}
        -\frac{\zeta'(s)}{\zeta(s)} = - \frac{d}{ds} \log \zeta(s) &= - \frac{d}{ds} \sum_{p \text{ prime}} \log\left(\frac{1}{1 - p^{-s}}\right) \tag{\Cref{thm:5.4}} \\
                                                                   &= \sum_{\mathclap{p \text{ prime}}} \frac{(\log p) p^{-s}} {1 - p^{-s}} \\
                                                                   &= \sum_{\mathclap{p \text{ prime}}} \log p (p^{-s} + p^{-2s} + \dotsb) \\
                                                                   &= \sum_{n \geq 1} \Lambda(n) n^{-s}.
    \end{align*}
    (Exchange of $\frac{d}{ds}$ and $\sum$ is justified by uniform convergence.)
\end{proof}

Define $\Psi(x) = \sum_{n \leq x} \Lambda(n)$.
It is not hard to show that
\begin{equation*}
    \hyperlink{def:pi}{\pi(x)} \sim \frac{\Psi(x)}{\log x}
\end{equation*}
so the prime number theorem is equivalent to $\Psi(x) \sim x$.
This is proved by integrating $\frac{x^{s+1}}{s(s+1)} \frac{\zeta'(s)}{\zeta(s)}$ over suitable contours (the non-vanishing of $\zeta(s)$ for $\Re s = 1$ enters here).

\begin{thm}[Dirichlet's theorem]\hypertarget{thm:dirichlet}
    Let $a, N \in \Z$, $N > 1$, $\hyperlink{def:gcd}{(a,N)}=1$.
    There are infinitely many primes $\equiv a \pmod{N}$ (we have seen this already for $N=4$, $a=1$ and $a=-1$) i.e. the arithmetic progression $\{a, a + N, a + 2N, \dotsc\}$ contains $\infty$ many primes.
\end{thm}

In fact, the proportion of primes in such an arithmetic progression is $\frac{1}{\varphi(N)}$.
\begin{proof}[Sketch proof]
    The proof involves \hyperlink{def:dirichlet}{Dirichlet series}. Take this series
    \begin{equation*}
        F_{a,N}(s) = \sum_{p \equiv a \bmod{N}} \frac{1}{p^s}
    \end{equation*}
    and show it has infinitely many terms. It is enough to show that the series diverges for $s=1$.
    To get a handle on $F_{a,N}(s)$, write it as a linear combination of Dirichlet series of the form $\sum_p \frac{\chi(p)}{p^s}$, where $\chi(p)$ is a multiplicative function.
\end{proof}

\begin{defi}[Dirichlet character]\hypertarget{def:char}
    A \textbf{Dirichlet character} mod $N$ is a function $\chi: \N \to \C$ such that
    \begin{enumerate}[label=(\roman*)]
        \item $\chi(1)=1$, $\chi(n) = 0$ if $(N, n) > 1$.
        \item $\chi(n+N) = \chi(n)$ periodic mod $N$.
        \item $\chi(mn) = \chi(m)\chi(n)$ $\forall m,n$.
    \end{enumerate}
\end{defi}
So $\chi$ is just a homomorphism $(\Z/n\Z)^\times \to \mathbb{C}^\times$ extended to all $n$ by $\chi(n) = 0$ if $(n, N)>1$.
An example is given by the Legendre/Jacobi symbol.

\begin{fact}
    The function
    \begin{equation*}
        f(n) =
        \begin{cases}
            1 & \text{if } n\equiv a \pmod{N} \\
            0 & \text{if } n\not\equiv a \pmod{N}
        \end{cases}
    \end{equation*}
    for $(a,N)=1$ is a linear combination of \hyperlink{def:char}{Dirichlet characters} mod $N$.
\end{fact}

\begin{eg}
    For $N=3$, $\chi_p: \N \to \C$:
    \begin{align*}
        \hyperlink{def:char}{\chi_0(n)} &=
        \begin{cases}
            1 & \text{if } (n, 3) = 1 \\
            0 & \text{otherwise}
        \end{cases} \\
        \chi_1(n) &=
        \begin{cases}
            1 & n \equiv 1 \pmod{3} \\
            -1 & n \equiv -1 \pmod{3} \\
            0 & (n,3) \neq 1
        \end{cases} \\
        \frac{\chi_0(n) \pm \chi_1(n)}{2} &=
        \begin{cases}
            1 & n \equiv \pm 1 \pmod{3} \\
            0 & \text{otherwise}
        \end{cases} \\
    \end{align*}
\end{eg}

Analytic facts about $L(\chi, s) = \sum_{n \geq 1} \chi(n) n^{-s}$ then can be used to prove \hyperlink{thm:dirichlet}{Dirichlet's} theorem.

\subsection{Elementary methods for primes}
\textbf{Sieve of Eratosthenes}: if you delete from $\{2,3,\dotsc, X\}$ all multiples of primes $\leq \sqrt{X}$, you are left with $\set{p \text{ primes} | \sqrt{X} \leq p \leq X}$.

\begin{manual}{Proposition 5.6a}[Legendre's formula]\label{prop:5.6a}
    Let $x \geq 1$ and write $P = \prod_{p \leq \sqrt{X}} p$ product of all primes $\leq \sqrt{X}$.
    Then
    \begin{equation*}
        \hyperlink{def:pi}{\pi(X)} - \pi(\sqrt{X}) + 1
        = \# \set{1 \leq n \leq X | \hyperlink{def:gcd}{(n,P)} = 1}
        = \sum_{d \mid P} \hyperlink{def:mu}{\mu(d)} \floor*{\frac{X}{d}}.
    \end{equation*}
\end{manual}

\begin{proof}
    \begin{equation*}
        \set{1 \leq n \leq X | (n, P) = 1} = \{1\} \cup \set{p | \sqrt{X} \leq p \leq X}
    \end{equation*}
    hence first equality. Recall
    \begin{gather*}
        \sum_{d \mid n} \hyperlink{def:mu}{\mu(d)} =
        \begin{cases}
            1 & \text{if } n = 1 \\
            0 & \text{if } n > 1
        \end{cases}
    \end{gather*}
        so
    \begin{align*}
        \# \set{1 \leq n \leq X | (n, P) = 1} &= \sum_{1 \leq n \leq X} \left[ \sum_{d \mid (n, P)} \mu(d)\right] \\
                                              &= \sum_{d \mid P} \mu(d) \sum_{\mathclap{\substack{1 \leq n \leq X \\ n \equiv 0 \bmod{d}}}} 1 \\
                                              &= \sum_{d \mid P} \mu(d) \floor*{\frac{X}{d}}. \qedhere
    \end{align*}
\end{proof}

\subsection{Divisibility of special numbers}
\begin{defi}[Valuation]\hypertarget{def:nu}
    Let $n \geq 1$, $p$ prime.
    Let $\nu_p(n)=$ exponent of $p$ in factorisation of $n$ (\textbf{$p$-adic valuation} of $n$).
\end{defi}

So $n = p^{\hyperlink{def:nu}{\nu_p}(n)} n_0$ where $\hyperlink{def:gcd}{(n_0, p)} = 1$.
In addition, $\nu_p(mn) = \nu_p(m) + \nu_p(n)$.

\begin{eg}
    \begin{equation*}
        \binom{2n}{n} = N = \frac{2n (2n-1) \dotsm (n+1)}{n (n-1) \dotsm 1}
    \end{equation*}
    If $n < p \leq 2n$, $p$ exactly divides numerator, and doesn't divide the denominator.
    So $\hyperlink{def:nu}{\nu_p(n)} = 1$ $\forall p \in (n, 2n]$.

    On the other hand $N \leq \sum_r \binom{2n}{r} = 2^{2n}$, so $\prod_{n < p \leq 2n} p \leq N \leq 2^{2n}$, giving an estimate and upper bound for $\pi(x)$.
    A similar argument also gives a lower bound if more careful.
\end{eg}

% Lecture 17
\begin{nlemma}\label{lem:5.7}
    Let $N = \binom{2n}{n}$, $n \geq 1$. Then
    \begin{enumerate}[label=(\roman*)]
        \item $\frac{2^{2n}}{2n} \leq N \leq 2^{2n}$
        \item For $p$ prime, $n < p \leq 2n \implies \hyperlink{def:nu}{\nu_p(N)} = 1$
        \item $\frac{2n}{3} < p \leq n \implies (N, p) = 1$
        \item $p^k \mid N \implies p^k \leq 2n$ for any prime power $p^k$.
    \end{enumerate}
\end{nlemma}

\begin{proof}
    \leavevmode
    \begin{enumerate}[label=(\roman*)]
        \item
            \begin{equation*}
                N < \sum_{m=0}^{2n} \binom{2n}{m} = (1+1)^{2n} = 2^{2n} = 2 + \sum_{\mathclap{1 \leq m \leq 2n-1}} \binom{2n}{m} \leq 2 + (2n-1) N \leq 2n N
            \end{equation*}
        \item $n < p \leq 2n < 2p \implies p$ divides numerator $2n \dotsm (n+1)$ exactly but not denominator $n (n-1) \dotsm 1$ of $N$.
        \item $p \in (\frac{2}{3}n, n] \Rightarrow p \leq n < 2p \leq 2n < 3p \Rightarrow p$ divides both numerator and denominator exactly $\Rightarrow \hyperlink{def:gcd}{(p, N)} = 1$.
        \item For the last part we need the following formula, proved on Example Sheet 3
            \begin{equation*}
                \nu_p(n!) = \sum_{i \geq 1} \floor*{\frac{n}{p^i}} = \floor*{\frac{n}{p}} + \floor*{\frac{n}{p^2}} + \dotsb
            \end{equation*}

            \begin{lemma}
                If $x \geq 0$ then $\floor{2x} - 2 \floor{x} \in \{0, 1\}$.
            \end{lemma}
            \begin{proof}
                $x = n + \alpha$ with $0 \leq \alpha < 1$.
                Then, LHS = $\floor{2\alpha} - 2 \floor{\alpha} = \begin{cases}0 & 0 \leq \alpha < \frac{1}{2} \\ 1 & \frac{1}{2} \leq \alpha < 1\end{cases}.$
            \end{proof}
            So,
            \begin{align*}
                \hyperlink{def:nu}{\nu_p(N)} &= \nu_p((2n)!) - 2 \nu_p(n!) \\
                         &= \sum_{i \geq 1} \left(\floor*{\frac{2n}{p^i}} - 2 \floor*{\frac{n}{p^i}}\right) \\
                \shortintertext{and if $p^k > 2n$}
                &= \sum_{1 \leq i \leq k-1} \left(\floor*{\frac{2n}{p^i}} - 2 \floor*{\frac{n}{p^i}}\right) \leq k-1 \quad \text{so } \nu_p(N) = k \Rightarrow p^k \leq 2n. \qedhere
            \end{align*}
    \end{enumerate}
\end{proof}

Use this to prove:
\begin{nthm}[Tchebyshev's theorem]\label{thm:5.8}
    $\exists c_2 > c_1 > 0$ such that $\forall x \geq 3$,
    \begin{equation*}c_1 \frac{x}{\log x} \leq \pi(x) \leq c_2 \frac{x}{\log x}\end{equation*}
    We will show $c_1 = \frac{\log 2}{2} = 0.346...$ and $c_2 = 6 \log 2 = 4.158...$.
\end{nthm}

\begin{proof}
    \textbf{Upper bound:} First claim $\hyperlink{def:pi}{\pi(2^k)} \leq 3 \frac{2^k}{k}$.
    True for $k \leq 6$ as $\pi(x) \leq \frac{x}{2}$ if $x$ even $\geq 4$.
    By \cref{lem:5.7} (i) and (ii),
    \begin{gather*}
        n^{\pi(2n) - \pi(n)} \leq \prod_{n < p \leq 2n} p \overset{\text{(ii)}}{\leq} N \overset{\text{(i)}}{\leq} 2^{2n} \\
        \implies \pi(2n) - \pi(n) \leq 2 \log 2 \cdot \frac{n}{\log n}
    \end{gather*}
    \begin{align*}
        \implies \pi(2^{k+1}) \leq \pi(2^k) + \frac{2^{k+1}}{k} &\leq 3 \frac{2^k}{k} + \frac{2^{k+1}}{k} \tag{induction on $k$} \\
                                                                &= \frac{5 \cdot 2^{k+1}}{2k} \leq \frac{3}{k+1} 2^{k+1} \tag{$k \geq 5$}
    \end{align*}
    proving the claim.

    Observe $\frac{x}{\log x}$ is monotonically increasing for $x \geq e$ (check by differentiating).
    So if
    \begin{align*}
        4 \leq 2^k < x < 2^{k+1} \implies \pi(x) \leq \pi(2^{k+1}) &\leq 6 \cdot \frac{2^k}{k+1} < 6 \cdot \frac{2^k}{k} \\
                                                                   &= 6 \log 2 \cdot \frac{2^k}{\log 2^k} \leq 6 \log 2 \cdot \frac{x}{\log x}.
    \end{align*}

    \textbf{Lower bound:} \cref{lem:5.7}(iv) $\implies \forall p, p^{\nu_p(N)} \leq 2n$ i.e.\ $\nu_p(N) \leq \frac{\log 2n}{\log p}$ (and $=0$ if $p>2n$).
    Now $\frac{2^{2n}}{2n} \leq N$ so
    \begin{align*}
        n \log 2 - \log 2n \leq \log N &= \sum_{p \leq 2n} \nu_p(N) \log p \tag{as $N = \prod p^{\nu_p(N)}$} \\
                                       &\leq \sum_{p \leq 2n} \log(2n) = \pi(2n) \log(2n) \\
        \implies \pi(2n) &\geq \frac{2n \log 2}{\log 2n} - 1
    \end{align*}
    So if $2n \leq x < 2n+2$
    \begin{align*}
        \pi(x) \geq \pi(2n) \geq \log 2 \cdot \frac{2n}{\log 2n} - 1 &\geq \log 2 \cdot \frac{x-2}{\log x} - 1 \\
                                                                     &= \log 2 \cdot \frac{x}{\log x} - \left(\frac{2\log 2}{\log x} + 1\right) \\
                                                                     &\geq \frac{1}{2} \log 2 \frac{x}{\log x} \quad \text{if } x \geq 16.
    \end{align*}
    If $3 \leq x \leq 16$, $\frac{1}{2} \log 2 \cdot \frac{x}{\log x} < \frac{16}{2 \cdot 4} = 2 \leq \pi(x)$. \qedhere
\end{proof}
Tchebyshev actually showed
\begin{equation*}
    0.92 < \frac{\hyperlink{def:pi}{\pi(x)}}{{x}/{\log x}} < 1.11 \text{ for $x$ sufficiently large.}
\end{equation*}

\begin{nthm}[Bertrand's postulate]\label{thm:5.9}
    $\forall n > 1$ $\exists$ prime $p$ with $n < p < 2n$.
\end{nthm}

First proved by Tchebyshev, this proof by Erd\H{o}s.
\begin{proof}
    Claim: Let $\hypertarget{def:Theta}{\Theta(x)} \coloneqq \prod_{p \leq x} p$.
    Then $\Theta(x) \leq 4^x \quad \forall x \geq 1$ (proof deferred).

    Suppose $\nexists p \in (n, 2n)$. Then by \cref{lem:5.7}, if $p \mid N = \binom{2n}{n}$, $p \leq \frac{2n}{3}$.
    Write $N = N_1 N_2$, where
    \begin{align*}
        N_1 &= \prod_{\mathclap{\hyperlink{def:nu}{\nu_p(N)} = 1}} p \leq \hyperlink{def:Theta}{\Theta}\left(\frac{2n}{3}\right) \leq 4^{2n/3} \\
        N_2 &= \prod_{\mathclap{\nu_p(N) \geq 2}} p^{\nu_p(N)} \leq (2n)^{\sqrt{2n}}
    \end{align*}
    since  $p^2 \leq p^{\nu_p(N)} \leq 2n$  by \cref{lem:5.7}(iv), so $p \leq \sqrt{2n}$.
    Therefore
    \begin{equation*}
        \frac{2^{2n}}{2n} \leq N = N_1 N_2 \leq 4^{2n/3} \cdot (2n)^{\sqrt{2n}}
    \end{equation*}
    i.e. $2^{2n/3} \leq (2n)^{1 + \sqrt{2n}}$ or $\frac{\log 2}{3} \cdot 2n \leq (1 + \sqrt{2n}) \log 2n$.

    This is false for $n \geq 500$, giving the required contradiction:
    \begin{equation*}
        \frac{d}{dx} \left(\frac{\log 2}{3} x - (1 + \sqrt{x}) \log x\right) = \frac{\log 2}{3} - \frac{1+\sqrt{x}}{x} - \frac{\log x}{2 \sqrt{x}} > 0 \text{ if } x \geq 300
    \end{equation*}
    For small $n$, $2,3,5,7,11,19,37,73,137,277,547$ fills the gap.
\end{proof}

% Lecture 18
\begin{prop}
    Let $\Theta(x) = \prod_{p \leq x} p$. Then $\Theta(x) \leq 4^x \quad \forall x \geq 1$.
\end{prop}

\begin{proof}
    Note that $
    2 \binom{2n+1}{n} = \binom{2n+1}{n} + \binom{2n+1}{n+1} \leq (1+1)^{2n+1} = 2^{2n+1}$.

    Also if $n+2 < p \leq 2n+1$ then $p \mid \binom{2n+1}{n+1}$ so
    \begin{equation*}
        \prod_{n+2 \leq p \leq 2n+1} p\; \left|\; \binom{2n+1}{n+1} \leq 4^n \right.
    \end{equation*}
    So if $n \geq 1$,
    \begin{align*}
        \Theta(2n+2) = \Theta(2n+1) = \prod_{p \leq n+1} p \prod_{n+2 \leq p \leq 2n+1} p &\leq \Theta(n+1) \cdot 4^n \\
                                                                                          &\leq 4^{n+1} \cdot 4^n \text{ (induction on $n$)} \\
                                                                                          &=4^{2n+1}.
    \end{align*}
    So, for all integers $n \geq 1$, $\Theta(n) \leq 4^n$ and $\Theta(x) = \Theta(\floor{x})$.
\end{proof}

\clearpage
\section{Continued Fractions}
Consider the following problem: $\theta \in \R$, what are the `best' rational approximations to $\Theta$?
\begin{align*}
    \abs{\pi - \frac{314159}{100000}} &< 3 \times 10^{-6} \\
    \abs{\pi - \frac{355}{113}} &< 3 \times 10^{-7}
\end{align*}
We would like a systematic way to get such approximations (where the error is small compared with the denominator).

\subsection{Continued Fraction algorithm}
\hypertarget{def:cfa}Let $\theta \in \R$. Define a (possible finite) sequence of integers $a_0, a_1, \dotsc, $ with $a_n \geq 1$ for $n \geq 1$ as follows.

\textbf{Step 0}
$a_0 = \floor{\theta}$. If $a_0 = \theta$, stop. Otherwise $0 < \theta - a_0 < 1$. \\
Let $\theta_1 = \frac{1}{\theta - a_0} > 1$ so that $\theta = a_0 + \frac{1}{\theta_1}$.

\textbf{Step 1}
$a_1 = \floor{\theta_1}$. If $a_1 = \theta_1$, stop.  \\
Otherwise, let $\theta_2 = \frac{1}{\theta_1 - a_1} > 1$, so $\theta = a_0 + \frac{1}{a_1 + \frac{1}{\theta_2}}$.

Continue. If process stops at nth stage, i.e. $a_n = \theta_n$, then
\begin{equation*}
    \theta = a_0+\cfrac{1}{a_1 +\cfrac{1}{a_2 +\cfrac{1}{
      \begin{array}{@{}c@{}l@{}}
          a_3 + {}\\
          &\ddots\\
          & {}a_{n-1}+ \cfrac{1}{a_n}
      \end{array}
    }}}
\end{equation*}

\hypertarget{def:cfn}If it doesn't stop, for every n, $\theta = [a_0, \dotsc, a_{n-1}, \theta_n]$ in this notation.
We'll write $\theta=[a_0, a_1, \dotsc]$ called the continued fraction expansion (CF) of $\theta$ (shortly we'll make sense of the $=$ sign here).

The integers $a_0, a_1, \dotsc$ are the \textbf{partial quotients}.

\begin{eg}
    Take $\theta = \frac{59}{13}$.
    \begin{align*}
        \frac{59}{13} &= 4 + \frac{7}{13} & a_0 = 4&, \theta_1 = \frac{13}{7} \\
        \frac{13}{7} &= 1 + \frac{6}{7} & a_1 = 1&, \theta_2 = \frac{7}{6} \\
        \frac{7}{6} &= 1 + \frac{1}{6} & a_2 = 1&, \theta_3 = 6
    \end{align*}
    $a_3 = 6 = \theta_3$, so
    \begin{equation*}
        \frac{59}{13} = \hyperlink{def:cfn}{[4,1,1,6]} = 4 + \cfrac{1}{1 + \cfrac{1}{1 + \cfrac{1}{6}}}
    \end{equation*}
\end{eg}

Clearly if the \hyperlink{def:cfa}{continued fraction algorithm} for $\theta$ terminates, $\theta \in \Q$. Converse:
\begin{nprop}\label{prop:6.1}
    The \hyperlink{def:cfn}{continued fraction expansion} of $\theta$ terminates $\iff \theta \in \Q$.
\end{nprop}
\begin{proof}
    Let $\theta = \frac{b_0}{c_0}$, $\theta_i = \frac{b_i}{c_i}$, $b_i, c_i \in \Z$, $(b_i, c_i) = 1$ $c_i \geq 1$.
    If the \hyperlink{def:cfn}{continued fraction} doesn't terminate, as $\theta_i \geq 1$, we must have $\theta_i > 1$ i.e. $b_i > c_i$.
    \begin{equation*}
        \hypertarget{eq:cf1}\forall i \geq 1 \quad \theta_i = a_i + \frac{1}{\theta_{i+1}} \implies \frac{b_i}{c_i} = a_i + \frac{c_{i+1}}{b_{i+1}} \overset{(*)}{\implies} b_{i+1} = c_i < b_i
    \end{equation*}
    But $b_i$ is then a decreasing sequence of positive $i > 0$ integers, so terminates.
\end{proof}

\begin{remark}
    $(\hyperlink{eq:cf1}*)$ can be rewritten $b_i = a_i b_{i+1} + b_{i+2}$.
    So the sequence $(b_i)$ comes from applying Euclid's algorithm to $(b_0, b_1=c_0)$.
    For example, $\frac{59}{13} = \theta = \frac{b_0}{c_1}$,
    \begin{align*}
        59 &= {\color{red}4} \cdot 13 + 7 \\
        13 &= {\color{red}1} \cdot 7 + 6 \\
        7  &= {\color{red}1} \cdot 6 + 1 \\
        6  &= {\color{red}6} \cdot 1 + 0
    \end{align*}
    hence the terminology `partial quotient'.
\end{remark}

\begin{defi}[Convergents]\hypertarget{def:convs}
    Given $a_0, a_1, \dotsc, \in \Z$ $a_i \geq 1$ if $i \geq 1$ define sequence of integers $p_n, q_n$ $(n \geq 0)$ recursively as follows
    \begin{align*}
        p_0 &= a_0 & p_1 &= a_1 a_0 + 1 & p_n &= a_n p_{n-1} + p_{n-2} \\
        q_0 &= 1   & q_1 &= a_1         & q_n &= a_n q_{n-1} + q_{n-2} \quad \text{ if } n \geq 2.
    \end{align*}
    It is convenient also to define $p_{-1} = 1$, $q_{-1} = 0$ (so the recursion holds for $n \geq 1$).
    If $[a_0, a_1, \dotsc]$ is the \hyperlink{def:cfa}{CF expansion} of $\theta$, say $\frac{p_n}{q_n}$ are the \textbf{convergents} to $\theta$.

    As $a_i \geq 1$ if $i > 0$, $1 \leq q_1 < q_2 < q_3 < \dotsb$ is an increasing sequence of positive integers.
\end{defi}

\begin{nlemma}\label{lem:6.2}
    \leavevmode
    \begin{enumerate}[label=(\roman*)]
        \item $\forall n \geq 0 \quad \hyperlink{def:convs}{\frac{p_n}{q_n}} = \hyperlink{def:cfn}{[a_0, \dotsc, a_n]}$.
        \item Let $\beta > 0$ be real.
            \begin{equation*}
                \frac{\beta p_n + p_{n-1}}{\beta q_n + q_{n-1}} = [a_0, a_1, \dotsc, a_n, \beta]
            \end{equation*}
            and this number lies strictly between $\frac{p_n}{q_n}$ and $\frac{p_{n-1}}{q_{n-1}}$.
    \end{enumerate}
\end{nlemma}

\begin{proof}
    \leavevmode
    \begin{enumerate}[label=(\roman*)]
        \item If we put $\beta = a_{n+1}$ in (ii) we get LHS = $\frac{p_{n+1}}{q_{n+1}}$ by the \hyperlink{def:convs}{recursion formula}, giving the required formula (replacing $n$ with $n+1$).
        \item Induct on $n$. For $n=0$, $[a_0, \beta] = a_0 + \frac{1}{\beta} = \frac{\beta a_0 + 1}{\beta \cdot 1 + 0}$.

            Let $\gamma = a_n + \frac{1}{\beta}$.
            \begin{align*}
                [a_0, \dotsc, a_n, \beta] = [a_0, \dotsc, a_{n-1}, \gamma] &= \frac{\gamma p_{n-1} + p_{n-2}}{\gamma q_{n-1} + q_{n-2}} \\
                                                                           &= \frac{(a_n p_{n-1} + p_{n-2}) + \frac{1}{\beta} p_{n-1}}{(a_n q_{n-1} + q_{n-2}) + \frac{1}{\beta} q_{n-1}} \\
                                                                           &= \frac{\beta p_n + p_{n-1}} {\beta q_n + q_{n-1}}.
            \end{align*}

            For the last part, if $\frac{x}{y} < \frac{x'}{y'}$ for $x, x', y, y' \in \R$ and $y, y' > 0$ then
            \begin{equation*}
                \frac{x}{y} < \frac{x+x'}{y+y'} < \frac{x'}{y'}
            \end{equation*}
            (easy exercise), giving the required result. \qedhere
    \end{enumerate}
\end{proof}

% Lecture 19
If $\theta = \hyperlink{def:cfn}{[a_0, \dotsc, a_n]}$ is rational, then \cref{lem:6.2} $\implies \theta = \hyperlink{def:convs}{\frac{p_n}{q_n}}$.

\begin{nlemma}\label{lem:6.3}
    \leavevmode
    \begin{enumerate}[label=(\roman*)]
        \item $\forall n \geq 1$ (in fact, $n \geq 0$) $\hyperlink{def:convs}{p_n q_{n-1}} - p_{n-1} q_n = (-1)^{n-1}$
        \item $\forall n \geq 2$ (in fact, $n \geq 1$) $p_n q_{n-2} - p_{n-2} q_n = (-1)^n a_n$
    \end{enumerate}
\end{nlemma}

\begin{proof}\leavevmode
    \begin{enumerate}[label=(\roman*)]
        \item Induction on $n$: $n=0$ or $1$ true.
            Assume true for $n-1$. Then
            \begin{align*}
                p_n q_{n-1} - p_{n-1} q_n &= (a_n p_{n-1} + p_{n-2}) q_{n-1} - p_{n-1} (a_n q_{n-1} + q_{n-2}) \\
                                          &= -(p_{n-1} q_{n-2} - p_{n-2} q_{n-1}) = (-1)^{n-1}
            \end{align*}
            by induction.
        \item LHS:
            \begin{align*}
                (a_n p_{n-1} + p_{n-2}) q_{n-2} - (a_n q_{n-1} + q_{n-2}) p_{n-2} &= a_n (p_{n-1} q_{n-2} - p_{n-2} q_{n-1}) \\
                                                                                  &= (-1)^n a_n
            \end{align*}
            by (i). \qedhere
    \end{enumerate}
\end{proof}

\begin{remark}
    As a consequence,
    (i) $\Rightarrow \hyperlink{def:gcd}{(p_n, q_n)} = 1$ i.e. $\hyperlink{def:convs}{\frac{p_n}{q_n}}$ is in lowest terms and
    \begin{equation*}
        \frac{p_n}{q_n} - \frac{p_{n+1}}{q_{n+1}} = \frac{p_n q_{n+1} - p_{n+1} q_n}{q_n q_{n+1}} = \frac{(-1)^{n-1}}{q_n q_{n+1}}
    \end{equation*}

    From (ii),
    \begin{gather*}
        \frac{p_n}{q_n} - \frac{p_{n-2}}{q_{n-2}} = (-1)^n \frac{a_n}{q_n q_{n+2}} \\
        \Rightarrow \frac{p_0}{q_0} < \frac{p_2}{q_2} < \frac{p_4}{q_4} < \dotsb < \frac{p_5}{q_5} < \frac{p_3}{q_3} < \frac{p_1}{q_1}
    \end{gather*}
    and as $\frac{p_n}{q_n} - \frac{p_{n+1}}{q_{n+1}} \to 0$, $\frac{p_n}{q_n}$ converges.

    If $[a_0, a_1, \dotsc]$ is the \hyperlink{def:cfa}{CF expansion} of $\theta$ by \Cref{lem:6.2}(ii), $\theta = [a_0, \dotsc, a_n, \theta_{n+1}]$ lies between $\frac{p_n}{q_n}$ and $\frac{p_{n+1}}{q_{n+1}} \ \forall n$.
    This proves
\end{remark}

\begin{nthm}\label{thm:6.4}
    $\hyperlink{def:convs}{\frac{p_n}{q_n}} \to \theta$ as $n \to \infty$, and $\forall n \geq 0$
    \begin{equation*}
        \abs{\theta - \frac{p_n}{q_n}} < \frac{1}{q_n q_{n+1}} = \abs{\frac{p_n}{q_n} - \frac{p_{n+1}}{q_{n+1}}}.
    \end{equation*}
\end{nthm}

\begin{remark}
    This actually shows that the \hyperlink{def:cfn}{CF expansion} is a bijection
    \begin{equation*}
        \{ \theta \in \R \setminus \mathbb{Q}\} \longleftrightarrow \{ \text{sequences } a_0, a_1, \dotsc,\text{ where } a_n \in \Z, \ a_n \geq 1 \text{ for } n > 0\}
    \end{equation*}
\end{remark}

\subsection{Rational Approximations}
\begin{nthm}\label{thm:6.5}
    Let $\theta \in \R \setminus \Q$, $p, q \in \Z$, $0 < q < \hyperlink{def:convs}{q_{n+1}}$. Then
    \begin{equation*}
        \abs{q \theta - p} \geq \abs{q_n \theta - p_n}
    \end{equation*}
\end{nthm}

\begin{cor}
    If $p, q \in \Z$ and $\abs{\theta - \frac{p}{q}} < \abs{\theta - \hyperlink{def:convs}{\frac{p_n}{q_n}}}$ then $q > q_n$, so
    $\frac{p_n}{q_n}$ is the best approximation with denominator $\leq q_n$.
\end{cor}

\begin{proof}[Proof of corollary]
    If $q \leq q_n < \hyperlink{def:convs}{q_{n+1}}$, by \cref{thm:6.5} $\abs{\theta - \frac{p}{q}} \geq \frac{q}{q_n} \abs{\theta - \frac{p_n}{q_n}} \geq \abs{\theta - \frac{p_n}{q_n}}$.
\end{proof}

\begin{proof}[Proof of theorem]
    As $p_{n+1} q_n - p_n q_{n+1} = \pm 1$ $\exists u, v \in \Z$
    \begin{gather*}
        \begin{pmatrix} p_n & p_{n+1} \\ q_n & q_{n+1} \end{pmatrix}
        \begin{pmatrix} u \\ v \end{pmatrix} = \begin{pmatrix} p \\ q \end{pmatrix}
        \quad \text{ i.e. } \quad
        \begin{matrix}
            u p_n + v p_{n+1} &= p \\
            u q_n + v q_{n+1} &= q
        \end{matrix}
        \\
        \therefore q \theta - p = u(q_n \theta - p_n) + v (q_{n+1} \theta - p_{n+1})
    \end{gather*}
    If $v = 0$, then $u \geq 1$ so $\abs{q \theta - p} \geq u \abs{q_n \theta - p_n} \geq \abs{q_n \theta - p_n}$.
    So suppose $v \neq 0$, $0 < q < q_{n+1} \implies u \neq 0$ and $u, v$ have opposite signs.

    Now $q_n \theta - p_n$, $q_{n+1} \theta - p_{n+1}$ have opposite signs ($\theta$ lies between any two consecutive convergents).
    So $u (q_n \theta - p_n)$ and $v (q_{n+1} \theta - p_{n+1})$ have the same sign. Hence
    \begin{equation*}
        \abs{q \theta - p} = \abs{u (q_n \theta - p_n) + v (q_{n+1} \theta - p_{n+1})} \geq \abs{q_n \theta - p_n} \text{ as } u \neq 0. \qedhere
    \end{equation*}
\end{proof}

\begin{nthm}\label{thm:6.6}
    Let $\theta \in \R \setminus \Q$. Then
    \begin{enumerate}[label=(\roman*)]
        \item at least one of any pair of successive \hyperlink{def:convs}{convergents} satisfies $\abs{\theta - \frac{p}{q}} < \frac{1}{2 q^2}$.
        \item conversely if $\frac{p}{q} \in \Q$ satisfies (i) then $\frac{p}{q} = \frac{p_n}{q_n}$ for some $n$.
    \end{enumerate}
\end{nthm}

\begin{proof}
    \leavevmode
    \begin{enumerate}[label=(\roman*)]
        \item $\theta$ lies between $\frac{p_n}{q_n}$, $\frac{p_{n+1}}{q_{n+1}}$,
            \begin{equation*}
                \implies \abs{\theta - \frac{p_n}{q_n}} + \abs{\theta - \frac{p_{n+1}}{q_{n+1}}} = \abs{\frac{p_n}{q_n} - \frac{p_{n+1}}{q_{n+1}}} = \frac{1}{q_n q_{n+1}} < \frac{1}{2} \left(\frac{1}{q_n^2} + \frac{1}{q_{n+1}^2}\right)
            \end{equation*}
            (the inequality follows from AM-GM)
            so either $\abs{\theta - \frac{p_n}{q_n}} < \frac{1}{2 q_n^2}$ or $\abs{\theta - \frac{p_{n+1}}{q_{n+1}}} < \frac{1}{2 q_{n+1}^2}$
        \item Suppose $q \geq 1$, $\abs{\theta - \frac{p}{q}} < \frac{1}{2 q^2}$. $\exists n$ such that $q_n \leq q < q_{n+1}$. Show $\frac{p}{q} = \frac{p_n}{q_n}$:
            \begin{align*}
                \left|\frac{p}{q} - \frac{p_n}{q_n} \right| &\leq \abs{\theta - \frac{p}{q}} + \abs{\theta - \frac{p_n}{q_n}} \\
                \intertext{As $q < q_{n+1}$, \cref{thm:6.5} $\Rightarrow \abs{q \theta - p} \geq \abs{q_n \theta - p_n}$}
                &< \left(\frac{1}{q} + \frac{1}{q_n}\right) \frac{1}{2q}
            \end{align*}
            by the hypothesis on $\frac{p}{q}$.

            If $\frac{p}{q} \neq \frac{p_n}{q_n}$, LHS$ \geq \frac{1}{q q_n}$ so
            \begin{equation*}
                \left(\frac{1}{q} + \frac{1}{q_n}\right) \frac{1}{2q} > \frac{1}{q q_n} \implies q < q_n,
            \end{equation*}
            a contradiction. \qedhere
    \end{enumerate}
\end{proof}

\subsection*{Simplest irrationals}
The simplest irrationals are the quadratic surds $\sqrt{d}$, for $d>1$ not a square.
Their \hyperlink{def:cfn}{CF expansions} are computable and have nice properties.
\begin{eg}
    \begin{align*}
        \theta &= \sqrt{6} = 2 + (\sqrt{6} - 2) & a_0&=2 \\
        \theta_1 &= \frac{1}{\sqrt{6}-2} = \frac{\sqrt{6} + 2}{2} = 2 + \frac{\sqrt{6}-2}{2} & a_1&=2\\
        \theta_2 &= \frac{2}{\sqrt{6}-2} = \sqrt{6}+2 = 4 + (\sqrt{6} - 2) & a_2&=4 \\
        \theta_3 &= \frac{1}{\sqrt{6}-2} = \theta_1 \implies a_3 = 2 = a_1 = a_5 = a_7 = \dotsb&& \\
                 & \qquad \implies \theta_4 = \theta_2 \text{ so } a_4 = 4 = a_2 = a_6 = \dotsb
    \end{align*}
    so $\theta = [2, 2, 4, 2, 4, 2, 4, 2, 4, 2, 4, \dotsc] = [2, \overline{2, 4}]$.
\end{eg}

\begin{defi}[Eventually periodic]\hypertarget{def:period}
    The \hyperlink{def:cfn}{CF} $[a_0, a_1, \dotsc, a_{m-1}, \overline{a_m, \dotsc, a_{m-k+1}}]$ is \textbf{eventually periodic}.
    The least $k$ for which this holds is the period of the continued fraction.
    It is \textbf{purely periodic} if $m=0$, i.e. $\theta = [\overline{a_0, \dotsc, a_{k-1}}]$.
\end{defi}

\begin{defi}[Quadratic irrational]\hypertarget{def:qi}
    $\theta$ is called a \textbf{quadratic irrational} if
    $\theta = r + s \sqrt{d}$, $r, s \in \Q$, $s \neq 0$, $d > 1$, non-square integer.
    Equivalently, $a \theta^2 + b \theta + c = 0$ for $a, b, c \in \Z$.
\end{defi}
% Lecture 20
\begin{nthm}[Lagrange]\label{thm:6.7}
    The \hyperlink{def:cfn}{CF expansion} of $\theta \in \R \setminus \Q$ is \hyperlink{def:period}{eventually periodic} $\iff \theta$ is a \hyperlink{def:qi}{quadratic irrational}.
\end{nthm}

\begin{proof}
    ($\Rightarrow$). If $\phi = \hyperlink{def:cfn}{[\overline{a_0, \dotsc, a_{n-1}}]}$ is \hyperlink{def:period}{purely periodic}, then
    \begin{equation*}
        \phi = [a_0, \dotsc, a_{n-1}, \phi] = \frac{\hyperlink{def:convs}{p_{n-1}} \phi + p_{n-2}}{q_{n-1} \phi + q_{n-2}} \implies \phi \text{ satisfies a quadratic equation}.
    \end{equation*}
    If $\theta = [a_1, \dotsc, a_{n-1}, \overline{a_n, \dotsc, a_{n+d-1}}]$ is \hyperlink{def:period}{eventually periodic},
    \begin{equation*}
        \theta = \frac{p_{n-1} \theta_n + p_{n-2}}{q_{n-1} \theta_n + q_{n-2}} \text{ where } \theta_n = [\overline{a_n, \dotsc, a_{n+d-1}}] = r + s \sqrt{D}
    \end{equation*}
    by the argument above.
    So,
    \begin{align*}
        \theta = \frac{p_{n-1} r + p_{n-2} + p_{n-1} s \sqrt{D}}{q_{n-1} r + q_{n-2} + q_{n-1} \sqrt{D}} &= \frac{A + B \sqrt{D}}{A' + B' \sqrt{D}} \\
                                                                                                         &= \frac{(A + B \sqrt{D})(A' - B' \sqrt{D})}{A'^2 - B'^2 D}.
    \end{align*}

    ($\Leftarrow$) Suppose $a \theta^2 + b \theta + c= 0$ for $a, b, c \in \Z$, $a > 0$.
    Let $f(x, y) = a x^2 + b x y + c y^2$ (The \hyperlink{def:bqf}{BQF} is \hyperlink{def:definite}{indefinite} as $\theta$ real).
    \begin{gather*}
        \theta = \frac{p_n \theta_{n+1} + p_{n-1}}{q_n \theta_{n+1} + q_{n-1}} \implies f_n(\theta_{n+1}, 1) = 0 \text{ where} \\
        f_n(x, y) = f(p_n x + p_{n-1} y, q_n x + q_{n-1} y) = A_n x^2 + B_n x y + C_n y^2 \\
        \shortintertext{with}
        A_n = f_n(1, 0) = f(p_n, q_n) = f_{n+1}(0, 1) = C_{n+1} \\
        \text{and } \hyperlink{def:disc}{\disc}(f_n) = \disc(f) \text{ as } \begin{vmatrix} p_n & p_{n-1} \\ q_n & q_{n-1} \end{vmatrix} = \pm 1
    \end{gather*}

    \textbf{Claim:} $\exists$ constant $K$ such that $\abs{A_n} \leq K \ \forall n$.
    Suppose so: then $\abs{C_n} = \abs{A_{n-1}} \leq K$ and $B_n^2 - 4 A_n C_n = \disc(f)$.
    As $A_n, B_n, C_n \in \Z$, there are only finitely many possibilities for $f_n$. Hence, for some $n, k > 0$, $\theta_{n+k} = \theta_n$.

    Proof of claim: Let $\theta'$ be the other root of $a \theta^2 + b \theta + c=0$. Then
    \begin{equation*}
        \abs{f\left(\frac{p_n}{q_n}, 1\right)} = a \underbrace{\abs{\frac{p_n}{q_n}-\theta}}_{\leq \frac{1}{q_n^2}} \cdot \underbrace{\abs{\frac{p_n}{q_n}-\theta'}}_{\to \theta - \theta'} \text{ since } f(x, 1) = (x - \theta)(x - \theta')
    \end{equation*}
    So $\abs{f(\frac{p_n}{q_n}, 1)} \leq \frac{K}{q_n^2} \quad \forall n$, for some $K$, so $\abs{A_n} = \abs{f(p_n, q_n)} \leq K$.
\end{proof}

\begin{remark}
    This doesn't tell us what the \hyperlink{def:period}{period} of the \hyperlink{def:cfa}{continued fraction} is. $\sqrt{6} = [2, \overline{2, 4}]$.
    $\sqrt{889} = [29, \overline{1, 4, 2, 3, \dotsc, 1, 58}]$, length 42.
\end{remark}

\begin{nthm}[Galois]\label{thm:6.8}
    Let $\theta$ be a \hyperlink{def:qi}{quadratic irrational}.
    Then the \hyperlink{def:cfa}{continued fraction} for $\theta$ is \hyperlink{def:period}{purely periodic}, iff $\theta > 1$ and $-1 < \theta' < 1$ where $\theta'$ is the other root of the quadratic.
    If so, then $-\frac{1}{\theta'} = [\overline{a_{n-1}, \dotsc, a_0}]$.
\end{nthm}
\begin{proof}
    Omitted in this course.
\end{proof}

\begin{remark}
    Let $\theta = \sqrt{d}$, for $d > 1$ not a square. Then $\theta_1 = \frac{1}{\sqrt{d} - a_0} > 1$ and $\theta_1' = \frac{1}{-\sqrt{d}-a_0} \in (-1, 0)$.
    Hence $\theta_1$ has a purely periodic CF, and $\sqrt{d} = [a_0, \overline{a_1, \dotsc, a_n}]$.
\end{remark}

\begin{nthm}\label{thm:6.9}
    Let $d$ be a positive integer, not a square. Then Pell's equation
    \begin{equation*}
        x^2 - d y^2 = 1 \tag{$*$} \label{eq:pell}
    \end{equation*}
    has a solution in integers $x, y \neq 0$ (in fact has infinitely many).
\end{nthm}

\begin{proof}
    \begin{gather*}
        \theta = \sqrt{d} = [a_0, \overline{a_1, \dotsc, a_n}] = [a_0, a_1, \dotsc, a_n, \theta_{n+1}]\\ \text{ with } \theta_{n+1} = \theta_1 = [\overline{a_1, \dotsc, a_n}] = \frac{1}{\sqrt{d} - a_0} \\
        \implies \sqrt{d} = \frac{\theta_1 p_n + p_{n-1}}{\theta_1 q_n + q_{n-1}} = \frac{p_n + p_{n-1} (\sqrt{d} - a_0)}{q_n + q_{n-1} (\sqrt{d} - a_0)}
    \end{gather*}
    Multiply and equate coefficients of $1, \sqrt{d}$:
    \begin{align*}
        p_{n-1} &= q_n - q_{n-1} a_0 \\
        d \cdot q_{n-1} &= p_n - p_{n-1} a_0 \\
        \implies p_{n-1}^2 - d q_{n-1}^2 &= p_{n-1} q_n - p_n q_{n-1} = (-1)^n
    \end{align*}
    So if $n$ is even, $(x, y) = (p_{n-1}, q_{n-1})$ is a solution of \eqref{eq:pell}.
    Otherwise, use $[a_0, \overline{a_1, \dotsc, a_{2n}}]$ to get that $p_{2n-1}, q_{2n-1})$ is a solution.
    More generally, $(p_{kn-1}, q_{kn-1})$ is a solution $\forall k$ such that $kn$ is even, so there are infinitely many solutions.
\end{proof}

\begin{remark}
    We can also show (using the fact that $\hyperlink{def:convs}{\frac{p_n}{q_n}}$ are better approximations to $\theta$ than other rationals) that any solution $(x, y)$ when $x, y > 0$ is $(p_n, q_n)$ for some $n$.
\end{remark}

\begin{remark}
    If $x_1^2 - d y_1^2 = 1 = x_2^2 - d y_2^2$ then $X^2 - d Y^2 = 1$ where
    \begin{equation*}
        X + Y \sqrt{d} = (x_1 + y_1 \sqrt{d})(x_2 + y_2 \sqrt{d})
    \end{equation*}
    This shows that the solutions of \eqref{eq:pell} form a group under this operation. (See Number Fields `units in quadratic fields'.)
\end{remark}

% Lecture 21
\clearpage
\section{Primality testing and factorisation}
RSA relies on two properties:
\begin{enumerate}
    \item if $N=pq$, where $p, q$ are primes around $2^{500}$, knowing $N$ alone it is very hard to recover $p, q$.
    \item there are easy to find large primes
\end{enumerate}

To find a large prime, test numbers in a range for primality.
By the \hyperlink{thm:pnt}{prime number theorem}, testing numbers of size $M$ gives success after about $\log M$ tries.
It would be useful to find some easy to check property which only holds for primes.

Recall \hyperlink{thm:fermatLittle}{Fermat's Little Theorem}:
\begin{thm}[Fermat's Little Theorem]
    If $p$ is prime and $(a, p)=1$, then $a^{p-1} \equiv 1 \pmod{p}$.
\end{thm}

\begin{eg}\leavevmode
    \begin{enumerate}[label={}]
        \item For $N=15$, $2^{14} = (2^4)^3 \cdot 2^2 = 16^3 \cdot 4 \equiv 4 \pmod{15} \not\equiv 1 \pmod{15}$. So, 15 is not prime.
        \item For $N=91$, $3^{90} \equiv 1 \pmod{91}$, which gives no information. $2^{90} \equiv 64 \pmod{91}$, so 91 is not prime.
    \end{enumerate}
\end{eg}

So we often have to use more than one value of $a$ to get a good test.
How many different $a$ do we need to check $a^{N-1} \equiv 1 \pmod{N}$ to be sure $N$ is prime?
Or, if $N$ is composite, how many $a$'s do we need to try to detect this?

\begin{defi}[Pseudoprime]\hypertarget{def:pseudo}
    Take $N$ an odd, composite integer mod $b \geq 1$, $(b, N) = 1$.
    Say $N$ is a (Fermat) \textbf{pseudoprime} to the base $b$ if $b^{N-1} \equiv 1 \pmod{N}$.
    (This depends only on $b \bmod{N}$, so generally restrict to $1 \leq b < N$.)
\end{defi}

\begin{eg}
    91 is a Fermat \hyperlink{def:pseudo}{pseudoprime} base 3.
\end{eg}

Notice if $N$ is a \hyperlink{def:pseudo}{pseudoprime} to base $b_1$ and to base $b_2$, as $(b_1 b_2)^{N-1} = b_1^{N-1} b_2^{N-1}$, it is a pseudoprime to base $b_1 b_2$.
Obviously every composite $N$ is a pseudoprime to base $1$.
So $\{1 \leq b < N, (b, N) = 1 \text{ s.t. $N$ is a pseudoprime to base } b\}$ is a subgroup of the group $(\Z/n\Z)^\times$ of residue classes coprime to $N$ under multiplication.

\begin{nprop}\label{prop:7.1}
    Take $N>1$, odd composite.
    If $N$ is not a pseudoprime to some base, then for at least $\frac{1}{2}$ of $\set{1 \leq b < N | (b, N)}$ it is not a pseudoprime to base $b$.
\end{nprop}
\begin{proof}
    \begin{equation*}
        H = \set{b | N \text{ is a pseudoprime to base } b}
    \end{equation*}
    is a subgroup of $(\Z/n\Z)^\times$. By hypothesis, it is a proper subgroup (as $\exists b \notin H$).
    By Lagrange, the order of $H$ divides $\hyperlink{def:phi}{\varphi}(N) = \# (\Z/N\Z)^\times$, so $\#H \leq \frac{1}{2} \varphi(N)$, so $\#\{b \notin H\} \geq \frac{1}{2} \varphi(N)$.
\end{proof}

This is encouraging: if $N$ is composite and it is not a pseudoprime to some base, then this can be detected by testing a small number of bases, with high probability.
Unfortunately, there exist composite integers which are pseudoprimes to every base.

\begin{defi}[Carmichael number]\hypertarget{def:carm}
    A composite odd $N>1$ is a \textbf{Carmichael number} if it is a Fermat \hyperlink{def:pseudo}{pseudoprime} to every base $b$, $(b,N)=1$.
\end{defi}

\begin{fact}
    There are infinitely many such numbers (hard theorem). See the example sheet for some properties.
\end{fact}

So, we would like to search for stronger tests.
\begin{equation*}
    a^{p-1} \equiv 1 \pmod{p} \text{ so } a^{\frac{p-1}{2}} \equiv \pm 1 \pmod{p}
\end{equation*}
In fact, $\equiv \legendre{a}{p}$.
So, if $p$ is prime, the only square roots of 1 mod $p$ are $\pm 1$.

If $N$ composite, say $N = \prod_{i=1}^k p_i^{e_i}$, product of $k$ distinct prime powers, there are $2^k$ square roots of $1 \pmod{N}$ for $N$ odd by the \hyperlink{thm:crt}{Chinese remainder theorem}, as
\begin{equation*}
    x^2 \equiv 1 \pmod{N} \iff
    \begin{cases}
        x^2 \equiv 1 \pmod{p_1^{e_1}} \\
        \vdots \\
        x^2 \equiv 1 \pmod{p_k^{e_k}}
    \end{cases}
\end{equation*}
and each of these congruences has 2 solutions.

\begin{defi}[Euler pseudoprime]\hypertarget{def:ePseudo}
    $N$ (an odd composite) is an \textbf{Euler pseudoprime} to the base $b$ if
    \begin{equation*}
        b^{\frac{N-1}{2}} \equiv \hyperlink{def:legendre}{\legendre{b}{N}} \pmod{N} \tag{$*$} \label{eq:21star}
    \end{equation*}
\end{defi}

Squaring \eqref{eq:21star} gives that every \hyperlink{def:ePseudo}{Euler pseudoprime} to base $b$ is also a \hyperlink{def:pseudo}{Fermat pseudoprime} (to some base $b$).
Also if $N$ is an Euler pseudoprime to bases $b_1$ and $b_2$, then it is also one to base $b_1 b_2$ as
\begin{equation*}
    (b_1 b_2)^{\frac{N-1}{2}} = b_1^{\frac{N-1}{2}} b_2^{\frac{N-1}{2}} \text{ and } \legendre{b_1 b_2}{N} = \legendre{b_1}{N} \legendre{b_2}{N}.
\end{equation*}
So just as for Fermat pseudoprimes:

\begin{nprop}\label{prop:7.2}
    If $N$ is not an \hyperlink{def:ePseudo}{Euler pseudoprime} to some base $b$, then it isn't an Euler pseudoprime to at least $\frac{1}{2}$ of the possible bases.
\end{nprop}

\begin{proof}
    Same as in \cref{prop:7.1}
\end{proof}
\hyperlink{def:ePseudo}{Euler pseudoprimes} are better than \hyperlink{def:pseudo}{Fermat ones}, because
\begin{nthm}\label{thm:7.3}
    If $N$ is odd, composite, then there is a base $b$ to which $N$ is not an \hyperlink{def:pseudo}{Euler pseudoprime} (i.e.\ there is no analogue of \hyperlink{def:carm}{Carmichael numbers} for \hyperlink{def:ePseudo}{Euler pseudoprimes}).
\end{nthm}

This gives a `probabilistic' primality test, the Solovay-Strassen probability test:
Given $N>1$ odd,
\begin{itemize}
    \item Pick $b > 1$ at random. Check $(b, N) = 1$ (if not, $N$ is composite).
    \item Check whether $b^{\frac{N-1}{2}} \equiv \legendre{b}{N} \pmod{N}$
        (LHS: write $N-1$ in binary, use \hyperlink{def:repSquare}{repeated squaring}, RHS: use \hyperlink{thm:qrj}{quadratic reciprocity} law), takes \hyperlink{def:poly}{polynomial time}.
    \item If not, then $N$ is certainly composite.
    \item Otherwise, $N$ is composite with probability $\leq \frac{1}{2}$ (by \cref{prop:7.2} and \cref{thm:7.3}).
    \item Repeat for more $b$'s, after $t$ tries, $N$ is prime with probability $1 - \frac{1}{2^t}$.
\end{itemize}

% Lecture 22
\begin{proof}[Proof of \cref{thm:7.3}]
    There are 2 cases:
    \begin{enumerate}[label=\alph*.]
        \item \textbf{$N$ squarefree}, so $N = pm$, $p$ prime, $p \nmid m$, $m \geq 3$.
            Pick $u \in \Z$ such that $\legendre{u}{p} = -1$.
            Then by the \hyperlink{thm:crt}{Chinese Remainder Theorem}, $\exists b \in \mathbb{Z}$ with $b > 1$ and
            \begin{align*}
                b &\equiv u \pmod{p} \\
                b &\equiv 1 \pmod{m} \\
                \shortintertext{so}
                \hyperlink{def:jacobi}{\legendre{b}{N}} &= \legendre{b}{m} \hyperlink{def:legendre}{\legendre{b}{p}} = -1.
            \end{align*}
            But $b \equiv 1 \pmod{m} \implies b^{\frac{N-1}{2}} \equiv 1 \not\equiv -1 \pmod{m} \implies b^{\frac{N-1}{2}} \not\equiv -1 \pmod{N}$, so $b^{\frac{N-1}{2}} \not\equiv \legendre{b}{N}$, so $N$ is not an \hyperlink{def:ePseudo}{Euler pseudoprime} to base $b$.
        \item In the other case, some prime $p$ has $p^2 \mid N$.
            By \hyperlink{thm:crt}{Chinese Remainder Theorem}, $\exists b \in \Z$ with $b \equiv 1 + p \pmod{p^2}$ and $(b, N) = 1$.
            \begin{align*}
                \implies b^{N-1} &\equiv (1+p)^{N-1} \pmod{p^2} \\
                                 &\equiv 1 + p(N-1) \pmod{p^2} \\
                                 &\equiv 1 - p \pmod{p^2} \\
                                 &\not\equiv 1 \pmod{p^2}
            \end{align*}
            So $b^{\frac{N-1}{2}} \not \equiv \pm 1 \pmod{N}$. \qedhere
    \end{enumerate}
\end{proof}

Carry this further. If $p$ prime, $(a, p) = 1$, $a^{\frac{p-1}{2}} \equiv \pm 1 \pmod{p}$.
If $a^{\frac{p-1}{2}} \equiv +1 \pmod{p}$ and $4 \mid p-1$, then $a^{\frac{p-1}{4}} \equiv \pm 1 \pmod{p}$ and so on.
This suggests:
\begin{defi}[Strong test]\hypertarget{def:strongTest}
    Let $N > 1$ be odd, and let $N - 1 = 2^s t$, $s \geq 1$, $t$ odd.
    Say $N$ passes the \textbf{strong test} to base $b$ for $(b, N) = 1$ if either $b^t \equiv 1 \pmod{N}$ or $b^{2^r t} \equiv -1 \pmod{N}$ for some $0 \leq r < s$.
\end{defi}

By previous discussion, $N$ prime $\implies N$ passes the \hyperlink{def:strongTest}{strong test} (to every base).
\hypertarget{def:sPseudo}Say that $N$ is a \textbf{strong pseudoprime} to base $b$ if it is composite and passes the strong test (to base $b$).

\begin{eg}
    Take $N = 65$, $b = 8$. $N - 1 = 64 = 2^6$, so $s = 6$ and $t=1$.

    $8^1 \not\equiv 1 \pmod{N}$ but $8^2 = 64 = -1 \pmod{N}$, so $N$ is a strong pseudoprime to base $8$.
    For $b=2$, $2^1 \not\equiv 1 \pmod{N}$, and none of $2^2, 2^4, 2^8, 2^{16}, 2^{32}$ are $-1 \pmod{65}$, so $N$ fails the \hyperlink{def:strongTest}{strong test} to this base, hence is composite.
\end{eg}

\begin{nthm}\label{thm:7.4}
    If $N$ is a \hyperlink{def:sPseudo}{strong pseudoprime} to base $b$, then it is an \hyperlink{def:ePseudo}{Euler} (hence also \hyperlink{def:pseudo}{Fermat}) pseudoprime to base $b$.
\end{nthm}
\begin{nthm}\label{thm:7.5}
    If $N$ composite, then it passes the \hyperlink{def:strongTest}{strong test} for at most $\frac{1}{4} \hyperlink{def:phi}{\varphi(N)}$ bases $b \in \{1, \dotsc, N-1\}$, $(b, N) = 1$.
\end{nthm}
\begin{proof}
    Omitted in this course. See book by Koblitz.
\end{proof}

Use this as a (probabilistic) primality test (Miller-Rabin test):
\begin{itemize}
    \item Choose a random base $b$, $(b, N) = 1$. If $N$ fails the \hyperlink{def:strongTest}{strong test} to base $b$, then it is composite.
    \item Otherwise, the probability that it is composite is $\leq \frac{1}{4}$.
    \item Repeat for a total of $k$ bases.
\end{itemize}
If $N$ passes the strong test for all the bases, then it will be prime with probability $1 - \frac{1}{4^k}$.
Hypothetically, can make this deterministic:

\begin{nthm}
    If the Generalised Riemann Hypothesis holds, then any composite $N$ fails the \hyperlink{def:strongTest}{strong test} for some base $b < 2 (\log N)^2$, giving a \hyperlink{def:poly}{polynomial time} primality test.
\end{nthm}

In 2002, Agrawal-Kayal-Saxeno discovered a polynomial-time deterministic algorithm which doesn't depend on GRH (or any other unproved assumption).
Unfortunately, it's slow for numbers of interest, and takes $\sim (\log N)^{6 + \epsilon}$.
Upshot: primality testing can be done quickly.

\subsection{Factorisation}
Factorisation is another story!
Take $N$ an odd composite integer. We'd like an algorithm to find a nontrivial factor of $N$.

\hypertarget{def:trialDiv}The simplest method is `trial division': check divisibility of $N$ by $3,5,7,\dotsc$.
If $N=pq$, $p,q \approx N^\frac{1}{2}$, this will take $\approx N^\frac{1}{2}$ steps (but this is good if $N$ happens to have a small factor).

\subsubsection*{Fermat factorisation}
Suppose $N=ab$, $\abs{a-b}$ small. Fermat observed:
\begin{equation*}
    N = ab = \left(\frac{a+b}{2}\right)^2 - \left(\frac{a-b}{2}\right)^2
\end{equation*}
as $a,b$ are both odd. That is, $N+y^2 = x^2$, $x \geq \sqrt{N}$.
\hypertarget{def:fermat}So try $x = \floor{\sqrt{N}} + 1, \floor{\sqrt{N}} + 2, \dotsc$ and see if $x^2 - N$ is a square, say $y^2$.
If so, $N=(x+y)(x-y)$ gives a factor of $N$.

\begin{eg}
    Take $N=200819$,
    \begin{align*}
        \floor*{\sqrt{200819}} &= 448 \\
        449^2 - N &= 782 \text{ not a square} \\
        450^2 - N &= 1681 = 41^2
    \end{align*}
    So $N = 450^2 -41^2 = 491 \times 409$.
\end{eg}
We could have tested $N+y^2$ for squareness, $y = 1,2,\dotsc$, but that would have taken $41$ steps.

How many steps does this algorithm take? $x = \floor{\sqrt{N}} + t$ will take $t$ steps to get to.
\begin{gather*}
    N = ab = (x+y)(x-y) \text{ with } x = \frac{a+b}{2} = \floor{\sqrt{N}} +t.\\
    \text{So, } t \approx \frac{a+b}{2} - \sqrt{ab} = \frac{(\sqrt{a} - \sqrt{b})^2}{2} \text{ running time.} \\
\end{gather*}
If $N = pq, p \approx 10^k, q \approx 2 \times 10^k$, then
\begin{equation*}
    \frac{(\sqrt{q}-\sqrt{p})^2}{2} \approx \frac{(\sqrt{2}-1)^2 \cdot 10^4}{2} \approx 0.8 \times 10^{k-1}
\end{equation*}
Better than \hyperlink{def:trialDiv}{trial division} $(10^k)$ but not by much.

% Lecture 23
\begin{nprop}\label{prop:7.7}
    Suppose $x^2 \equiv y^2 \pmod{N}$ and $x \not\equiv \pm y \pmod{N}$.
    Then the GCDs $(N, x+y)$ and $(N, x-y)$ are both proper divisors of $N$.
\end{nprop}

\begin{proof}
    We treat the case of $x+y$. $(N, x+y) \mid N$ by definition.
    If $(N, x+y) = N$ then $x \equiv -y \pmod{N}$, a contradiction.
    If $(N, x+y) = 1$ then $(x+y)(x-y) \equiv 0 \pmod{N}$, hence $x-y \equiv 0 \pmod{N}$, i.e. $x \equiv y \pmod{N}$, a contradiction.
\end{proof}

Finding squares which are congruent mod $N$ is difficult.
Instead try to find many integers $x_i$ such that $x_i^2 \equiv c_i \pmod{N}$, where $c_i$ is divisible only by small powers.
Then hope to multiply some $x_i$ together to get a solution to $x^2 \equiv y^2 \pmod{N}$.

\begin{nlemma}\label{lem:7.8}
    Let $p_1, \dotsc, p_r$ be distinct primes and let $c_1, \dotsc, c_k$ be non-zero integers (divisible only by these $p_i$).
    Then if $k > r+1$ there exists a non-empty subset $I \subset \{1, \dotsc, k\}$ such that $\prod_{i \in I} c_i$ is a square.
\end{nlemma}

\begin{proof}
    For any $J \subseteq \{1, \dotsc, k\}$ write $c_J = \prod_{i \in J} c_i$ and
    \begin{equation*}
        c_J = (-1)^{\alpha_{J, 0}} p_1^{\alpha_{J, 1}} \dotsm p_r^{\alpha_{J, r}} m_J^2 \text{ where }
        \begin{cases}
            m_J \geq 1 \\ \alpha_{J, i} \in \{0, 1\}
        \end{cases}
    \end{equation*}
    That is, split $c_J$ into squarefree and squared parts.
    Observe $c_J$ is a square iff $\alpha_{J, i} = 0 \ \forall i = 0, \dotsc, r$.

    By the pigeonhole principle, since $k > r+1$, there exist distinct subsets $J, K \subseteq \{1, \dotsc, k\}$ such that $\alpha_{J, i} = \alpha_{K, i}$ for each $i = 0, \dotsc, r$.
    It follows that $c_J c_K$ is a square.
    We also have $c_{J \cap K} \mid c_J$, $c_{J \cap K} \mid c_K$, hence $c_{J \cap K}^2 \mid c_J c_K$.
    Hence $\frac{c_J c_K}{c_{J \cap K}^2}$ is a square integer, and equals $c_{J \setminus (J \cap K)} c_{K \setminus (J \cap K)} = c_{J \triangle K}$.
\end{proof}

\begin{defi}[Factor base]\hypertarget{def:factorBase}
    A \textbf{factor base} is a set $B = \{-1, p_1, \dotsc, p_r\}$ where the $p_i$ are primes.
    A \textbf{$B$-number} is a positive integer $x$ such that all prime factors of $\langle x^2 \rangle$ lie in $B$.

    If $a \in \Z$, then $\langle a \rangle$ is the unique integer in $(-\frac{N}{2}, \frac{N}{2}]$ such that $\langle a \rangle \equiv a \pmod{N}$.
\end{defi}

Here is the `factor base method' to factor $N$:
\begin{enumerate}
    \item Choose a factor base $B$
    \item Generate some $B$-numbers $x_1, \dotsc, x_k$.
    \item Find a non-empty subset $I \subseteq \{1, \dotsc, k\}$ such that $\prod_{i \in I} \langle x_i^2 \rangle = y^2$ is a square.
    \item Then if $x = \prod_{i \in I} x_i$, then $x^2 \equiv y^2 \pmod{N}$.
        If $x \equiv \pm y \pmod{N}$ then \cref{prop:7.7} implies we have found a factor of $N$.
        Otherwise, find more $B$-numbers and try again.
\end{enumerate}

How likely is this to work? If $N = \prod_{i =1}^t p_i^{e_i}$ with $e_i \geq 1$ and $p_1, \dotsc, p_t$ distinct primes, then the congruence
$x^2 \equiv 1 \pmod{p_i^{e_i}}$ has exactly 2 solutions (if $p_i \equiv 2$).
By the \hyperlink{thm:crt}{Chinese Remainder Theorem}, the congruence $x^2 \equiv 1 \pmod{N}$ has $2^t$ solutions.
Only two if there are $\pm 1$.
If we apply the factor base method to obtain $x^2 \equiv y^2 \pmod{N}$ then $\left(\frac{x}{y}\right)^2 \equiv 1 \pmod{N}$.
As long as $\frac{x}{y}$ is one of the $2^t - 2$ solutions other than $\pm 1$ to $t^2 \equiv 1 \pmod{N}$, we have found a factor of $N$.

\textbf{Heuristic}: We succeed with probability $1-\frac{1}{2^{t-1}}$.
If $t \geq 2$, we expect this method to eventually factor $N$.

How do we generate \hyperlink{def:factorBase}{$B$-numbers,} as required by step 2?
First guess: try $x_i = \floor{\sqrt{kN}}$ or $\floor{\sqrt{kN}} + 1$, $k \geq 1$ a small integer.

Then $x_i^2$ should be close to a multiple of $N$, hence \hyperlink{def:factorBase}{$\langle x_i^2 \rangle$} should be divisible only by small primes.
In practice, generate the $x_i$ first and then choose the factor base $B$.

\begin{eg}[Worked example]
    $N=1829$. Choose factor base
    \begin{equation*}B = \{-1, 2, 3, 5, 7, 11, 13, 17, 19\}\end{equation*}
    \def\arraystretch{1.5}
    \begin{center}
        \begin{tabular}{c|c|c|c|c|c|c|c}
            $x_i$ & 42 & 43 & 60 & 61 & 74 & 75 & 85 \\
            \hline
            $\langle x_i^2 \rangle$ & $-65$ & 20 & $-58$ & 63 & $-11$ & 138 & $-91$ \\
            \hline
            \multirow{2}{*}{$B$-number?} & $-5\cdot13$ & $2^2 \cdot 5$ & $-2\cdot29$ & $3^2 \cdot 7$ & $-11$ & $2 \cdot 3 \cdot 23$ & $-7 \cdot 13$ \\
                                         & \cmark      & \cmark & \xmark & \cmark & \cmark & \xmark & \cmark
        \end{tabular}
    \end{center}

    Next step: choose some $x_i$ with the property that $\prod \langle x_i^2 \rangle$ is square.
    By inspection,
    \begin{align*}
        (42 \cdot 43 \cdot 61 \cdot 85)^2 &\equiv (-65 \cdot 20 \cdot 63 \cdot -91) \pmod{N} \\
                                          &\equiv (2 \cdot 3 \cdot 5 \cdot 7 \cdot 13)^2 \pmod{N} \\
                          \implies 1459^2 &\equiv 901^2 \pmod{N}
    \end{align*}
    We find $(1829, 558)=31$, $(1829, 2360) = 59$. In this case, $N=31 \times 59$.
\end{eg}
\begin{remark}
    In general, it need not be the case that $N = (N, x+y)(N, x-y)$.
\end{remark}

Computational result: In step 2, we chose $B$ to contain small primes and check whether $x_i$ is a \hyperlink{def:factorBase}{$B$-number} using trial division or using Euclid's algorithm on $\prod_{p_i \in B} p_i$.
There is a better way to find $B$-numbers:
\begin{nlemma}\label{lem:7.9}
    Let $\frac{p_n}{q_n}$ be a \hyperlink{def:convs}{convergent} in the CF expansion of $\sqrt{N}$.
    Then $\abs{p_n^2 - N q_n^2} \leq 2 \sqrt{N}$.
\end{nlemma}

\begin{proof}
    \begin{align*}
        \abs{p_n^2 - N q_n^2} &= q_n^2 \abs{\sqrt{N} - \frac{p_n}{q_n}}\abs{\sqrt{N} + \frac{p_n}{q_n}}  \\
                              &< q_n^2 \times \left(\frac{1}{q_n q_{n+1}}\right) \left(2 \sqrt{N} + \frac{1}{q_n q_{n+1}}\right) \text{ by \cref{thm:6.4}} \\
                              &= \frac{1}{q_{n+1}} \left(2 q_n \sqrt{N} + \frac{1}{q_{n+1}}\right) \\
                              &< \frac{1}{q_{n+1}} (2 q_n + 1) \sqrt{N} \leq 2 \sqrt{N} \text{ as } q_{n+1} > q_n. \qedhere
    \end{align*}
\end{proof}

\begin{remark}\leavevmode
    \begin{enumerate}[label=(\roman*)]
        \item So $\langle p_n^2 \rangle \leq 2 \sqrt{N}$, so $p_n$ has a good chance of being a $B$-number.
        \item Continued fraction factoring method will then work by trying convergents to see if $p_n$ is a $B$-number.
            Only need to know $p_n$ and $N$, so can compute this by $p_{n+1} = a_{n+1} p_n + p_{n-1}$ working mod $N$.
    \end{enumerate}
\end{remark}

\begin{eg}
    Take $N=12403$, and $\sqrt{N} = [111, \overline{2, 1, 2, 2, 7, 1, \dotsc}]$, with period 16.
    \def\arraystretch{1.5}
    \begin{center}
        \begin{tabular}{c|ccccccc}
            $p_n \pmod{N}$ & 111 & 223 & 334 & 891 & 2116 & 3309 & 5416 \\
            \hline
            $\langle p_n^2 \rangle$ & $-82$ & 117 & $-71$ & 89 & $-27$ & 166 & $-39$ \\
            factorisation & $-2\cdot41$ & $3^2 \cdot 13$ & $-71$ & $89$ & $-3^3$ & $2 \cdot 83$ & $-3 \cdot 13$ \\
                          &             & \cmark         &       &      & \cmark &              & \cmark
        \end{tabular}
    \end{center}
    \begin{align*}
        \implies (223 \times 2116 \times 5416)^2 &\equiv (3^3 \cdot 13)^2 \pmod{N} \\
        \implies 11341^2 &\equiv 351^2 \pmod{N}
    \end{align*}
    so we have factors $(N, 10990) = 157$ and $(N, 11692) = 79$.
\end{eg}
How quick is this?
We need to compute enough $p_n$s to find enough $B$-numbers, then (step 3 of the previous algorithm) find subsets of these such that
\begin{equation*}
    \prod_{i \in I} \langle x_i^2 \rangle = c_I = \prod c_i
\end{equation*}
is a square.
Writing down all products and using the pigeonhole principle (as in \cref{lem:7.8}) is \textit{much} too slow - there are $2^k$ numbers, where $k = |I|$.
Even if $k \approx \log N$ (which is in practice not enough), this is still $\approx N$.

A far better approach is to look for $k$-tuples $\gamma = (\gamma_1, \dotsc, \gamma_n)$ such that $\prod_{i=1}^k c_i^{\gamma_i}$ is a square.
If
\begin{equation*}
    c_i = (-1)^{a_{i, 0}} \prod_{j=1}^r p_j^{a_{ij}} \quad (p_j \in B)
\end{equation*}
this is equivalent to the congruence
\begin{equation*}
    \forall j=0,\dotsc,r \quad \sum_{i=1}^k \gamma_i \alpha_{ij} \equiv 0 \pmod{2}
\end{equation*}
i.e.\ solving the vector equation $\gamma \cdot \left(\alpha_{ij}\right) \equiv 0 \pmod{2}$.
This can be done with linear algebra (mod 2) by usual Gaussian elimination in $\sim k^3$ operations, and there are faster ways.
The final outcome is that this has an expected running time $C \cdot e^{2 \sqrt{\log n} \cdot \sqrt{\log \log n}}$.
This is asymptotically smaller than any $N^\epsilon$ for $\epsilon > 0$, but asymptotically bigger than any $(\log N)^A$ for $A > 0$.
\begin{remark}
    The `quadratic sieve' and `number field sieve' are better still, and they give $e^{\sqrt{\log N} \sqrt{\log \log N}}$ and $e^{b (\log N)^{\frac{1}{3}} (\log \log N)^{\frac{2}{3}}}$ respectively where $b = \left(\frac{64}{9}\right)^{\frac{1}{3}} \approx 1.92$.
\end{remark}

For `special numbers', we can do better:
\subsubsection*{Pollard's $(p-1)$-method}
Suppose $N = p N_0$, $(p, N_0) = 1$ and $p-1$ is a product of small primes.
Consider $a^{p-1} - 1 \pmod{N}$ for $(a, N) = 1$. Then $a^{p-1} - 1 \equiv 0 \pmod{p}$, and probably $\not\equiv 0 \pmod{N_0}$.
Of course, we don't know $p-1$ yet, so can't compute this immediately.

$p = \gcd(a^{p-1}-1, N)$, but $p-1$ is a product of small primes $\leq m$, say.
Then let $k = \operatorname{lcm}(1,\dotsc, m)$ (so divisible by all prime powers $q^r \leq m$).
\begin{itemize}[label=--]
    \item Choose random $a \geq 2$ with $(a,N) = 1$ (e.g.\ $a=2$)
    \item find $\gcd(a^k-1, N)$ and hope it is a factor of $N$.
\end{itemize}
If all prime powers dividing $p-1$ are $\leq m$, then $a^k \equiv 1 \pmod{p}$ as $p-1 \mid k$ and unless we are unlucky, $a^k \not\equiv 1 \pmod{N_0}$.
(We can compute $(a \mod N)^k$ by repeated squaring.)

\begin{eg}
    Take $N = 540143$. Try $k = \operatorname{lcm}(1,\dotsc,m) = 2^3 \cdot 3 \cdot 5 \cdot 7 = 840$.
    Try $a=2$. $2^k = 2^{105 \times 8} = (2^{64 + 32 + 8 + 1)})^8 \equiv 53047 \pmod{N}$ and $(540143, 53046) = 421 = p$.
    $N$ factors as $421 \times 1283$. $p-1 = 420 = 2^2 \cdot 3 \cdot 5 \cdot 7$.
\end{eg}

This has two variants:
\begin{enumerate}[label=(\arabic*)]
    \item $(p+1)$-method, i.e.\ hoping that $p+1$ is a product of small primes.
        This uses the field with $p^2$ elements, whose multiplicative group has order $p^2 - 1$.
    \item Elliptic curve method uses `elliptic curves' instead of finite fields.
        This has no special restrictions on $p$, and takes $\sim e^{b \sqrt{\log p} \sqrt{\log \log p}}$, so is better than general methods if $p$ is relatively small, e.g.\ $N \approx 2^{1000}$, $p \approx 2^{100}$.
\end{enumerate}

Finally Shor's algorithm, sometimes called `quantum factoring', will factor in polynomial time on a fully-functional quantum computer.
So far, the highest number it has factored is $21$.
\end{document}
